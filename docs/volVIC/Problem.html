<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>volVIC.Problem API documentation</title>
            <link rel="icon" href="../logo.png"/>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../volVIC.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;volVIC</a>

            <img src="../logo.png" class="logo" alt="project logo"/>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Problem">Problem</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Problem.__init__">Problem</a>
                        </li>
                        <li>
                                <a class="variable" href="#Problem.mesh">mesh</a>
                        </li>
                        <li>
                                <a class="variable" href="#Problem.image">image</a>
                        </li>
                        <li>
                                <a class="variable" href="#Problem.fg">fg</a>
                        </li>
                        <li>
                                <a class="variable" href="#Problem.bg">bg</a>
                        </li>
                        <li>
                                <a class="variable" href="#Problem.Rmat">Rmat</a>
                        </li>
                        <li>
                                <a class="variable" href="#Problem.tvec">tvec</a>
                        </li>
                        <li>
                                <a class="variable" href="#Problem.image_energies">image_energies</a>
                        </li>
                        <li>
                                <a class="variable" href="#Problem.constraints">constraints</a>
                        </li>
                        <li>
                                <a class="variable" href="#Problem.dirichlet">dirichlet</a>
                        </li>
                        <li>
                                <a class="variable" href="#Problem.membrane_K">membrane_K</a>
                        </li>
                        <li>
                                <a class="variable" href="#Problem.membrane_weight">membrane_weight</a>
                        </li>
                        <li>
                                <a class="variable" href="#Problem.initial_rho">initial_rho</a>
                        </li>
                        <li>
                                <a class="variable" href="#Problem.saved_data_0">saved_data_0</a>
                        </li>
                        <li>
                                <a class="function" href="#Problem.find_fg_bg">find_fg_bg</a>
                        </li>
                        <li>
                                <a class="function" href="#Problem.initialize_h_mesh_ICP">initialize_h_mesh_ICP</a>
                        </li>
                        <li>
                                <a class="function" href="#Problem.make_membrane_weight">make_membrane_weight</a>
                        </li>
                        <li>
                                <a class="function" href="#Problem.make_dirichlet">make_dirichlet</a>
                        </li>
                        <li>
                                <a class="function" href="#Problem.one_gauss_newton_iter">one_gauss_newton_iter</a>
                        </li>
                        <li>
                                <a class="function" href="#Problem.solve">solve</a>
                        </li>
                        <li>
                                <a class="function" href="#Problem.save_paraview">save_paraview</a>
                        </li>
                        <li>
                                <a class="function" href="#Problem.plot_results">plot_results</a>
                        </li>
                        <li>
                                <a class="function" href="#Problem.propagate_displacement_to_volume_mesh">propagate_displacement_to_volume_mesh</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../volVIC.html">volVIC</a><wbr>.Problem    </h1>

                
                        <input id="mod-Problem-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-Problem-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Callable</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sps</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pyvista</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pv</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">IGA_for_bsplyne.Dirichlet</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dirichlet</span><span class="p">,</span> <span class="n">DirichletConstraintHandler</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">volVIC.Mesh</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mesh</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">volVIC.marching_cubes</span><span class="w"> </span><span class="kn">import</span> <span class="n">marching_cubes</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">volVIC.C1_triplets</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_C1_eqs</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">volVIC.membrane_stiffness</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_membrane_stifness</span><span class="p">,</span> <span class="n">make_membrane_weight</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">volVIC.image_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_fg_bg</span><span class="p">,</span> <span class="n">find_sigma_hat</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">volVIC.virtual_image_correlation_energy</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>    <span class="n">VirtualImageCorrelationEnergyElem</span><span class="p">,</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>    <span class="n">make_image_energies</span><span class="p">,</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>    <span class="n">compute_distance_field</span><span class="p">,</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="p">)</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">volVIC.virtual_image</span><span class="w"> </span><span class="kn">import</span> <span class="n">g_slide</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">volVIC.solve</span><span class="w"> </span><span class="kn">import</span> <span class="n">iteration</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Problem</span><span class="p">:</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">    Virtual Image Correlation (VIC) problem definition and solver.</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">    This class encapsulates the full setup of a surface-based VIC problem:</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">    geometry, image model, regularization, constraints, and nonlinear solver.</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">    A typical workflow is:</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd">        1. Instantiate a Problem from a mesh and an image</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">        2. Call `solve` to estimate the displacement field</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">        3. Export results using `save_paraview` or propagate them to a volume mesh</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">    Attributes</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">    ----------</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">    mesh : Mesh</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">        Surface mesh used in the VIC problem.</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">    image : np.ndarray</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">        Image converted to floating-point format for computations.</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">    fg, bg : float</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">        Estimated or user-defined foreground and background gray levels.</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">    Rmat : np.ndarray</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">        Rotation matrix resulting from ICP initialization.</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">    tvec : np.ndarray</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">        Translation vector resulting from ICP initialization.</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">    image_energies : list[VirtualImageCorrelationEnergyElem]</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">        Image energy elements used to assemble the VIC objective.</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">    constraints : DirichletConstraintHandler</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd">        Handler storing linear equality constraints (e.g. CÂ¹ continuity).</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">    dirichlet : Dirichlet</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">        Dirichlet constraint object derived from the constraint handler.</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">    membrane_K : scipy.sparse.spmatrix</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">        Membrane stiffness matrix used for regularization.</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">    membrane_weight : float</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">        Weight associated with the membrane regularization term.</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="sd">    initial_rho : float</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">        Initial value of the distance scaling parameter.</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="sd">    saved_data_0 : list[dict[str, np.ndarray]]</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="sd">        Cached image energy data from the first iteration, used for</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="sd">        post-processing and visualization.</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>    <span class="n">mesh</span><span class="p">:</span> <span class="n">Mesh</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>    <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">]</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>    <span class="n">fg</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>    <span class="n">bg</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>    <span class="n">Rmat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>    <span class="n">tvec</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>    <span class="n">image_energies</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">VirtualImageCorrelationEnergyElem</span><span class="p">]</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>    <span class="n">constraints</span><span class="p">:</span> <span class="n">DirichletConstraintHandler</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>    <span class="n">dirichlet</span><span class="p">:</span> <span class="n">Dirichlet</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>    <span class="n">membrane_K</span><span class="p">:</span> <span class="n">sps</span><span class="o">.</span><span class="n">spmatrix</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>    <span class="n">membrane_weight</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>    <span class="n">initial_rho</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>    <span class="n">saved_data_0</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]]]</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>        <span class="n">mesh</span><span class="p">:</span> <span class="n">Mesh</span><span class="p">,</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>        <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">],</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        <span class="n">ICP_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="n">reversed_normals</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>        <span class="n">fg_bg</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>        <span class="n">fg_bg_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;otsu&quot;</span><span class="p">,</span> <span class="s2">&quot;interp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;otsu&quot;</span><span class="p">,</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="n">virtual_image</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>            <span class="p">[</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>                <span class="nb">float</span><span class="p">,</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>            <span class="p">],</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>            <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]],</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">g_slide</span><span class="p">,</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="n">h</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="n">width_dx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="n">surf_dx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>        <span class="n">alpha</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>        <span class="n">C1_mode</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>            <span class="kc">None</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">]</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>        <span class="n">membrane_weight</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>        <span class="n">initial_rho</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>        <span class="n">expected_mean_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="n">n_intg_membrane_weight_comput</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>    <span class="p">):</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="sd">        Initialize a Virtual Image Correlation (VIC) problem.</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">        This constructor performs the full problem setup, including:</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="sd">        - foreground/background gray-level estimation,</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="sd">        - optional rigid-body ICP alignment between mesh and image,</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a><span class="sd">        - construction of virtual image energies,</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="sd">        - assembly of CÂ¹ continuity constraints,</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="sd">        - assembly of membrane regularization,</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">        - estimation of the coresponding regularization weight,</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">        - initialization of all data structures required by the nonlinear solver.</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a><span class="sd">        After initialization, the problem is ready to be solved using</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a><span class="sd">        :meth:`solve`, which performs a GaussâNewton optimization to estimate</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a><span class="sd">        the displacement field and the distance scaling parameter.</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="sd">        The mesh coordinates are assumed to be expressed in image voxel units.</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="sd">        No unit conversion or rescaling is performed internally.</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="sd">        Parameters</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="sd">        ----------</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">        mesh : Mesh</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">            Surface mesh defining the geometry to be matched to the image.</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">            The mesh coordinates must be expressed in image voxel units.</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">            Any conversion from physical units (e.g. mm or m) to voxel coordinates</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="sd">            must be performed beforehand by the user.</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">            If `ICP_init=True`, a rigid-body alignment is performed, but this</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">            does not handle unit conversion or rescaling. ICP only corrects</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="sd">            for rotation and translation, assuming consistent units.</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a><span class="sd">        image : np.ndarray[np.uint16]</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a><span class="sd">            3D volumetric image (e.g. CT scan). The gray-level distribution is</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="sd">            assumed to be bimodal (background / foreground).</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a><span class="sd">        ICP_init : bool, optional</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a><span class="sd">            If `True` (default), a rigid-body ICP is performed to align the mesh</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a><span class="sd">            with the image prior to solving the VIC problem.</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="sd">            Disable only if the mesh is already well aligned.</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a><span class="sd">        reversed_normals : bool, optional</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a><span class="sd">            If `True`, swaps the foreground/background convention in the virtual</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a><span class="sd">            image model. Useful if the mesh normals are oriented inward instead</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a><span class="sd">            of outward. By default, `False`.</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a><span class="sd">        fg_bg : tuple[float, float] or None, optional</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a><span class="sd">            Tuple `(fg, bg)` specifying the foreground and background gray levels.</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a><span class="sd">            If `None` (default), these values are automatically estimated from the</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a><span class="sd">            image.</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a><span class="sd">        fg_bg_method : Literal[&quot;otsu&quot;, &quot;interp&quot;], optional</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a><span class="sd">            Method to compute the foreground and background gray levels. `&#39;otsu&#39;`</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a><span class="sd">            uses :func:`image_utils.otsu_threshold` to compute the gray levels based</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a><span class="sd">            on Otsu&#39;s method. `&#39;interp&#39;` uses :func:`image_utils.interp_fg_bg` to</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="sd">            compute the gray levels using interpolation of histogram peaks.</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a><span class="sd">            Default is `&#39;otsu&#39;`.</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a><span class="sd">        virtual_image : Callable, optional</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a><span class="sd">            Virtual image model mapping signed distance values to gray levels.</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="sd">            The default (`g_slide`) is suitable for sharp material/background</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="sd">            transitions. See :func:`virtual_image.g_slide` for the function</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a><span class="sd">            signature.</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a><span class="sd">        h : float or None, optional</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a><span class="sd">            Half-width of the search domain along surface normals.</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a><span class="sd">            If `None` (default), `h` is automatically estimated from the image</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a><span class="sd">            during initialization.</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a><span class="sd">        width_dx : float, optional</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a><span class="sd">            Integration step along the normal direction for image energies.</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="sd">        surf_dx : float, optional</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a><span class="sd">            Integration step along the surface for image energies.</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a><span class="sd">        alpha : float or tuple, optional</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a><span class="sd">            Tangential regularization weight used in the image energies.</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a><span class="sd">            A value of 0.0 (default) disables tangential smoothing.</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a><span class="sd">        C1_mode : {&quot;auto&quot;, &quot;none&quot;, &quot;all&quot;} or np.ndarray or None, optional</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a><span class="sd">            Definition of CÂ¹ continuity constraints between patches:</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a><span class="sd">                - &quot;auto&quot;: automatically selected constraints (recommended)</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a><span class="sd">                - &quot;none&quot;: no CÂ¹ constraints</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a><span class="sd">                - &quot;all&quot;: enforce CÂ¹ everywhere</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="sd">                - array: user-defined triplets of constrained control points</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a><span class="sd">        membrane_weight : float or None, optional</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a><span class="sd">            Weight of the membrane (elastic) regularization term.</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a><span class="sd">            If None (default), the weight is automatically calibrated.</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="sd">        initial_rho : float, optional</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a><span class="sd">            Initial value of the transition distance parameter used in the VIC model.</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a><span class="sd">        expected_mean_dist : float, optional</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a><span class="sd">            Expected mean distance (in image units) used for automatic membrane</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a><span class="sd">            weight calibration.</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a><span class="sd">        n_intg_membrane_weight_comput : int, optional</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a><span class="sd">            Number of integration points used to compute the membrane weight</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a><span class="sd">            when it is determined automatically.</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a><span class="sd">            If True, disables parallel execution (useful for debugging or</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="sd">            reproducibility).</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a><span class="sd">            If True, prints detailed information during initialization and</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a><span class="sd">            subsequent computations.</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Initializing VIC problem&quot;</span><span class="p">)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] Image shape: </span><span class="si">{</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, dtype: </span><span class="si">{</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] Mesh: </span><span class="si">{</span><span class="n">mesh</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>        <span class="c1"># --- Foreground / Background -------------------------------------------------</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>        <span class="k">if</span> <span class="n">fg_bg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Estimating foreground/background levels from image&quot;</span><span class="p">)</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_fg_bg</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">fg_bg_method</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bg</span> <span class="o">=</span> <span class="n">fg_bg</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] fg = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="si">}</span><span class="s2">, bg = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>        <span class="c1"># --- ICP + h initialization --------------------------------------------------</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Initializing placement and research half width h&quot;</span><span class="p">)</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Rmat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvec</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_h_mesh_ICP</span><span class="p">(</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>            <span class="n">ICP_init</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>        <span class="p">)</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] h = </span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] Rmat:</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Rmat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] tvec: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tvec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>        <span class="c1"># --- Virtual image ------------------------------------------------------------</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>        <span class="k">if</span> <span class="n">reversed_normals</span><span class="p">:</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Using reversed normals for virtual image&quot;</span><span class="p">)</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>            <span class="n">g</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">virtual_image</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bg</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="p">)</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>            <span class="n">g</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">virtual_image</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bg</span><span class="p">)</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>        <span class="c1"># --- Image energies -----------------------------------------------------------</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Building image energies&quot;</span><span class="p">)</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>                <span class="sa">f</span><span class="s2">&quot;[VIC] Integration params: surf_dx=</span><span class="si">{</span><span class="n">surf_dx</span><span class="si">}</span><span class="s2">, width_dx=</span><span class="si">{</span><span class="n">width_dx</span><span class="si">}</span><span class="s2">, alpha=</span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>            <span class="p">)</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span> <span class="o">=</span> <span class="n">make_image_energies</span><span class="p">(</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>            <span class="n">h</span><span class="p">,</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>            <span class="n">width_dx</span><span class="o">=</span><span class="n">width_dx</span><span class="p">,</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>            <span class="n">surf_dx</span><span class="o">=</span><span class="n">surf_dx</span><span class="p">,</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>            <span class="n">virtual_image</span><span class="o">=</span><span class="n">g</span><span class="p">,</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>            <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>        <span class="p">)</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>        <span class="c1"># --- C1 constraints -----------------------------------------------------------</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Building C1 constraints&quot;</span><span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>        <span class="n">C1_eqs</span> <span class="o">=</span> <span class="n">make_C1_eqs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">C1_mode</span><span class="p">)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">DirichletConstraintHandler</span><span class="p">(</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">connectivity</span><span class="o">.</span><span class="n">nb_unique_nodes</span> <span class="o">*</span> <span class="mi">3</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="p">)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">add_eqs</span><span class="p">(</span><span class="n">C1_eqs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">C1_eqs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">))</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] Number of C1 equations: </span><span class="si">{</span><span class="n">C1_eqs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dirichlet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_dirichlet</span><span class="p">()</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>        <span class="c1"># --- Membrane stiffness -------------------------------------------------------</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Assembling membrane stiffness matrix&quot;</span><span class="p">)</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">membrane_K</span> <span class="o">=</span> <span class="n">make_membrane_stifness</span><span class="p">(</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>        <span class="p">)</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>        <span class="c1"># --- Membrane weight ----------------------------------------------------------</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>        <span class="k">if</span> <span class="n">membrane_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Computing membrane weight automatically&quot;</span><span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>                    <span class="sa">f</span><span class="s2">&quot;[VIC] initial_rho=</span><span class="si">{</span><span class="n">initial_rho</span><span class="si">}</span><span class="s2">, expected_mean_dist=</span><span class="si">{</span><span class="n">expected_mean_dist</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>                <span class="p">)</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">make_membrane_weight</span><span class="p">(</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>                <span class="n">initial_rho</span><span class="p">,</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>                <span class="n">expected_mean_dist</span><span class="o">=</span><span class="n">expected_mean_dist</span><span class="p">,</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>                <span class="n">n_intg</span><span class="o">=</span><span class="n">n_intg_membrane_weight_comput</span><span class="p">,</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="p">)</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] Computed membrane weight : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">membrane_weight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">membrane_weight</span> <span class="o">=</span> <span class="n">membrane_weight</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] Using user-defined membrane_weight = </span><span class="si">{</span><span class="n">membrane_weight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">initial_rho</span> <span class="o">=</span> <span class="n">initial_rho</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>            <span class="nb">float</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>        <span class="p">)</span>  <span class="c1"># TODO remove casting by adapting interpolation</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Initialization done â&quot;</span><span class="p">)</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_fg_bg</span><span class="p">(</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;otsu&quot;</span><span class="p">,</span> <span class="s2">&quot;interp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;otsu&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>    <span class="p">):</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a><span class="sd">        Estimate foreground and background gray levels from the input image.</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a><span class="sd">        This method analyzes the gray-level distribution of the volumetric image</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a><span class="sd">        and returns representative foreground (`fg`) and background (`bg`) values.</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a><span class="sd">        These values are used by the virtual image model to map signed distances</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a><span class="sd">        to gray levels in the VIC formulation.</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a><span class="sd">        Parameters</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a><span class="sd">        ----------</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a><span class="sd">        method : Literal[&quot;otsu&quot;, &quot;interp&quot;], optional</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a><span class="sd">            Strategy used to estimate foreground and background levels:</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a><span class="sd">                - &quot;otsu&quot;: threshold-based estimation using Otsu&#39;s method.</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a><span class="sd">                - &quot;interp&quot;: estimation based on interpolation of histogram peaks.</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a><span class="sd">            Default is &quot;otsu&quot;.</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a><span class="sd">            If True, prints diagnostic information during the estimation process.</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a><span class="sd">        Returns</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a><span class="sd">        -------</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a><span class="sd">        fg : float</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a><span class="sd">            Estimated foreground gray level.</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a><span class="sd">        bg : float</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a><span class="sd">            Estimated background gray level.</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC][FG/BG] method=</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>        <span class="n">fg</span><span class="p">,</span> <span class="n">bg</span> <span class="o">=</span> <span class="n">find_fg_bg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">save_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC][FG/BG] fg=</span><span class="si">{</span><span class="n">fg</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, bg=</span><span class="si">{</span><span class="n">bg</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>        <span class="k">return</span> <span class="n">fg</span><span class="p">,</span> <span class="n">bg</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_h_mesh_ICP</span><span class="p">(</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>        <span class="n">ICP_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>        <span class="n">h</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>    <span class="p">):</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a><span class="sd">        Initialize the mesh placement and the normal search half-width `h`.</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a><span class="sd">        This method optionally performs a rigid-body Iterative Closest Point (ICP)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a><span class="sd">        alignment between the surface mesh and an isosurface extracted from the</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a><span class="sd">        image. It also initializes the normal search half-width `h`, which</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a><span class="sd">        defines the integration domain along surface normals for the image</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a><span class="sd">        correlation energies.</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a><span class="sd">        The isosurface is obtained using a marching-cubes extraction at the</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a><span class="sd">        mid-gray level between the estimated foreground and background values.</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a><span class="sd">        Behavior depends on the input parameters:</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a><span class="sd">            - If `ICP_init=True`, a rigid-body ICP alignment is performed and</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a><span class="sd">              the resulting rotation matrix and translation vector are returned.</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a><span class="sd">            - If `h` is `None`, the value of `h` is automatically estimated</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">              from the maximum distance between the mesh and the extracted</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a><span class="sd">              isosurface.</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a><span class="sd">            - If `ICP_init=False` and `h` is provided, no alignment is</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="sd">              performed and `h` is left unchanged.</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a><span class="sd">        Parameters</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a><span class="sd">        ----------</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a><span class="sd">        ICP_init : bool, optional</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a><span class="sd">            If `True` (default), performs a rigid-body ICP alignment between the</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a><span class="sd">            mesh and the image-derived isosurface.</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a><span class="sd">        h : float or None, optional</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a><span class="sd">            Normal search half-width used in image energy integration.</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a><span class="sd">            If `None` (default), `h` is automatically estimated from the maximum</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a><span class="sd">            mesh-to-image distance.</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a><span class="sd">            If `True`, disables parallel execution during ICP and distance-field</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a><span class="sd">            computations. By default, `False`.</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a><span class="sd">            If `True`, prints diagnostic information during initialization.</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a><span class="sd">            By default, `True`.</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a><span class="sd">        Returns</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a><span class="sd">        -------</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a><span class="sd">        Rmat : np.ndarray</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a><span class="sd">            3x3 rotation matrix resulting from the ICP alignment.</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a><span class="sd">            Identity if no ICP is performed.</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a><span class="sd">        tvec : np.ndarray</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a><span class="sd">            Translation vector resulting from the ICP alignment.</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a><span class="sd">            Zero vector if no ICP is performed.</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a><span class="sd">        h : float</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a><span class="sd">            Initialized normal search half-width.</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>        <span class="n">compute_h</span> <span class="o">=</span> <span class="n">h</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>        <span class="k">if</span> <span class="n">ICP_init</span> <span class="ow">or</span> <span class="n">compute_h</span><span class="p">:</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>            <span class="n">stl_mc</span> <span class="o">=</span> <span class="n">marching_cubes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bg</span><span class="p">))</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>            <span class="k">if</span> <span class="n">ICP_init</span><span class="p">:</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>                <span class="n">Rmat</span><span class="p">,</span> <span class="n">tvec</span><span class="p">,</span> <span class="n">max_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">ICP_rigid_body_transform</span><span class="p">(</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>                    <span class="n">stl_mc</span><span class="p">,</span> <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span> <span class="n">plot_after</span><span class="o">=</span><span class="n">verbose</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>                <span class="p">)</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>                <span class="k">if</span> <span class="n">compute_h</span><span class="p">:</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>                    <span class="n">h</span> <span class="o">=</span> <span class="n">max_dist</span> <span class="o">+</span> <span class="mf">1.0</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] ICP done | max_dist=</span><span class="si">{</span><span class="n">max_dist</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">, h=</span><span class="si">{</span><span class="n">h</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>                <span class="n">Rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>                <span class="n">tvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>                <span class="k">if</span> <span class="n">compute_h</span><span class="p">:</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>                    <span class="n">distance_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">distance_to_meshio</span><span class="p">(</span><span class="n">stl_mc</span><span class="p">)</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>                    <span class="n">max_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>                        <span class="n">distance_mesh</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s2">&quot;implicit_distance&quot;</span><span class="p">]</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>                    <span class="n">h</span> <span class="o">=</span> <span class="n">max_dist</span> <span class="o">+</span> <span class="mf">1.0</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>                            <span class="sa">f</span><span class="s2">&quot;[VIC] h from distance field | max_dist=</span><span class="si">{</span><span class="n">max_dist</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">, h=</span><span class="si">{</span><span class="n">h</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>                        <span class="p">)</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>            <span class="n">Rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>            <span class="n">tvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>        <span class="k">return</span> <span class="n">Rmat</span><span class="p">,</span> <span class="n">tvec</span><span class="p">,</span> <span class="n">h</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">make_membrane_weight</span><span class="p">(</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>        <span class="n">rho</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>        <span class="n">expected_mean_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>        <span class="n">n_intg</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a><span class="sd">        Compute and set the membrane regularization weight.</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a><span class="sd">        This method computes the weight associated with the membrane (elastic)</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a><span class="sd">        regularization term based on the current problem configuration and image</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a><span class="sd">        statistics. The weight is calibrated such that the regularization term</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a><span class="sd">        is consistent with the expected image-to-surface distance scale.</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a><span class="sd">        The actual computation is delegated to</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a><span class="sd">        :func:`volVIC.membrane_stiffness.make_membrane_weight`.</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a><span class="sd">        Parameters</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a><span class="sd">        ----------</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a><span class="sd">        rho : float or None, optional</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a><span class="sd">            Value of the transition distance parameter used in the VIC</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a><span class="sd">            model. If `None` (default), `self.initial_rho` is used.</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a><span class="sd">        expected_mean_dist : float, optional</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a><span class="sd">            Expected mean signed distance (in image units) between the surface</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a><span class="sd">            and the image features. This value is used to calibrate the membrane</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a><span class="sd">            weight. Default is `5.0`.</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a><span class="sd">        n_intg : int, optional</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a><span class="sd">            Number of integration points used to estimate the membrane weight.</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a><span class="sd">            Higher values improve accuracy at the cost of additional computation.</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a><span class="sd">            Default is `100`.</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a><span class="sd">        Returns</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a><span class="sd">        -------</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a><span class="sd">        float</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a><span class="sd">            Computed membrane regularization weight.</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>        <span class="k">if</span> <span class="n">rho</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>            <span class="n">rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_rho</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>        <span class="n">image_std</span> <span class="o">=</span> <span class="n">find_sigma_hat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bg</span><span class="p">)</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">membrane_weight</span> <span class="o">=</span> <span class="n">make_membrane_weight</span><span class="p">(</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">,</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">membrane_K</span><span class="p">,</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>            <span class="n">rho</span><span class="o">=</span><span class="n">rho</span><span class="p">,</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>            <span class="n">image_std</span><span class="o">=</span><span class="n">image_std</span><span class="p">,</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>            <span class="n">expected_mean_dist</span><span class="o">=</span><span class="n">expected_mean_dist</span><span class="p">,</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>            <span class="n">n_intg</span><span class="o">=</span><span class="n">n_intg</span><span class="p">,</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>        <span class="p">)</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">make_dirichlet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a><span class="sd">        Build the reduced-DOF Dirichlet representation from linear constraints.</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a><span class="sd">        The object `self.constraints` stores linear equality constraints of</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a><span class="sd">        the form `D @ u = c`. This method converts this representation into a</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a><span class="sd">        reduced-DOF Dirichlet mapping of the form</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a><span class="sd">            u = C @ dof + k ,</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a><span class="sd">        where `C` is a basis of the null space of `D` (`D @ C = 0`) and</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a><span class="sd">        `k` is a particular solution satisfying `D @ k = c`.</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a><span class="sd">        The resulting mapping is stored in `self.dirichlet` and is used to</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a><span class="sd">        eliminate constrained degrees of freedom in the solver.</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dirichlet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">create_dirichlet</span><span class="p">()</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">one_gauss_newton_iter</span><span class="p">(</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>        <span class="n">u_field</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>        <span class="n">rho</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="n">sps</span><span class="o">.</span><span class="n">spmatrix</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a><span class="sd">        Perform a single Gauss-Newton iteration for the VIC problem.</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a><span class="sd">        This method updates the displacement field and the transition distance</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a><span class="sd">        parameter `rho` by computing the incremental corrections using the</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a><span class="sd">        Gauss-Newton scheme. The actual computation is performed by</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a><span class="sd">        :func:`volVIC.solve.iteration`.</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a><span class="sd">        Parameters</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a><span class="sd">        ----------</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a><span class="sd">        u_field : np.ndarray</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a><span class="sd">            Current displacement field of the mesh nodes, shape (3, N).</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a><span class="sd">        rho : float</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a><span class="sd">            Current value of the transition distance parameter used in the VIC model.</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a><span class="sd">            If `True`, prints diagnostic information during the iteration.</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a><span class="sd">            By default, `True`.</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a><span class="sd">            If `True`, disables parallel execution during the iteration.</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a><span class="sd">            By default, `False`.</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a><span class="sd">        Returns</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a><span class="sd">        -------</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a><span class="sd">        du_field : np.ndarray</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a><span class="sd">            Incremental displacement field computed during this iteration.</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a><span class="sd">        drho : float</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a><span class="sd">            Incremental update of the transition distance parameter `rho`.</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>        <span class="n">du_field</span><span class="p">,</span> <span class="n">drho</span> <span class="o">=</span> <span class="n">iteration</span><span class="p">(</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>            <span class="n">u_field</span><span class="p">,</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>            <span class="n">rho</span><span class="p">,</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">,</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">membrane_K</span><span class="p">,</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">membrane_weight</span><span class="p">,</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dirichlet</span><span class="o">.</span><span class="n">C</span><span class="p">,</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>            <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>        <span class="p">)</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>        <span class="k">return</span> <span class="n">du_field</span><span class="p">,</span> <span class="n">drho</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>        <span class="n">u_field</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>        <span class="n">rho</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>        <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5e-2</span><span class="p">,</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>        <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a><span class="sd">        Solve the VIC problem using a Gauss-Newton optimization.</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a><span class="sd">        This method iteratively updates the displacement field and the transition</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a><span class="sd">        distance parameter `rho` to minimize the VIC energy. Each iteration is</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a><span class="sd">        performed using :meth:`one_gauss_newton_iter`.</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a><span class="sd">        The iteration stops when either the maximum number of iterations is</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a><span class="sd">        reached or the relative update of the displacement field is below</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a><span class="sd">        `eps`.</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a><span class="sd">        The displacement field is updated in-place and stored in `u_field`.</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a><span class="sd">        The first iteration&#39;s data from all image energies are cached in</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a><span class="sd">        `self.saved_data_0` for post-processing and visualization.</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a><span class="sd">        Parameters</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a><span class="sd">        ----------</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a><span class="sd">        u_field : np.ndarray, optional</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a><span class="sd">            Initial displacement field of shape (3, N). If `None` (default),</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a><span class="sd">            initializes to zero.</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a><span class="sd">        rho : float, optional</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a><span class="sd">            Initial value of the distance scaling parameter. If `None` (default),</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a><span class="sd">            `self.initial_rho` is used.</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a><span class="sd">        eps : float, optional</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a><span class="sd">            Convergence tolerance. The relative norm of the displacement update</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a><span class="sd">            is compared to `eps` to decide convergence. Default is `5e-2`.</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a><span class="sd">        max_iter : int, optional</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a><span class="sd">            Maximum number of Gauss-Newton iterations. Default is `20`.</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a><span class="sd">            If `True`, prints iteration diagnostics including `rho` and</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a><span class="sd">            relative displacement updates. Default is `True`.</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a><span class="sd">            If `True`, disables parallel execution during the iterations.</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a><span class="sd">            Default is `False`.</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a><span class="sd">        Returns</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a><span class="sd">        -------</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a><span class="sd">        u_field : np.ndarray</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a><span class="sd">            Final displacement field after convergence or reaching `max_iter`.</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a><span class="sd">        rho : float</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a><span class="sd">            Final value of the transition distance parameter after convergence.</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a><span class="sd">        Notes</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a><span class="sd">        -----</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a><span class="sd">        This method relies on :meth:`one_gauss_newton_iter` to compute the</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a><span class="sd">        incremental updates for each iteration.</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>        <span class="k">if</span> <span class="n">u_field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>            <span class="n">u_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">connectivity</span><span class="o">.</span><span class="n">nb_unique_nodes</span><span class="p">))</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>        <span class="k">if</span> <span class="n">rho</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>            <span class="n">rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_rho</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>            <span class="n">du_field</span><span class="p">,</span> <span class="n">drho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_gauss_newton_iter</span><span class="p">(</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>                <span class="n">u_field</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>            <span class="p">)</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>            <span class="n">u_field</span> <span class="o">+=</span> <span class="n">du_field</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>            <span class="n">rho</span> <span class="o">+=</span> <span class="n">drho</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>            <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">saved_data_0</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>                    <span class="n">deepcopy</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">saved_data</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>                <span class="p">]</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>            <span class="n">du_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">du_field</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u_field</span><span class="p">)</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;iter = </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, rho = </span><span class="si">{</span><span class="n">rho</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, du/u = </span><span class="si">{</span><span class="n">du_u</span><span class="si">:</span><span class="s2">.2E</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>            <span class="k">if</span> <span class="n">du_u</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">:</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>                <span class="k">break</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>        <span class="k">return</span> <span class="n">u_field</span><span class="p">,</span> <span class="n">rho</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_paraview</span><span class="p">(</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>        <span class="n">u_field</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>        <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>    <span class="p">):</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a><span class="sd">        Export the current VIC results to Paraview-compatible VTK files.</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a><span class="sd">        This method computes the signed distance fields before and after the</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a><span class="sd">        displacement update, associates them with the mesh nodes, and calls</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a><span class="sd">        the mesh&#39;s :meth:`Mesh.save_paraview` method to save all fields for</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a><span class="sd">        visualization in Paraview.</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a><span class="sd">        The exported fields include:</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a><span class="sd">            - `u`: displacement field provided in `u_field`.</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a><span class="sd">            - `d0`: signed distance fields at the first iteration (cached in</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a><span class="sd">              `self.saved_data_0`).</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a><span class="sd">            - `d`: signed distance fields at the current iteration (not computed</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a><span class="sd">              from `u_field`).</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a><span class="sd">        Parameters</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a><span class="sd">        ----------</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a><span class="sd">        u_field : np.ndarray</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a><span class="sd">            Displacement field of shape (3, N) to be saved.</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a><span class="sd">        folder : str</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a><span class="sd">            Destination folder where the VTK files will be written.</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a><span class="sd">        name : str</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a><span class="sd">            Base name for the exported VTK files.</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a><span class="sd">            If `True`, disables parallel execution for distance field computation</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a><span class="sd">            and mesh export. Default is `False`.</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a><span class="sd">            If `True` (default), prints diagnostic messages during computation</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a><span class="sd">            and export.</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a><span class="sd">        Notes</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a><span class="sd">        -----</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a><span class="sd">        The method automatically constructs the `XI_list` from the parametric</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a><span class="sd">        coordinates of each image energy element and sets</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a><span class="sd">        `fields_on_interior_only=&quot;auto&quot;` for the mesh export.</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>        <span class="n">d0</span> <span class="o">=</span> <span class="n">compute_distance_field</span><span class="p">(</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">,</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>            <span class="n">saved_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_data_0</span><span class="p">,</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>            <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>        <span class="p">)</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>        <span class="n">d</span> <span class="o">=</span> <span class="n">compute_distance_field</span><span class="p">(</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">,</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>            <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>        <span class="p">)</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>        <span class="n">separated_fields</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">di</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="s2">&quot;d0&quot;</span><span class="p">:</span> <span class="n">d0i</span><span class="p">[</span><span class="kc">None</span><span class="p">]}</span> <span class="k">for</span> <span class="n">di</span><span class="p">,</span> <span class="n">d0i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d0</span><span class="p">)]</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>        <span class="n">unique_fields</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="n">u_field</span><span class="p">[</span><span class="kc">None</span><span class="p">]}</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>        <span class="n">XI_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">e</span><span class="o">.</span><span class="n">xi</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">eta</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">]</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">save_paraview</span><span class="p">(</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>            <span class="n">folder</span><span class="p">,</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>            <span class="n">name</span><span class="p">,</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a>            <span class="n">unique_fields</span><span class="o">=</span><span class="n">unique_fields</span><span class="p">,</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a>            <span class="n">separated_fields</span><span class="o">=</span><span class="n">separated_fields</span><span class="p">,</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a>            <span class="n">XI_list</span><span class="o">=</span><span class="n">XI_list</span><span class="p">,</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>            <span class="n">fields_on_interior_only</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>            <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>        <span class="p">)</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_results</span><span class="p">(</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a>        <span class="n">u_field</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a>        <span class="n">n_colors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a>        <span class="n">interior_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a>        <span class="n">plt_ctrl_mesh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a>        <span class="n">pv_plotter</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pv</span><span class="o">.</span><span class="n">Plotter</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a>        <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>        <span class="n">elem_sep_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a>        <span class="n">ctrl_poly_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a>        <span class="o">**</span><span class="n">pv_add_mesh_kwargs</span><span class="p">,</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a>    <span class="p">):</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a><span class="sd">        Visualize VIC results with PyVista, optionally applying a displacement field.</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a><span class="sd">        This method plots the signed distance fields of the mesh with respect to</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a><span class="sd">        the image features. If a displacement field `u_field` is provided, it</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a><span class="sd">        is applied to a copy of the mesh for visualization; otherwise, the</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a><span class="sd">        distances from the first iteration are displayed. It is recommended</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a><span class="sd">        to pass the displacement field obtained from `solve` to make sure to match</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a><span class="sd">        the distance map to the correct displacement field.</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a><span class="sd">        The visualization can be customized, including the number of colors,</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a><span class="sd">        control mesh display, scalar bar, and interior-only rendering. Any</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a><span class="sd">        additional keyword arguments are passed to :meth:`Mesh.plot`, which</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a><span class="sd">        ultimately forwards them to :meth:`pv.Plotter.add_mesh`.</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a><span class="sd">        Parameters</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a><span class="sd">        ----------</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a><span class="sd">        u_field : np.ndarray or None, optional</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a><span class="sd">            Displacement field to apply to the mesh for visualization. If `None`</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a><span class="sd">            (default), the distances from the first iteration (`self.saved_data_0`)</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a><span class="sd">            are displayed. If provided, the mesh is warped according to this</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a><span class="sd">            displacement. To correctly display the most recent VIC results,</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a><span class="sd">            pass the `u_field` output from the `solve` method, as the distance</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a><span class="sd">            map displayed corresponds to the last iteration computed by the</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a><span class="sd">            image energy terms.</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos">787</span></a><span class="sd">            If `True`, disables parallel computation of distance fields.</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos">788</span></a><span class="sd">            Default is `False`.</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos">789</span></a>
</span><span id="L-790"><a href="#L-790"><span class="linenos">790</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos">791</span></a><span class="sd">            If `True`, prints diagnostic messages. Default is `True`.</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos">792</span></a>
</span><span id="L-793"><a href="#L-793"><span class="linenos">793</span></a><span class="sd">        n_colors : int, optional</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos">794</span></a><span class="sd">            Number of discrete colors in the colormap. Default is `15`.</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos">795</span></a>
</span><span id="L-796"><a href="#L-796"><span class="linenos">796</span></a><span class="sd">        interior_only : bool, optional</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos">797</span></a><span class="sd">            If `True`, only interior elements of the mesh are plotted.</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos">798</span></a><span class="sd">            Default is `True`.</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos">799</span></a>
</span><span id="L-800"><a href="#L-800"><span class="linenos">800</span></a><span class="sd">        plt_ctrl_mesh : bool, optional</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos">801</span></a><span class="sd">            If `True`, overlays the control mesh on the plot.</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos">802</span></a><span class="sd">            Default is `False`.</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos">803</span></a>
</span><span id="L-804"><a href="#L-804"><span class="linenos">804</span></a><span class="sd">        pv_plotter : pv.Plotter or None, optional</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos">805</span></a><span class="sd">            PyVista plotter object to use. If `None`, a new plotter is created.</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos">806</span></a>
</span><span id="L-807"><a href="#L-807"><span class="linenos">807</span></a><span class="sd">        show : bool, optional</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos">808</span></a><span class="sd">            If `True`, displays the plot immediately. Default is `True`.</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos">809</span></a>
</span><span id="L-810"><a href="#L-810"><span class="linenos">810</span></a><span class="sd">        elem_sep_color : str, optional</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos">811</span></a><span class="sd">            Color used for separating elements. Only applied if `interior_only`</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos">812</span></a><span class="sd">            is `False`. Default is `&#39;black&#39;`.</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos">813</span></a>
</span><span id="L-814"><a href="#L-814"><span class="linenos">814</span></a><span class="sd">        ctrl_poly_color : str, optional</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos">815</span></a><span class="sd">            Color of the control mesh. Only applied if `plt_ctrl_mesh` is `True`</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos">816</span></a><span class="sd">            and `interior_only` is `False`. Default is `&#39;green&#39;`.</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos">817</span></a>
</span><span id="L-818"><a href="#L-818"><span class="linenos">818</span></a><span class="sd">        **pv_add_mesh_kwargs : dict, optional</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos">819</span></a><span class="sd">            Additional keyword arguments passed to :meth:`Mesh.plot`, such as</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos">820</span></a><span class="sd">            `cmap`, `clim`, `scalar_bar_args`, etc.</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos">821</span></a>
</span><span id="L-822"><a href="#L-822"><span class="linenos">822</span></a><span class="sd">        Returns</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos">823</span></a><span class="sd">        -------</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos">824</span></a><span class="sd">        pv.Plotter or None</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos">825</span></a><span class="sd">            The PyVista plotter object used for the visualization.</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos">826</span></a>
</span><span id="L-827"><a href="#L-827"><span class="linenos">827</span></a><span class="sd">        Notes</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos">828</span></a><span class="sd">        -----</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos">829</span></a><span class="sd">        - The signed distance field `d` is computed from the image energies via</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos">830</span></a><span class="sd">          :func:`volVIC.VirtualImageCorrelationEnergyElem.compute_distance_field`.</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos">831</span></a><span class="sd">        - The default colormap is a resampled `&quot;RdBu&quot;` with `n_colors`.</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos">832</span></a><span class="sd">        - Scalar bar properties are automatically set but can be overridden via</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos">833</span></a><span class="sd">          `pv_add_mesh_kwargs[&quot;scalar_bar_args&quot;]`.</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos">834</span></a><span class="sd">        - To make sure the deformation matches the distance field, always pass the</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos">835</span></a><span class="sd">          displacement field returned by :meth:`solve`.</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos">836</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos">837</span></a>        <span class="k">if</span> <span class="n">u_field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos">838</span></a>            <span class="n">d</span> <span class="o">=</span> <span class="n">compute_distance_field</span><span class="p">(</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos">839</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">,</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos">840</span></a>                <span class="n">saved_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_data_0</span><span class="p">,</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos">841</span></a>                <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos">842</span></a>                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos">843</span></a>            <span class="p">)</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos">844</span></a>            <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos">845</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos">846</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos">847</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assume last iteration state.&quot;</span><span class="p">)</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos">848</span></a>            <span class="n">d</span> <span class="o">=</span> <span class="n">compute_distance_field</span><span class="p">(</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos">849</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">,</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos">850</span></a>                <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos">851</span></a>                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos">852</span></a>            <span class="p">)</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos">853</span></a>            <span class="n">mesh</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos">854</span></a>            <span class="n">mesh</span><span class="o">.</span><span class="n">unique_ctrl_pts</span><span class="o">.</span><span class="n">flat</span> <span class="o">+=</span> <span class="n">u_field</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos">855</span></a>
</span><span id="L-856"><a href="#L-856"><span class="linenos">856</span></a>        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s2">&quot;RdBu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resampled</span><span class="p">(</span><span class="n">n_colors</span><span class="p">)</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos">857</span></a>        <span class="n">pv_add_mesh_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;cmap&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="p">)</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos">858</span></a>        <span class="k">if</span> <span class="s2">&quot;clim&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pv_add_mesh_kwargs</span><span class="p">:</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos">859</span></a>            <span class="n">lim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="mf">1e-3</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos">860</span></a>            <span class="n">pv_add_mesh_kwargs</span><span class="p">[</span><span class="s2">&quot;clim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">lim</span><span class="p">,</span> <span class="n">lim</span><span class="p">]</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos">861</span></a>        <span class="n">sargs</span> <span class="o">=</span> <span class="n">pv_add_mesh_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scalar_bar_args&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos">862</span></a>        <span class="n">defaults_sargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos">863</span></a>            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Signed distance to the image features [px]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos">864</span></a>            <span class="n">vertical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos">865</span></a>            <span class="n">position_x</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos">866</span></a>            <span class="n">position_y</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos">867</span></a>            <span class="n">height</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos">868</span></a>            <span class="n">width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos">869</span></a>            <span class="n">n_colors</span><span class="o">=</span><span class="n">n_colors</span><span class="p">,</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos">870</span></a>            <span class="n">title_font_size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos">871</span></a>            <span class="n">label_font_size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos">872</span></a>        <span class="p">)</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos">873</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults_sargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos">874</span></a>            <span class="n">sargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos">875</span></a>        <span class="n">pv_add_mesh_kwargs</span><span class="p">[</span><span class="s2">&quot;scalar_bar_args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sargs</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos">876</span></a>
</span><span id="L-877"><a href="#L-877"><span class="linenos">877</span></a>        <span class="n">XI_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">e</span><span class="o">.</span><span class="n">xi</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">eta</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">]</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos">878</span></a>        <span class="k">return</span> <span class="n">mesh</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos">879</span></a>            <span class="n">XI_list</span><span class="o">=</span><span class="n">XI_list</span><span class="p">,</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos">880</span></a>            <span class="n">separated_field</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos">881</span></a>            <span class="n">interior_only</span><span class="o">=</span><span class="n">interior_only</span><span class="p">,</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos">882</span></a>            <span class="n">plt_ctrl_mesh</span><span class="o">=</span><span class="n">plt_ctrl_mesh</span><span class="p">,</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos">883</span></a>            <span class="n">pv_plotter</span><span class="o">=</span><span class="n">pv_plotter</span><span class="p">,</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos">884</span></a>            <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos">885</span></a>            <span class="n">elem_sep_color</span><span class="o">=</span><span class="n">elem_sep_color</span><span class="p">,</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos">886</span></a>            <span class="n">ctrl_poly_color</span><span class="o">=</span><span class="n">ctrl_poly_color</span><span class="p">,</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos">887</span></a>            <span class="o">**</span><span class="n">pv_add_mesh_kwargs</span><span class="p">,</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos">888</span></a>        <span class="p">)</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos">889</span></a>
</span><span id="L-890"><a href="#L-890"><span class="linenos">890</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">propagate_displacement_to_volume_mesh</span><span class="p">(</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos">891</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos">892</span></a>        <span class="n">u_field</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos">893</span></a>        <span class="n">volume_mesh</span><span class="p">:</span> <span class="n">Mesh</span><span class="p">,</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos">894</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos">895</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]:</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos">896</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos">897</span></a><span class="sd">        Propagate the surface displacement field to a volumetric mesh.</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos">898</span></a>
</span><span id="L-899"><a href="#L-899"><span class="linenos">899</span></a><span class="sd">        This method maps the displacement field computed on the surface mesh</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos">900</span></a><span class="sd">        (`self.mesh`) to a target volume mesh (`volume_mesh`). The mapping uses</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos">901</span></a><span class="sd">        the surface-to-volume interpolation implemented in</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos">902</span></a><span class="sd">        :meth:`Mesh.propagate_field_from_submesh`. The resulting volumetric</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos">903</span></a><span class="sd">        displacement field is returned in the same coordinate system as the</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos">904</span></a><span class="sd">        original surface mesh (before ICP).</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos">905</span></a>
</span><span id="L-906"><a href="#L-906"><span class="linenos">906</span></a><span class="sd">        Parameters</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos">907</span></a><span class="sd">        ----------</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos">908</span></a><span class="sd">        u_field : np.ndarray[np.floating]</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos">909</span></a><span class="sd">            Surface displacement field to propagate. Typically, this is the</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos">910</span></a><span class="sd">            `u_field` obtained from the :meth:`solve` method.</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos">911</span></a>
</span><span id="L-912"><a href="#L-912"><span class="linenos">912</span></a><span class="sd">        volume_mesh : Mesh</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos">913</span></a><span class="sd">            Target volumetric mesh on which to propagate the displacement.</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos">914</span></a>
</span><span id="L-915"><a href="#L-915"><span class="linenos">915</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos">916</span></a><span class="sd">            If `True`, disables parallel computation. Default is `False`.</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos">917</span></a>
</span><span id="L-918"><a href="#L-918"><span class="linenos">918</span></a><span class="sd">        Returns</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos">919</span></a><span class="sd">        -------</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos">920</span></a><span class="sd">        np.ndarray[np.floating]</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos">921</span></a><span class="sd">            Displacement field defined on the volume mesh, in the same</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos">922</span></a><span class="sd">            coordinate system as the input surface displacement.</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos">923</span></a>
</span><span id="L-924"><a href="#L-924"><span class="linenos">924</span></a><span class="sd">        Notes</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos">925</span></a><span class="sd">        -----</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos">926</span></a><span class="sd">        - The propagation is performed via</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos">927</span></a><span class="sd">          :meth:`Mesh.propagate_field_from_submesh`, which interpolates the</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos">928</span></a><span class="sd">          surface displacement onto the volume nodes.</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos">929</span></a><span class="sd">        - The method internally applies and then removes the rigid-body</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos">930</span></a><span class="sd">          rotation `self.Rmat` used during VIC initialization to ensure</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos">931</span></a><span class="sd">          consistency between surface and volume coordinate frames.</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos">932</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos">933</span></a>
</span><span id="L-934"><a href="#L-934"><span class="linenos">934</span></a>        <span class="n">u_vol_field</span> <span class="o">=</span> <span class="n">volume_mesh</span><span class="o">.</span><span class="n">propagate_field_from_submesh</span><span class="p">(</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos">935</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos">936</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Rmat</span> <span class="o">@</span> <span class="n">u_field</span><span class="p">,</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos">937</span></a>            <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos">938</span></a>        <span class="p">)</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos">939</span></a>        <span class="n">u_vol_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rmat</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">u_vol_field</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos">940</span></a>        <span class="k">return</span> <span class="n">u_vol_field</span>
</span></pre></div>


            </section>
                <section id="Problem">
                            <input id="Problem-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Problem</span>:

                <label class="view-source-button" for="Problem-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Problem"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Problem-25"><a href="#Problem-25"><span class="linenos"> 25</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Problem</span><span class="p">:</span>
</span><span id="Problem-26"><a href="#Problem-26"><span class="linenos"> 26</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem-27"><a href="#Problem-27"><span class="linenos"> 27</span></a><span class="sd">    Virtual Image Correlation (VIC) problem definition and solver.</span>
</span><span id="Problem-28"><a href="#Problem-28"><span class="linenos"> 28</span></a>
</span><span id="Problem-29"><a href="#Problem-29"><span class="linenos"> 29</span></a><span class="sd">    This class encapsulates the full setup of a surface-based VIC problem:</span>
</span><span id="Problem-30"><a href="#Problem-30"><span class="linenos"> 30</span></a><span class="sd">    geometry, image model, regularization, constraints, and nonlinear solver.</span>
</span><span id="Problem-31"><a href="#Problem-31"><span class="linenos"> 31</span></a><span class="sd">    A typical workflow is:</span>
</span><span id="Problem-32"><a href="#Problem-32"><span class="linenos"> 32</span></a><span class="sd">        1. Instantiate a Problem from a mesh and an image</span>
</span><span id="Problem-33"><a href="#Problem-33"><span class="linenos"> 33</span></a><span class="sd">        2. Call `solve` to estimate the displacement field</span>
</span><span id="Problem-34"><a href="#Problem-34"><span class="linenos"> 34</span></a><span class="sd">        3. Export results using `save_paraview` or propagate them to a volume mesh</span>
</span><span id="Problem-35"><a href="#Problem-35"><span class="linenos"> 35</span></a>
</span><span id="Problem-36"><a href="#Problem-36"><span class="linenos"> 36</span></a><span class="sd">    Attributes</span>
</span><span id="Problem-37"><a href="#Problem-37"><span class="linenos"> 37</span></a><span class="sd">    ----------</span>
</span><span id="Problem-38"><a href="#Problem-38"><span class="linenos"> 38</span></a><span class="sd">    mesh : Mesh</span>
</span><span id="Problem-39"><a href="#Problem-39"><span class="linenos"> 39</span></a><span class="sd">        Surface mesh used in the VIC problem.</span>
</span><span id="Problem-40"><a href="#Problem-40"><span class="linenos"> 40</span></a>
</span><span id="Problem-41"><a href="#Problem-41"><span class="linenos"> 41</span></a><span class="sd">    image : np.ndarray</span>
</span><span id="Problem-42"><a href="#Problem-42"><span class="linenos"> 42</span></a><span class="sd">        Image converted to floating-point format for computations.</span>
</span><span id="Problem-43"><a href="#Problem-43"><span class="linenos"> 43</span></a>
</span><span id="Problem-44"><a href="#Problem-44"><span class="linenos"> 44</span></a><span class="sd">    fg, bg : float</span>
</span><span id="Problem-45"><a href="#Problem-45"><span class="linenos"> 45</span></a><span class="sd">        Estimated or user-defined foreground and background gray levels.</span>
</span><span id="Problem-46"><a href="#Problem-46"><span class="linenos"> 46</span></a>
</span><span id="Problem-47"><a href="#Problem-47"><span class="linenos"> 47</span></a><span class="sd">    Rmat : np.ndarray</span>
</span><span id="Problem-48"><a href="#Problem-48"><span class="linenos"> 48</span></a><span class="sd">        Rotation matrix resulting from ICP initialization.</span>
</span><span id="Problem-49"><a href="#Problem-49"><span class="linenos"> 49</span></a>
</span><span id="Problem-50"><a href="#Problem-50"><span class="linenos"> 50</span></a><span class="sd">    tvec : np.ndarray</span>
</span><span id="Problem-51"><a href="#Problem-51"><span class="linenos"> 51</span></a><span class="sd">        Translation vector resulting from ICP initialization.</span>
</span><span id="Problem-52"><a href="#Problem-52"><span class="linenos"> 52</span></a>
</span><span id="Problem-53"><a href="#Problem-53"><span class="linenos"> 53</span></a><span class="sd">    image_energies : list[VirtualImageCorrelationEnergyElem]</span>
</span><span id="Problem-54"><a href="#Problem-54"><span class="linenos"> 54</span></a><span class="sd">        Image energy elements used to assemble the VIC objective.</span>
</span><span id="Problem-55"><a href="#Problem-55"><span class="linenos"> 55</span></a>
</span><span id="Problem-56"><a href="#Problem-56"><span class="linenos"> 56</span></a><span class="sd">    constraints : DirichletConstraintHandler</span>
</span><span id="Problem-57"><a href="#Problem-57"><span class="linenos"> 57</span></a><span class="sd">        Handler storing linear equality constraints (e.g. CÂ¹ continuity).</span>
</span><span id="Problem-58"><a href="#Problem-58"><span class="linenos"> 58</span></a>
</span><span id="Problem-59"><a href="#Problem-59"><span class="linenos"> 59</span></a><span class="sd">    dirichlet : Dirichlet</span>
</span><span id="Problem-60"><a href="#Problem-60"><span class="linenos"> 60</span></a><span class="sd">        Dirichlet constraint object derived from the constraint handler.</span>
</span><span id="Problem-61"><a href="#Problem-61"><span class="linenos"> 61</span></a>
</span><span id="Problem-62"><a href="#Problem-62"><span class="linenos"> 62</span></a><span class="sd">    membrane_K : scipy.sparse.spmatrix</span>
</span><span id="Problem-63"><a href="#Problem-63"><span class="linenos"> 63</span></a><span class="sd">        Membrane stiffness matrix used for regularization.</span>
</span><span id="Problem-64"><a href="#Problem-64"><span class="linenos"> 64</span></a>
</span><span id="Problem-65"><a href="#Problem-65"><span class="linenos"> 65</span></a><span class="sd">    membrane_weight : float</span>
</span><span id="Problem-66"><a href="#Problem-66"><span class="linenos"> 66</span></a><span class="sd">        Weight associated with the membrane regularization term.</span>
</span><span id="Problem-67"><a href="#Problem-67"><span class="linenos"> 67</span></a>
</span><span id="Problem-68"><a href="#Problem-68"><span class="linenos"> 68</span></a><span class="sd">    initial_rho : float</span>
</span><span id="Problem-69"><a href="#Problem-69"><span class="linenos"> 69</span></a><span class="sd">        Initial value of the distance scaling parameter.</span>
</span><span id="Problem-70"><a href="#Problem-70"><span class="linenos"> 70</span></a>
</span><span id="Problem-71"><a href="#Problem-71"><span class="linenos"> 71</span></a><span class="sd">    saved_data_0 : list[dict[str, np.ndarray]]</span>
</span><span id="Problem-72"><a href="#Problem-72"><span class="linenos"> 72</span></a><span class="sd">        Cached image energy data from the first iteration, used for</span>
</span><span id="Problem-73"><a href="#Problem-73"><span class="linenos"> 73</span></a><span class="sd">        post-processing and visualization.</span>
</span><span id="Problem-74"><a href="#Problem-74"><span class="linenos"> 74</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Problem-75"><a href="#Problem-75"><span class="linenos"> 75</span></a>
</span><span id="Problem-76"><a href="#Problem-76"><span class="linenos"> 76</span></a>    <span class="n">mesh</span><span class="p">:</span> <span class="n">Mesh</span>
</span><span id="Problem-77"><a href="#Problem-77"><span class="linenos"> 77</span></a>    <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">]</span>
</span><span id="Problem-78"><a href="#Problem-78"><span class="linenos"> 78</span></a>    <span class="n">fg</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="Problem-79"><a href="#Problem-79"><span class="linenos"> 79</span></a>    <span class="n">bg</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="Problem-80"><a href="#Problem-80"><span class="linenos"> 80</span></a>    <span class="n">Rmat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]</span>
</span><span id="Problem-81"><a href="#Problem-81"><span class="linenos"> 81</span></a>    <span class="n">tvec</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]</span>
</span><span id="Problem-82"><a href="#Problem-82"><span class="linenos"> 82</span></a>    <span class="n">image_energies</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">VirtualImageCorrelationEnergyElem</span><span class="p">]</span>
</span><span id="Problem-83"><a href="#Problem-83"><span class="linenos"> 83</span></a>    <span class="n">constraints</span><span class="p">:</span> <span class="n">DirichletConstraintHandler</span>
</span><span id="Problem-84"><a href="#Problem-84"><span class="linenos"> 84</span></a>    <span class="n">dirichlet</span><span class="p">:</span> <span class="n">Dirichlet</span>
</span><span id="Problem-85"><a href="#Problem-85"><span class="linenos"> 85</span></a>    <span class="n">membrane_K</span><span class="p">:</span> <span class="n">sps</span><span class="o">.</span><span class="n">spmatrix</span>
</span><span id="Problem-86"><a href="#Problem-86"><span class="linenos"> 86</span></a>    <span class="n">membrane_weight</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="Problem-87"><a href="#Problem-87"><span class="linenos"> 87</span></a>    <span class="n">initial_rho</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="Problem-88"><a href="#Problem-88"><span class="linenos"> 88</span></a>    <span class="n">saved_data_0</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]]]</span>
</span><span id="Problem-89"><a href="#Problem-89"><span class="linenos"> 89</span></a>
</span><span id="Problem-90"><a href="#Problem-90"><span class="linenos"> 90</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="Problem-91"><a href="#Problem-91"><span class="linenos"> 91</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Problem-92"><a href="#Problem-92"><span class="linenos"> 92</span></a>        <span class="n">mesh</span><span class="p">:</span> <span class="n">Mesh</span><span class="p">,</span>
</span><span id="Problem-93"><a href="#Problem-93"><span class="linenos"> 93</span></a>        <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">],</span>
</span><span id="Problem-94"><a href="#Problem-94"><span class="linenos"> 94</span></a>        <span class="n">ICP_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem-95"><a href="#Problem-95"><span class="linenos"> 95</span></a>        <span class="n">reversed_normals</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Problem-96"><a href="#Problem-96"><span class="linenos"> 96</span></a>        <span class="n">fg_bg</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem-97"><a href="#Problem-97"><span class="linenos"> 97</span></a>        <span class="n">fg_bg_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;otsu&quot;</span><span class="p">,</span> <span class="s2">&quot;interp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;otsu&quot;</span><span class="p">,</span>
</span><span id="Problem-98"><a href="#Problem-98"><span class="linenos"> 98</span></a>        <span class="n">virtual_image</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
</span><span id="Problem-99"><a href="#Problem-99"><span class="linenos"> 99</span></a>            <span class="p">[</span>
</span><span id="Problem-100"><a href="#Problem-100"><span class="linenos">100</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
</span><span id="Problem-101"><a href="#Problem-101"><span class="linenos">101</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
</span><span id="Problem-102"><a href="#Problem-102"><span class="linenos">102</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
</span><span id="Problem-103"><a href="#Problem-103"><span class="linenos">103</span></a>                <span class="nb">float</span><span class="p">,</span>
</span><span id="Problem-104"><a href="#Problem-104"><span class="linenos">104</span></a>            <span class="p">],</span>
</span><span id="Problem-105"><a href="#Problem-105"><span class="linenos">105</span></a>            <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]],</span>
</span><span id="Problem-106"><a href="#Problem-106"><span class="linenos">106</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">g_slide</span><span class="p">,</span>
</span><span id="Problem-107"><a href="#Problem-107"><span class="linenos">107</span></a>        <span class="n">h</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem-108"><a href="#Problem-108"><span class="linenos">108</span></a>        <span class="n">width_dx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
</span><span id="Problem-109"><a href="#Problem-109"><span class="linenos">109</span></a>        <span class="n">surf_dx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="Problem-110"><a href="#Problem-110"><span class="linenos">110</span></a>        <span class="n">alpha</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="Problem-111"><a href="#Problem-111"><span class="linenos">111</span></a>        <span class="n">C1_mode</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="Problem-112"><a href="#Problem-112"><span class="linenos">112</span></a>            <span class="kc">None</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">]</span>
</span><span id="Problem-113"><a href="#Problem-113"><span class="linenos">113</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem-114"><a href="#Problem-114"><span class="linenos">114</span></a>        <span class="n">membrane_weight</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem-115"><a href="#Problem-115"><span class="linenos">115</span></a>        <span class="n">initial_rho</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
</span><span id="Problem-116"><a href="#Problem-116"><span class="linenos">116</span></a>        <span class="n">expected_mean_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
</span><span id="Problem-117"><a href="#Problem-117"><span class="linenos">117</span></a>        <span class="n">n_intg_membrane_weight_comput</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
</span><span id="Problem-118"><a href="#Problem-118"><span class="linenos">118</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Problem-119"><a href="#Problem-119"><span class="linenos">119</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem-120"><a href="#Problem-120"><span class="linenos">120</span></a>    <span class="p">):</span>
</span><span id="Problem-121"><a href="#Problem-121"><span class="linenos">121</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem-122"><a href="#Problem-122"><span class="linenos">122</span></a><span class="sd">        Initialize a Virtual Image Correlation (VIC) problem.</span>
</span><span id="Problem-123"><a href="#Problem-123"><span class="linenos">123</span></a>
</span><span id="Problem-124"><a href="#Problem-124"><span class="linenos">124</span></a><span class="sd">        This constructor performs the full problem setup, including:</span>
</span><span id="Problem-125"><a href="#Problem-125"><span class="linenos">125</span></a><span class="sd">        - foreground/background gray-level estimation,</span>
</span><span id="Problem-126"><a href="#Problem-126"><span class="linenos">126</span></a><span class="sd">        - optional rigid-body ICP alignment between mesh and image,</span>
</span><span id="Problem-127"><a href="#Problem-127"><span class="linenos">127</span></a><span class="sd">        - construction of virtual image energies,</span>
</span><span id="Problem-128"><a href="#Problem-128"><span class="linenos">128</span></a><span class="sd">        - assembly of CÂ¹ continuity constraints,</span>
</span><span id="Problem-129"><a href="#Problem-129"><span class="linenos">129</span></a><span class="sd">        - assembly of membrane regularization,</span>
</span><span id="Problem-130"><a href="#Problem-130"><span class="linenos">130</span></a><span class="sd">        - estimation of the coresponding regularization weight,</span>
</span><span id="Problem-131"><a href="#Problem-131"><span class="linenos">131</span></a><span class="sd">        - initialization of all data structures required by the nonlinear solver.</span>
</span><span id="Problem-132"><a href="#Problem-132"><span class="linenos">132</span></a>
</span><span id="Problem-133"><a href="#Problem-133"><span class="linenos">133</span></a><span class="sd">        After initialization, the problem is ready to be solved using</span>
</span><span id="Problem-134"><a href="#Problem-134"><span class="linenos">134</span></a><span class="sd">        :meth:`solve`, which performs a GaussâNewton optimization to estimate</span>
</span><span id="Problem-135"><a href="#Problem-135"><span class="linenos">135</span></a><span class="sd">        the displacement field and the distance scaling parameter.</span>
</span><span id="Problem-136"><a href="#Problem-136"><span class="linenos">136</span></a>
</span><span id="Problem-137"><a href="#Problem-137"><span class="linenos">137</span></a><span class="sd">        The mesh coordinates are assumed to be expressed in image voxel units.</span>
</span><span id="Problem-138"><a href="#Problem-138"><span class="linenos">138</span></a><span class="sd">        No unit conversion or rescaling is performed internally.</span>
</span><span id="Problem-139"><a href="#Problem-139"><span class="linenos">139</span></a>
</span><span id="Problem-140"><a href="#Problem-140"><span class="linenos">140</span></a><span class="sd">        Parameters</span>
</span><span id="Problem-141"><a href="#Problem-141"><span class="linenos">141</span></a><span class="sd">        ----------</span>
</span><span id="Problem-142"><a href="#Problem-142"><span class="linenos">142</span></a><span class="sd">        mesh : Mesh</span>
</span><span id="Problem-143"><a href="#Problem-143"><span class="linenos">143</span></a><span class="sd">            Surface mesh defining the geometry to be matched to the image.</span>
</span><span id="Problem-144"><a href="#Problem-144"><span class="linenos">144</span></a><span class="sd">            The mesh coordinates must be expressed in image voxel units.</span>
</span><span id="Problem-145"><a href="#Problem-145"><span class="linenos">145</span></a><span class="sd">            Any conversion from physical units (e.g. mm or m) to voxel coordinates</span>
</span><span id="Problem-146"><a href="#Problem-146"><span class="linenos">146</span></a><span class="sd">            must be performed beforehand by the user.</span>
</span><span id="Problem-147"><a href="#Problem-147"><span class="linenos">147</span></a><span class="sd">            If `ICP_init=True`, a rigid-body alignment is performed, but this</span>
</span><span id="Problem-148"><a href="#Problem-148"><span class="linenos">148</span></a><span class="sd">            does not handle unit conversion or rescaling. ICP only corrects</span>
</span><span id="Problem-149"><a href="#Problem-149"><span class="linenos">149</span></a><span class="sd">            for rotation and translation, assuming consistent units.</span>
</span><span id="Problem-150"><a href="#Problem-150"><span class="linenos">150</span></a>
</span><span id="Problem-151"><a href="#Problem-151"><span class="linenos">151</span></a><span class="sd">        image : np.ndarray[np.uint16]</span>
</span><span id="Problem-152"><a href="#Problem-152"><span class="linenos">152</span></a><span class="sd">            3D volumetric image (e.g. CT scan). The gray-level distribution is</span>
</span><span id="Problem-153"><a href="#Problem-153"><span class="linenos">153</span></a><span class="sd">            assumed to be bimodal (background / foreground).</span>
</span><span id="Problem-154"><a href="#Problem-154"><span class="linenos">154</span></a>
</span><span id="Problem-155"><a href="#Problem-155"><span class="linenos">155</span></a><span class="sd">        ICP_init : bool, optional</span>
</span><span id="Problem-156"><a href="#Problem-156"><span class="linenos">156</span></a><span class="sd">            If `True` (default), a rigid-body ICP is performed to align the mesh</span>
</span><span id="Problem-157"><a href="#Problem-157"><span class="linenos">157</span></a><span class="sd">            with the image prior to solving the VIC problem.</span>
</span><span id="Problem-158"><a href="#Problem-158"><span class="linenos">158</span></a><span class="sd">            Disable only if the mesh is already well aligned.</span>
</span><span id="Problem-159"><a href="#Problem-159"><span class="linenos">159</span></a>
</span><span id="Problem-160"><a href="#Problem-160"><span class="linenos">160</span></a><span class="sd">        reversed_normals : bool, optional</span>
</span><span id="Problem-161"><a href="#Problem-161"><span class="linenos">161</span></a><span class="sd">            If `True`, swaps the foreground/background convention in the virtual</span>
</span><span id="Problem-162"><a href="#Problem-162"><span class="linenos">162</span></a><span class="sd">            image model. Useful if the mesh normals are oriented inward instead</span>
</span><span id="Problem-163"><a href="#Problem-163"><span class="linenos">163</span></a><span class="sd">            of outward. By default, `False`.</span>
</span><span id="Problem-164"><a href="#Problem-164"><span class="linenos">164</span></a>
</span><span id="Problem-165"><a href="#Problem-165"><span class="linenos">165</span></a><span class="sd">        fg_bg : tuple[float, float] or None, optional</span>
</span><span id="Problem-166"><a href="#Problem-166"><span class="linenos">166</span></a><span class="sd">            Tuple `(fg, bg)` specifying the foreground and background gray levels.</span>
</span><span id="Problem-167"><a href="#Problem-167"><span class="linenos">167</span></a><span class="sd">            If `None` (default), these values are automatically estimated from the</span>
</span><span id="Problem-168"><a href="#Problem-168"><span class="linenos">168</span></a><span class="sd">            image.</span>
</span><span id="Problem-169"><a href="#Problem-169"><span class="linenos">169</span></a>
</span><span id="Problem-170"><a href="#Problem-170"><span class="linenos">170</span></a><span class="sd">        fg_bg_method : Literal[&quot;otsu&quot;, &quot;interp&quot;], optional</span>
</span><span id="Problem-171"><a href="#Problem-171"><span class="linenos">171</span></a><span class="sd">            Method to compute the foreground and background gray levels. `&#39;otsu&#39;`</span>
</span><span id="Problem-172"><a href="#Problem-172"><span class="linenos">172</span></a><span class="sd">            uses :func:`image_utils.otsu_threshold` to compute the gray levels based</span>
</span><span id="Problem-173"><a href="#Problem-173"><span class="linenos">173</span></a><span class="sd">            on Otsu&#39;s method. `&#39;interp&#39;` uses :func:`image_utils.interp_fg_bg` to</span>
</span><span id="Problem-174"><a href="#Problem-174"><span class="linenos">174</span></a><span class="sd">            compute the gray levels using interpolation of histogram peaks.</span>
</span><span id="Problem-175"><a href="#Problem-175"><span class="linenos">175</span></a><span class="sd">            Default is `&#39;otsu&#39;`.</span>
</span><span id="Problem-176"><a href="#Problem-176"><span class="linenos">176</span></a>
</span><span id="Problem-177"><a href="#Problem-177"><span class="linenos">177</span></a><span class="sd">        virtual_image : Callable, optional</span>
</span><span id="Problem-178"><a href="#Problem-178"><span class="linenos">178</span></a><span class="sd">            Virtual image model mapping signed distance values to gray levels.</span>
</span><span id="Problem-179"><a href="#Problem-179"><span class="linenos">179</span></a><span class="sd">            The default (`g_slide`) is suitable for sharp material/background</span>
</span><span id="Problem-180"><a href="#Problem-180"><span class="linenos">180</span></a><span class="sd">            transitions. See :func:`virtual_image.g_slide` for the function</span>
</span><span id="Problem-181"><a href="#Problem-181"><span class="linenos">181</span></a><span class="sd">            signature.</span>
</span><span id="Problem-182"><a href="#Problem-182"><span class="linenos">182</span></a>
</span><span id="Problem-183"><a href="#Problem-183"><span class="linenos">183</span></a><span class="sd">        h : float or None, optional</span>
</span><span id="Problem-184"><a href="#Problem-184"><span class="linenos">184</span></a><span class="sd">            Half-width of the search domain along surface normals.</span>
</span><span id="Problem-185"><a href="#Problem-185"><span class="linenos">185</span></a><span class="sd">            If `None` (default), `h` is automatically estimated from the image</span>
</span><span id="Problem-186"><a href="#Problem-186"><span class="linenos">186</span></a><span class="sd">            during initialization.</span>
</span><span id="Problem-187"><a href="#Problem-187"><span class="linenos">187</span></a>
</span><span id="Problem-188"><a href="#Problem-188"><span class="linenos">188</span></a><span class="sd">        width_dx : float, optional</span>
</span><span id="Problem-189"><a href="#Problem-189"><span class="linenos">189</span></a><span class="sd">            Integration step along the normal direction for image energies.</span>
</span><span id="Problem-190"><a href="#Problem-190"><span class="linenos">190</span></a>
</span><span id="Problem-191"><a href="#Problem-191"><span class="linenos">191</span></a><span class="sd">        surf_dx : float, optional</span>
</span><span id="Problem-192"><a href="#Problem-192"><span class="linenos">192</span></a><span class="sd">            Integration step along the surface for image energies.</span>
</span><span id="Problem-193"><a href="#Problem-193"><span class="linenos">193</span></a>
</span><span id="Problem-194"><a href="#Problem-194"><span class="linenos">194</span></a><span class="sd">        alpha : float or tuple, optional</span>
</span><span id="Problem-195"><a href="#Problem-195"><span class="linenos">195</span></a><span class="sd">            Tangential regularization weight used in the image energies.</span>
</span><span id="Problem-196"><a href="#Problem-196"><span class="linenos">196</span></a><span class="sd">            A value of 0.0 (default) disables tangential smoothing.</span>
</span><span id="Problem-197"><a href="#Problem-197"><span class="linenos">197</span></a>
</span><span id="Problem-198"><a href="#Problem-198"><span class="linenos">198</span></a><span class="sd">        C1_mode : {&quot;auto&quot;, &quot;none&quot;, &quot;all&quot;} or np.ndarray or None, optional</span>
</span><span id="Problem-199"><a href="#Problem-199"><span class="linenos">199</span></a><span class="sd">            Definition of CÂ¹ continuity constraints between patches:</span>
</span><span id="Problem-200"><a href="#Problem-200"><span class="linenos">200</span></a><span class="sd">                - &quot;auto&quot;: automatically selected constraints (recommended)</span>
</span><span id="Problem-201"><a href="#Problem-201"><span class="linenos">201</span></a><span class="sd">                - &quot;none&quot;: no CÂ¹ constraints</span>
</span><span id="Problem-202"><a href="#Problem-202"><span class="linenos">202</span></a><span class="sd">                - &quot;all&quot;: enforce CÂ¹ everywhere</span>
</span><span id="Problem-203"><a href="#Problem-203"><span class="linenos">203</span></a><span class="sd">                - array: user-defined triplets of constrained control points</span>
</span><span id="Problem-204"><a href="#Problem-204"><span class="linenos">204</span></a>
</span><span id="Problem-205"><a href="#Problem-205"><span class="linenos">205</span></a><span class="sd">        membrane_weight : float or None, optional</span>
</span><span id="Problem-206"><a href="#Problem-206"><span class="linenos">206</span></a><span class="sd">            Weight of the membrane (elastic) regularization term.</span>
</span><span id="Problem-207"><a href="#Problem-207"><span class="linenos">207</span></a><span class="sd">            If None (default), the weight is automatically calibrated.</span>
</span><span id="Problem-208"><a href="#Problem-208"><span class="linenos">208</span></a>
</span><span id="Problem-209"><a href="#Problem-209"><span class="linenos">209</span></a><span class="sd">        initial_rho : float, optional</span>
</span><span id="Problem-210"><a href="#Problem-210"><span class="linenos">210</span></a><span class="sd">            Initial value of the transition distance parameter used in the VIC model.</span>
</span><span id="Problem-211"><a href="#Problem-211"><span class="linenos">211</span></a>
</span><span id="Problem-212"><a href="#Problem-212"><span class="linenos">212</span></a><span class="sd">        expected_mean_dist : float, optional</span>
</span><span id="Problem-213"><a href="#Problem-213"><span class="linenos">213</span></a><span class="sd">            Expected mean distance (in image units) used for automatic membrane</span>
</span><span id="Problem-214"><a href="#Problem-214"><span class="linenos">214</span></a><span class="sd">            weight calibration.</span>
</span><span id="Problem-215"><a href="#Problem-215"><span class="linenos">215</span></a>
</span><span id="Problem-216"><a href="#Problem-216"><span class="linenos">216</span></a><span class="sd">        n_intg_membrane_weight_comput : int, optional</span>
</span><span id="Problem-217"><a href="#Problem-217"><span class="linenos">217</span></a><span class="sd">            Number of integration points used to compute the membrane weight</span>
</span><span id="Problem-218"><a href="#Problem-218"><span class="linenos">218</span></a><span class="sd">            when it is determined automatically.</span>
</span><span id="Problem-219"><a href="#Problem-219"><span class="linenos">219</span></a>
</span><span id="Problem-220"><a href="#Problem-220"><span class="linenos">220</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="Problem-221"><a href="#Problem-221"><span class="linenos">221</span></a><span class="sd">            If True, disables parallel execution (useful for debugging or</span>
</span><span id="Problem-222"><a href="#Problem-222"><span class="linenos">222</span></a><span class="sd">            reproducibility).</span>
</span><span id="Problem-223"><a href="#Problem-223"><span class="linenos">223</span></a>
</span><span id="Problem-224"><a href="#Problem-224"><span class="linenos">224</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="Problem-225"><a href="#Problem-225"><span class="linenos">225</span></a><span class="sd">            If True, prints detailed information during initialization and</span>
</span><span id="Problem-226"><a href="#Problem-226"><span class="linenos">226</span></a><span class="sd">            subsequent computations.</span>
</span><span id="Problem-227"><a href="#Problem-227"><span class="linenos">227</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem-228"><a href="#Problem-228"><span class="linenos">228</span></a>
</span><span id="Problem-229"><a href="#Problem-229"><span class="linenos">229</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-230"><a href="#Problem-230"><span class="linenos">230</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Initializing VIC problem&quot;</span><span class="p">)</span>
</span><span id="Problem-231"><a href="#Problem-231"><span class="linenos">231</span></a>
</span><span id="Problem-232"><a href="#Problem-232"><span class="linenos">232</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>
</span><span id="Problem-233"><a href="#Problem-233"><span class="linenos">233</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span>
</span><span id="Problem-234"><a href="#Problem-234"><span class="linenos">234</span></a>
</span><span id="Problem-235"><a href="#Problem-235"><span class="linenos">235</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-236"><a href="#Problem-236"><span class="linenos">236</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] Image shape: </span><span class="si">{</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, dtype: </span><span class="si">{</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem-237"><a href="#Problem-237"><span class="linenos">237</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] Mesh: </span><span class="si">{</span><span class="n">mesh</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem-238"><a href="#Problem-238"><span class="linenos">238</span></a>
</span><span id="Problem-239"><a href="#Problem-239"><span class="linenos">239</span></a>        <span class="c1"># --- Foreground / Background -------------------------------------------------</span>
</span><span id="Problem-240"><a href="#Problem-240"><span class="linenos">240</span></a>        <span class="k">if</span> <span class="n">fg_bg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Problem-241"><a href="#Problem-241"><span class="linenos">241</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-242"><a href="#Problem-242"><span class="linenos">242</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Estimating foreground/background levels from image&quot;</span><span class="p">)</span>
</span><span id="Problem-243"><a href="#Problem-243"><span class="linenos">243</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_fg_bg</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">fg_bg_method</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</span><span id="Problem-244"><a href="#Problem-244"><span class="linenos">244</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Problem-245"><a href="#Problem-245"><span class="linenos">245</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bg</span> <span class="o">=</span> <span class="n">fg_bg</span>
</span><span id="Problem-246"><a href="#Problem-246"><span class="linenos">246</span></a>
</span><span id="Problem-247"><a href="#Problem-247"><span class="linenos">247</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-248"><a href="#Problem-248"><span class="linenos">248</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] fg = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="si">}</span><span class="s2">, bg = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem-249"><a href="#Problem-249"><span class="linenos">249</span></a>
</span><span id="Problem-250"><a href="#Problem-250"><span class="linenos">250</span></a>        <span class="c1"># --- ICP + h initialization --------------------------------------------------</span>
</span><span id="Problem-251"><a href="#Problem-251"><span class="linenos">251</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-252"><a href="#Problem-252"><span class="linenos">252</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Initializing placement and research half width h&quot;</span><span class="p">)</span>
</span><span id="Problem-253"><a href="#Problem-253"><span class="linenos">253</span></a>
</span><span id="Problem-254"><a href="#Problem-254"><span class="linenos">254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Rmat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvec</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_h_mesh_ICP</span><span class="p">(</span>
</span><span id="Problem-255"><a href="#Problem-255"><span class="linenos">255</span></a>            <span class="n">ICP_init</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
</span><span id="Problem-256"><a href="#Problem-256"><span class="linenos">256</span></a>        <span class="p">)</span>
</span><span id="Problem-257"><a href="#Problem-257"><span class="linenos">257</span></a>
</span><span id="Problem-258"><a href="#Problem-258"><span class="linenos">258</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-259"><a href="#Problem-259"><span class="linenos">259</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] h = </span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem-260"><a href="#Problem-260"><span class="linenos">260</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] Rmat:</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Rmat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem-261"><a href="#Problem-261"><span class="linenos">261</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] tvec: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tvec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem-262"><a href="#Problem-262"><span class="linenos">262</span></a>
</span><span id="Problem-263"><a href="#Problem-263"><span class="linenos">263</span></a>        <span class="c1"># --- Virtual image ------------------------------------------------------------</span>
</span><span id="Problem-264"><a href="#Problem-264"><span class="linenos">264</span></a>        <span class="k">if</span> <span class="n">reversed_normals</span><span class="p">:</span>
</span><span id="Problem-265"><a href="#Problem-265"><span class="linenos">265</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-266"><a href="#Problem-266"><span class="linenos">266</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Using reversed normals for virtual image&quot;</span><span class="p">)</span>
</span><span id="Problem-267"><a href="#Problem-267"><span class="linenos">267</span></a>            <span class="n">g</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">virtual_image</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bg</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="p">)</span>
</span><span id="Problem-268"><a href="#Problem-268"><span class="linenos">268</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Problem-269"><a href="#Problem-269"><span class="linenos">269</span></a>            <span class="n">g</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">virtual_image</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bg</span><span class="p">)</span>
</span><span id="Problem-270"><a href="#Problem-270"><span class="linenos">270</span></a>
</span><span id="Problem-271"><a href="#Problem-271"><span class="linenos">271</span></a>        <span class="c1"># --- Image energies -----------------------------------------------------------</span>
</span><span id="Problem-272"><a href="#Problem-272"><span class="linenos">272</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-273"><a href="#Problem-273"><span class="linenos">273</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Building image energies&quot;</span><span class="p">)</span>
</span><span id="Problem-274"><a href="#Problem-274"><span class="linenos">274</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="Problem-275"><a href="#Problem-275"><span class="linenos">275</span></a>                <span class="sa">f</span><span class="s2">&quot;[VIC] Integration params: surf_dx=</span><span class="si">{</span><span class="n">surf_dx</span><span class="si">}</span><span class="s2">, width_dx=</span><span class="si">{</span><span class="n">width_dx</span><span class="si">}</span><span class="s2">, alpha=</span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Problem-276"><a href="#Problem-276"><span class="linenos">276</span></a>            <span class="p">)</span>
</span><span id="Problem-277"><a href="#Problem-277"><span class="linenos">277</span></a>
</span><span id="Problem-278"><a href="#Problem-278"><span class="linenos">278</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span> <span class="o">=</span> <span class="n">make_image_energies</span><span class="p">(</span>
</span><span id="Problem-279"><a href="#Problem-279"><span class="linenos">279</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
</span><span id="Problem-280"><a href="#Problem-280"><span class="linenos">280</span></a>            <span class="n">h</span><span class="p">,</span>
</span><span id="Problem-281"><a href="#Problem-281"><span class="linenos">281</span></a>            <span class="n">width_dx</span><span class="o">=</span><span class="n">width_dx</span><span class="p">,</span>
</span><span id="Problem-282"><a href="#Problem-282"><span class="linenos">282</span></a>            <span class="n">surf_dx</span><span class="o">=</span><span class="n">surf_dx</span><span class="p">,</span>
</span><span id="Problem-283"><a href="#Problem-283"><span class="linenos">283</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
</span><span id="Problem-284"><a href="#Problem-284"><span class="linenos">284</span></a>            <span class="n">virtual_image</span><span class="o">=</span><span class="n">g</span><span class="p">,</span>
</span><span id="Problem-285"><a href="#Problem-285"><span class="linenos">285</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="Problem-286"><a href="#Problem-286"><span class="linenos">286</span></a>            <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="Problem-287"><a href="#Problem-287"><span class="linenos">287</span></a>        <span class="p">)</span>
</span><span id="Problem-288"><a href="#Problem-288"><span class="linenos">288</span></a>
</span><span id="Problem-289"><a href="#Problem-289"><span class="linenos">289</span></a>        <span class="c1"># --- C1 constraints -----------------------------------------------------------</span>
</span><span id="Problem-290"><a href="#Problem-290"><span class="linenos">290</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-291"><a href="#Problem-291"><span class="linenos">291</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Building C1 constraints&quot;</span><span class="p">)</span>
</span><span id="Problem-292"><a href="#Problem-292"><span class="linenos">292</span></a>
</span><span id="Problem-293"><a href="#Problem-293"><span class="linenos">293</span></a>        <span class="n">C1_eqs</span> <span class="o">=</span> <span class="n">make_C1_eqs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">C1_mode</span><span class="p">)</span>
</span><span id="Problem-294"><a href="#Problem-294"><span class="linenos">294</span></a>
</span><span id="Problem-295"><a href="#Problem-295"><span class="linenos">295</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">DirichletConstraintHandler</span><span class="p">(</span>
</span><span id="Problem-296"><a href="#Problem-296"><span class="linenos">296</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">connectivity</span><span class="o">.</span><span class="n">nb_unique_nodes</span> <span class="o">*</span> <span class="mi">3</span>
</span><span id="Problem-297"><a href="#Problem-297"><span class="linenos">297</span></a>        <span class="p">)</span>
</span><span id="Problem-298"><a href="#Problem-298"><span class="linenos">298</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">add_eqs</span><span class="p">(</span><span class="n">C1_eqs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">C1_eqs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">))</span>
</span><span id="Problem-299"><a href="#Problem-299"><span class="linenos">299</span></a>
</span><span id="Problem-300"><a href="#Problem-300"><span class="linenos">300</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-301"><a href="#Problem-301"><span class="linenos">301</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] Number of C1 equations: </span><span class="si">{</span><span class="n">C1_eqs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem-302"><a href="#Problem-302"><span class="linenos">302</span></a>
</span><span id="Problem-303"><a href="#Problem-303"><span class="linenos">303</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dirichlet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_dirichlet</span><span class="p">()</span>
</span><span id="Problem-304"><a href="#Problem-304"><span class="linenos">304</span></a>
</span><span id="Problem-305"><a href="#Problem-305"><span class="linenos">305</span></a>        <span class="c1"># --- Membrane stiffness -------------------------------------------------------</span>
</span><span id="Problem-306"><a href="#Problem-306"><span class="linenos">306</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-307"><a href="#Problem-307"><span class="linenos">307</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Assembling membrane stiffness matrix&quot;</span><span class="p">)</span>
</span><span id="Problem-308"><a href="#Problem-308"><span class="linenos">308</span></a>
</span><span id="Problem-309"><a href="#Problem-309"><span class="linenos">309</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">membrane_K</span> <span class="o">=</span> <span class="n">make_membrane_stifness</span><span class="p">(</span>
</span><span id="Problem-310"><a href="#Problem-310"><span class="linenos">310</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span>
</span><span id="Problem-311"><a href="#Problem-311"><span class="linenos">311</span></a>        <span class="p">)</span>
</span><span id="Problem-312"><a href="#Problem-312"><span class="linenos">312</span></a>
</span><span id="Problem-313"><a href="#Problem-313"><span class="linenos">313</span></a>        <span class="c1"># --- Membrane weight ----------------------------------------------------------</span>
</span><span id="Problem-314"><a href="#Problem-314"><span class="linenos">314</span></a>        <span class="k">if</span> <span class="n">membrane_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Problem-315"><a href="#Problem-315"><span class="linenos">315</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-316"><a href="#Problem-316"><span class="linenos">316</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Computing membrane weight automatically&quot;</span><span class="p">)</span>
</span><span id="Problem-317"><a href="#Problem-317"><span class="linenos">317</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="Problem-318"><a href="#Problem-318"><span class="linenos">318</span></a>                    <span class="sa">f</span><span class="s2">&quot;[VIC] initial_rho=</span><span class="si">{</span><span class="n">initial_rho</span><span class="si">}</span><span class="s2">, expected_mean_dist=</span><span class="si">{</span><span class="n">expected_mean_dist</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Problem-319"><a href="#Problem-319"><span class="linenos">319</span></a>                <span class="p">)</span>
</span><span id="Problem-320"><a href="#Problem-320"><span class="linenos">320</span></a>
</span><span id="Problem-321"><a href="#Problem-321"><span class="linenos">321</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">make_membrane_weight</span><span class="p">(</span>
</span><span id="Problem-322"><a href="#Problem-322"><span class="linenos">322</span></a>                <span class="n">initial_rho</span><span class="p">,</span>
</span><span id="Problem-323"><a href="#Problem-323"><span class="linenos">323</span></a>                <span class="n">expected_mean_dist</span><span class="o">=</span><span class="n">expected_mean_dist</span><span class="p">,</span>
</span><span id="Problem-324"><a href="#Problem-324"><span class="linenos">324</span></a>                <span class="n">n_intg</span><span class="o">=</span><span class="n">n_intg_membrane_weight_comput</span><span class="p">,</span>
</span><span id="Problem-325"><a href="#Problem-325"><span class="linenos">325</span></a>            <span class="p">)</span>
</span><span id="Problem-326"><a href="#Problem-326"><span class="linenos">326</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-327"><a href="#Problem-327"><span class="linenos">327</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] Computed membrane weight : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">membrane_weight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem-328"><a href="#Problem-328"><span class="linenos">328</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Problem-329"><a href="#Problem-329"><span class="linenos">329</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">membrane_weight</span> <span class="o">=</span> <span class="n">membrane_weight</span>
</span><span id="Problem-330"><a href="#Problem-330"><span class="linenos">330</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-331"><a href="#Problem-331"><span class="linenos">331</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] Using user-defined membrane_weight = </span><span class="si">{</span><span class="n">membrane_weight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem-332"><a href="#Problem-332"><span class="linenos">332</span></a>
</span><span id="Problem-333"><a href="#Problem-333"><span class="linenos">333</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">initial_rho</span> <span class="o">=</span> <span class="n">initial_rho</span>
</span><span id="Problem-334"><a href="#Problem-334"><span class="linenos">334</span></a>
</span><span id="Problem-335"><a href="#Problem-335"><span class="linenos">335</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
</span><span id="Problem-336"><a href="#Problem-336"><span class="linenos">336</span></a>            <span class="nb">float</span>
</span><span id="Problem-337"><a href="#Problem-337"><span class="linenos">337</span></a>        <span class="p">)</span>  <span class="c1"># TODO remove casting by adapting interpolation</span>
</span><span id="Problem-338"><a href="#Problem-338"><span class="linenos">338</span></a>
</span><span id="Problem-339"><a href="#Problem-339"><span class="linenos">339</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-340"><a href="#Problem-340"><span class="linenos">340</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Initialization done â&quot;</span><span class="p">)</span>
</span><span id="Problem-341"><a href="#Problem-341"><span class="linenos">341</span></a>
</span><span id="Problem-342"><a href="#Problem-342"><span class="linenos">342</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_fg_bg</span><span class="p">(</span>
</span><span id="Problem-343"><a href="#Problem-343"><span class="linenos">343</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;otsu&quot;</span><span class="p">,</span> <span class="s2">&quot;interp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;otsu&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Problem-344"><a href="#Problem-344"><span class="linenos">344</span></a>    <span class="p">):</span>
</span><span id="Problem-345"><a href="#Problem-345"><span class="linenos">345</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem-346"><a href="#Problem-346"><span class="linenos">346</span></a><span class="sd">        Estimate foreground and background gray levels from the input image.</span>
</span><span id="Problem-347"><a href="#Problem-347"><span class="linenos">347</span></a>
</span><span id="Problem-348"><a href="#Problem-348"><span class="linenos">348</span></a><span class="sd">        This method analyzes the gray-level distribution of the volumetric image</span>
</span><span id="Problem-349"><a href="#Problem-349"><span class="linenos">349</span></a><span class="sd">        and returns representative foreground (`fg`) and background (`bg`) values.</span>
</span><span id="Problem-350"><a href="#Problem-350"><span class="linenos">350</span></a><span class="sd">        These values are used by the virtual image model to map signed distances</span>
</span><span id="Problem-351"><a href="#Problem-351"><span class="linenos">351</span></a><span class="sd">        to gray levels in the VIC formulation.</span>
</span><span id="Problem-352"><a href="#Problem-352"><span class="linenos">352</span></a>
</span><span id="Problem-353"><a href="#Problem-353"><span class="linenos">353</span></a><span class="sd">        Parameters</span>
</span><span id="Problem-354"><a href="#Problem-354"><span class="linenos">354</span></a><span class="sd">        ----------</span>
</span><span id="Problem-355"><a href="#Problem-355"><span class="linenos">355</span></a><span class="sd">        method : Literal[&quot;otsu&quot;, &quot;interp&quot;], optional</span>
</span><span id="Problem-356"><a href="#Problem-356"><span class="linenos">356</span></a><span class="sd">            Strategy used to estimate foreground and background levels:</span>
</span><span id="Problem-357"><a href="#Problem-357"><span class="linenos">357</span></a><span class="sd">                - &quot;otsu&quot;: threshold-based estimation using Otsu&#39;s method.</span>
</span><span id="Problem-358"><a href="#Problem-358"><span class="linenos">358</span></a><span class="sd">                - &quot;interp&quot;: estimation based on interpolation of histogram peaks.</span>
</span><span id="Problem-359"><a href="#Problem-359"><span class="linenos">359</span></a><span class="sd">            Default is &quot;otsu&quot;.</span>
</span><span id="Problem-360"><a href="#Problem-360"><span class="linenos">360</span></a>
</span><span id="Problem-361"><a href="#Problem-361"><span class="linenos">361</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="Problem-362"><a href="#Problem-362"><span class="linenos">362</span></a><span class="sd">            If True, prints diagnostic information during the estimation process.</span>
</span><span id="Problem-363"><a href="#Problem-363"><span class="linenos">363</span></a>
</span><span id="Problem-364"><a href="#Problem-364"><span class="linenos">364</span></a><span class="sd">        Returns</span>
</span><span id="Problem-365"><a href="#Problem-365"><span class="linenos">365</span></a><span class="sd">        -------</span>
</span><span id="Problem-366"><a href="#Problem-366"><span class="linenos">366</span></a><span class="sd">        fg : float</span>
</span><span id="Problem-367"><a href="#Problem-367"><span class="linenos">367</span></a><span class="sd">            Estimated foreground gray level.</span>
</span><span id="Problem-368"><a href="#Problem-368"><span class="linenos">368</span></a>
</span><span id="Problem-369"><a href="#Problem-369"><span class="linenos">369</span></a><span class="sd">        bg : float</span>
</span><span id="Problem-370"><a href="#Problem-370"><span class="linenos">370</span></a><span class="sd">            Estimated background gray level.</span>
</span><span id="Problem-371"><a href="#Problem-371"><span class="linenos">371</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem-372"><a href="#Problem-372"><span class="linenos">372</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-373"><a href="#Problem-373"><span class="linenos">373</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC][FG/BG] method=</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem-374"><a href="#Problem-374"><span class="linenos">374</span></a>        <span class="n">fg</span><span class="p">,</span> <span class="n">bg</span> <span class="o">=</span> <span class="n">find_fg_bg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">save_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="Problem-375"><a href="#Problem-375"><span class="linenos">375</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-376"><a href="#Problem-376"><span class="linenos">376</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC][FG/BG] fg=</span><span class="si">{</span><span class="n">fg</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, bg=</span><span class="si">{</span><span class="n">bg</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem-377"><a href="#Problem-377"><span class="linenos">377</span></a>        <span class="k">return</span> <span class="n">fg</span><span class="p">,</span> <span class="n">bg</span>
</span><span id="Problem-378"><a href="#Problem-378"><span class="linenos">378</span></a>
</span><span id="Problem-379"><a href="#Problem-379"><span class="linenos">379</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_h_mesh_ICP</span><span class="p">(</span>
</span><span id="Problem-380"><a href="#Problem-380"><span class="linenos">380</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Problem-381"><a href="#Problem-381"><span class="linenos">381</span></a>        <span class="n">ICP_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem-382"><a href="#Problem-382"><span class="linenos">382</span></a>        <span class="n">h</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem-383"><a href="#Problem-383"><span class="linenos">383</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Problem-384"><a href="#Problem-384"><span class="linenos">384</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem-385"><a href="#Problem-385"><span class="linenos">385</span></a>    <span class="p">):</span>
</span><span id="Problem-386"><a href="#Problem-386"><span class="linenos">386</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem-387"><a href="#Problem-387"><span class="linenos">387</span></a><span class="sd">        Initialize the mesh placement and the normal search half-width `h`.</span>
</span><span id="Problem-388"><a href="#Problem-388"><span class="linenos">388</span></a>
</span><span id="Problem-389"><a href="#Problem-389"><span class="linenos">389</span></a><span class="sd">        This method optionally performs a rigid-body Iterative Closest Point (ICP)</span>
</span><span id="Problem-390"><a href="#Problem-390"><span class="linenos">390</span></a><span class="sd">        alignment between the surface mesh and an isosurface extracted from the</span>
</span><span id="Problem-391"><a href="#Problem-391"><span class="linenos">391</span></a><span class="sd">        image. It also initializes the normal search half-width `h`, which</span>
</span><span id="Problem-392"><a href="#Problem-392"><span class="linenos">392</span></a><span class="sd">        defines the integration domain along surface normals for the image</span>
</span><span id="Problem-393"><a href="#Problem-393"><span class="linenos">393</span></a><span class="sd">        correlation energies.</span>
</span><span id="Problem-394"><a href="#Problem-394"><span class="linenos">394</span></a>
</span><span id="Problem-395"><a href="#Problem-395"><span class="linenos">395</span></a><span class="sd">        The isosurface is obtained using a marching-cubes extraction at the</span>
</span><span id="Problem-396"><a href="#Problem-396"><span class="linenos">396</span></a><span class="sd">        mid-gray level between the estimated foreground and background values.</span>
</span><span id="Problem-397"><a href="#Problem-397"><span class="linenos">397</span></a>
</span><span id="Problem-398"><a href="#Problem-398"><span class="linenos">398</span></a><span class="sd">        Behavior depends on the input parameters:</span>
</span><span id="Problem-399"><a href="#Problem-399"><span class="linenos">399</span></a><span class="sd">            - If `ICP_init=True`, a rigid-body ICP alignment is performed and</span>
</span><span id="Problem-400"><a href="#Problem-400"><span class="linenos">400</span></a><span class="sd">              the resulting rotation matrix and translation vector are returned.</span>
</span><span id="Problem-401"><a href="#Problem-401"><span class="linenos">401</span></a><span class="sd">            - If `h` is `None`, the value of `h` is automatically estimated</span>
</span><span id="Problem-402"><a href="#Problem-402"><span class="linenos">402</span></a><span class="sd">              from the maximum distance between the mesh and the extracted</span>
</span><span id="Problem-403"><a href="#Problem-403"><span class="linenos">403</span></a><span class="sd">              isosurface.</span>
</span><span id="Problem-404"><a href="#Problem-404"><span class="linenos">404</span></a><span class="sd">            - If `ICP_init=False` and `h` is provided, no alignment is</span>
</span><span id="Problem-405"><a href="#Problem-405"><span class="linenos">405</span></a><span class="sd">              performed and `h` is left unchanged.</span>
</span><span id="Problem-406"><a href="#Problem-406"><span class="linenos">406</span></a>
</span><span id="Problem-407"><a href="#Problem-407"><span class="linenos">407</span></a><span class="sd">        Parameters</span>
</span><span id="Problem-408"><a href="#Problem-408"><span class="linenos">408</span></a><span class="sd">        ----------</span>
</span><span id="Problem-409"><a href="#Problem-409"><span class="linenos">409</span></a><span class="sd">        ICP_init : bool, optional</span>
</span><span id="Problem-410"><a href="#Problem-410"><span class="linenos">410</span></a><span class="sd">            If `True` (default), performs a rigid-body ICP alignment between the</span>
</span><span id="Problem-411"><a href="#Problem-411"><span class="linenos">411</span></a><span class="sd">            mesh and the image-derived isosurface.</span>
</span><span id="Problem-412"><a href="#Problem-412"><span class="linenos">412</span></a>
</span><span id="Problem-413"><a href="#Problem-413"><span class="linenos">413</span></a><span class="sd">        h : float or None, optional</span>
</span><span id="Problem-414"><a href="#Problem-414"><span class="linenos">414</span></a><span class="sd">            Normal search half-width used in image energy integration.</span>
</span><span id="Problem-415"><a href="#Problem-415"><span class="linenos">415</span></a><span class="sd">            If `None` (default), `h` is automatically estimated from the maximum</span>
</span><span id="Problem-416"><a href="#Problem-416"><span class="linenos">416</span></a><span class="sd">            mesh-to-image distance.</span>
</span><span id="Problem-417"><a href="#Problem-417"><span class="linenos">417</span></a>
</span><span id="Problem-418"><a href="#Problem-418"><span class="linenos">418</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="Problem-419"><a href="#Problem-419"><span class="linenos">419</span></a><span class="sd">            If `True`, disables parallel execution during ICP and distance-field</span>
</span><span id="Problem-420"><a href="#Problem-420"><span class="linenos">420</span></a><span class="sd">            computations. By default, `False`.</span>
</span><span id="Problem-421"><a href="#Problem-421"><span class="linenos">421</span></a>
</span><span id="Problem-422"><a href="#Problem-422"><span class="linenos">422</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="Problem-423"><a href="#Problem-423"><span class="linenos">423</span></a><span class="sd">            If `True`, prints diagnostic information during initialization.</span>
</span><span id="Problem-424"><a href="#Problem-424"><span class="linenos">424</span></a><span class="sd">            By default, `True`.</span>
</span><span id="Problem-425"><a href="#Problem-425"><span class="linenos">425</span></a>
</span><span id="Problem-426"><a href="#Problem-426"><span class="linenos">426</span></a><span class="sd">        Returns</span>
</span><span id="Problem-427"><a href="#Problem-427"><span class="linenos">427</span></a><span class="sd">        -------</span>
</span><span id="Problem-428"><a href="#Problem-428"><span class="linenos">428</span></a><span class="sd">        Rmat : np.ndarray</span>
</span><span id="Problem-429"><a href="#Problem-429"><span class="linenos">429</span></a><span class="sd">            3x3 rotation matrix resulting from the ICP alignment.</span>
</span><span id="Problem-430"><a href="#Problem-430"><span class="linenos">430</span></a><span class="sd">            Identity if no ICP is performed.</span>
</span><span id="Problem-431"><a href="#Problem-431"><span class="linenos">431</span></a>
</span><span id="Problem-432"><a href="#Problem-432"><span class="linenos">432</span></a><span class="sd">        tvec : np.ndarray</span>
</span><span id="Problem-433"><a href="#Problem-433"><span class="linenos">433</span></a><span class="sd">            Translation vector resulting from the ICP alignment.</span>
</span><span id="Problem-434"><a href="#Problem-434"><span class="linenos">434</span></a><span class="sd">            Zero vector if no ICP is performed.</span>
</span><span id="Problem-435"><a href="#Problem-435"><span class="linenos">435</span></a>
</span><span id="Problem-436"><a href="#Problem-436"><span class="linenos">436</span></a><span class="sd">        h : float</span>
</span><span id="Problem-437"><a href="#Problem-437"><span class="linenos">437</span></a><span class="sd">            Initialized normal search half-width.</span>
</span><span id="Problem-438"><a href="#Problem-438"><span class="linenos">438</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem-439"><a href="#Problem-439"><span class="linenos">439</span></a>        <span class="n">compute_h</span> <span class="o">=</span> <span class="n">h</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="Problem-440"><a href="#Problem-440"><span class="linenos">440</span></a>        <span class="k">if</span> <span class="n">ICP_init</span> <span class="ow">or</span> <span class="n">compute_h</span><span class="p">:</span>
</span><span id="Problem-441"><a href="#Problem-441"><span class="linenos">441</span></a>            <span class="n">stl_mc</span> <span class="o">=</span> <span class="n">marching_cubes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bg</span><span class="p">))</span>
</span><span id="Problem-442"><a href="#Problem-442"><span class="linenos">442</span></a>            <span class="k">if</span> <span class="n">ICP_init</span><span class="p">:</span>
</span><span id="Problem-443"><a href="#Problem-443"><span class="linenos">443</span></a>                <span class="n">Rmat</span><span class="p">,</span> <span class="n">tvec</span><span class="p">,</span> <span class="n">max_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">ICP_rigid_body_transform</span><span class="p">(</span>
</span><span id="Problem-444"><a href="#Problem-444"><span class="linenos">444</span></a>                    <span class="n">stl_mc</span><span class="p">,</span> <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span> <span class="n">plot_after</span><span class="o">=</span><span class="n">verbose</span>
</span><span id="Problem-445"><a href="#Problem-445"><span class="linenos">445</span></a>                <span class="p">)</span>
</span><span id="Problem-446"><a href="#Problem-446"><span class="linenos">446</span></a>                <span class="k">if</span> <span class="n">compute_h</span><span class="p">:</span>
</span><span id="Problem-447"><a href="#Problem-447"><span class="linenos">447</span></a>                    <span class="n">h</span> <span class="o">=</span> <span class="n">max_dist</span> <span class="o">+</span> <span class="mf">1.0</span>
</span><span id="Problem-448"><a href="#Problem-448"><span class="linenos">448</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-449"><a href="#Problem-449"><span class="linenos">449</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] ICP done | max_dist=</span><span class="si">{</span><span class="n">max_dist</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">, h=</span><span class="si">{</span><span class="n">h</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem-450"><a href="#Problem-450"><span class="linenos">450</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Problem-451"><a href="#Problem-451"><span class="linenos">451</span></a>                <span class="n">Rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="Problem-452"><a href="#Problem-452"><span class="linenos">452</span></a>                <span class="n">tvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="Problem-453"><a href="#Problem-453"><span class="linenos">453</span></a>                <span class="k">if</span> <span class="n">compute_h</span><span class="p">:</span>
</span><span id="Problem-454"><a href="#Problem-454"><span class="linenos">454</span></a>                    <span class="n">distance_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">distance_to_meshio</span><span class="p">(</span><span class="n">stl_mc</span><span class="p">)</span>
</span><span id="Problem-455"><a href="#Problem-455"><span class="linenos">455</span></a>                    <span class="n">max_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
</span><span id="Problem-456"><a href="#Problem-456"><span class="linenos">456</span></a>                        <span class="n">distance_mesh</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s2">&quot;implicit_distance&quot;</span><span class="p">]</span>
</span><span id="Problem-457"><a href="#Problem-457"><span class="linenos">457</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="Problem-458"><a href="#Problem-458"><span class="linenos">458</span></a>                    <span class="n">h</span> <span class="o">=</span> <span class="n">max_dist</span> <span class="o">+</span> <span class="mf">1.0</span>
</span><span id="Problem-459"><a href="#Problem-459"><span class="linenos">459</span></a>                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-460"><a href="#Problem-460"><span class="linenos">460</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="Problem-461"><a href="#Problem-461"><span class="linenos">461</span></a>                            <span class="sa">f</span><span class="s2">&quot;[VIC] h from distance field | max_dist=</span><span class="si">{</span><span class="n">max_dist</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">, h=</span><span class="si">{</span><span class="n">h</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Problem-462"><a href="#Problem-462"><span class="linenos">462</span></a>                        <span class="p">)</span>
</span><span id="Problem-463"><a href="#Problem-463"><span class="linenos">463</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Problem-464"><a href="#Problem-464"><span class="linenos">464</span></a>            <span class="n">Rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="Problem-465"><a href="#Problem-465"><span class="linenos">465</span></a>            <span class="n">tvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="Problem-466"><a href="#Problem-466"><span class="linenos">466</span></a>        <span class="k">return</span> <span class="n">Rmat</span><span class="p">,</span> <span class="n">tvec</span><span class="p">,</span> <span class="n">h</span>
</span><span id="Problem-467"><a href="#Problem-467"><span class="linenos">467</span></a>
</span><span id="Problem-468"><a href="#Problem-468"><span class="linenos">468</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">make_membrane_weight</span><span class="p">(</span>
</span><span id="Problem-469"><a href="#Problem-469"><span class="linenos">469</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Problem-470"><a href="#Problem-470"><span class="linenos">470</span></a>        <span class="n">rho</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem-471"><a href="#Problem-471"><span class="linenos">471</span></a>        <span class="n">expected_mean_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
</span><span id="Problem-472"><a href="#Problem-472"><span class="linenos">472</span></a>        <span class="n">n_intg</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
</span><span id="Problem-473"><a href="#Problem-473"><span class="linenos">473</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Problem-474"><a href="#Problem-474"><span class="linenos">474</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem-475"><a href="#Problem-475"><span class="linenos">475</span></a><span class="sd">        Compute and set the membrane regularization weight.</span>
</span><span id="Problem-476"><a href="#Problem-476"><span class="linenos">476</span></a>
</span><span id="Problem-477"><a href="#Problem-477"><span class="linenos">477</span></a><span class="sd">        This method computes the weight associated with the membrane (elastic)</span>
</span><span id="Problem-478"><a href="#Problem-478"><span class="linenos">478</span></a><span class="sd">        regularization term based on the current problem configuration and image</span>
</span><span id="Problem-479"><a href="#Problem-479"><span class="linenos">479</span></a><span class="sd">        statistics. The weight is calibrated such that the regularization term</span>
</span><span id="Problem-480"><a href="#Problem-480"><span class="linenos">480</span></a><span class="sd">        is consistent with the expected image-to-surface distance scale.</span>
</span><span id="Problem-481"><a href="#Problem-481"><span class="linenos">481</span></a>
</span><span id="Problem-482"><a href="#Problem-482"><span class="linenos">482</span></a><span class="sd">        The actual computation is delegated to</span>
</span><span id="Problem-483"><a href="#Problem-483"><span class="linenos">483</span></a><span class="sd">        :func:`volVIC.membrane_stiffness.make_membrane_weight`.</span>
</span><span id="Problem-484"><a href="#Problem-484"><span class="linenos">484</span></a>
</span><span id="Problem-485"><a href="#Problem-485"><span class="linenos">485</span></a><span class="sd">        Parameters</span>
</span><span id="Problem-486"><a href="#Problem-486"><span class="linenos">486</span></a><span class="sd">        ----------</span>
</span><span id="Problem-487"><a href="#Problem-487"><span class="linenos">487</span></a><span class="sd">        rho : float or None, optional</span>
</span><span id="Problem-488"><a href="#Problem-488"><span class="linenos">488</span></a><span class="sd">            Value of the transition distance parameter used in the VIC</span>
</span><span id="Problem-489"><a href="#Problem-489"><span class="linenos">489</span></a><span class="sd">            model. If `None` (default), `self.initial_rho` is used.</span>
</span><span id="Problem-490"><a href="#Problem-490"><span class="linenos">490</span></a>
</span><span id="Problem-491"><a href="#Problem-491"><span class="linenos">491</span></a><span class="sd">        expected_mean_dist : float, optional</span>
</span><span id="Problem-492"><a href="#Problem-492"><span class="linenos">492</span></a><span class="sd">            Expected mean signed distance (in image units) between the surface</span>
</span><span id="Problem-493"><a href="#Problem-493"><span class="linenos">493</span></a><span class="sd">            and the image features. This value is used to calibrate the membrane</span>
</span><span id="Problem-494"><a href="#Problem-494"><span class="linenos">494</span></a><span class="sd">            weight. Default is `5.0`.</span>
</span><span id="Problem-495"><a href="#Problem-495"><span class="linenos">495</span></a>
</span><span id="Problem-496"><a href="#Problem-496"><span class="linenos">496</span></a><span class="sd">        n_intg : int, optional</span>
</span><span id="Problem-497"><a href="#Problem-497"><span class="linenos">497</span></a><span class="sd">            Number of integration points used to estimate the membrane weight.</span>
</span><span id="Problem-498"><a href="#Problem-498"><span class="linenos">498</span></a><span class="sd">            Higher values improve accuracy at the cost of additional computation.</span>
</span><span id="Problem-499"><a href="#Problem-499"><span class="linenos">499</span></a><span class="sd">            Default is `100`.</span>
</span><span id="Problem-500"><a href="#Problem-500"><span class="linenos">500</span></a>
</span><span id="Problem-501"><a href="#Problem-501"><span class="linenos">501</span></a><span class="sd">        Returns</span>
</span><span id="Problem-502"><a href="#Problem-502"><span class="linenos">502</span></a><span class="sd">        -------</span>
</span><span id="Problem-503"><a href="#Problem-503"><span class="linenos">503</span></a><span class="sd">        float</span>
</span><span id="Problem-504"><a href="#Problem-504"><span class="linenos">504</span></a><span class="sd">            Computed membrane regularization weight.</span>
</span><span id="Problem-505"><a href="#Problem-505"><span class="linenos">505</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem-506"><a href="#Problem-506"><span class="linenos">506</span></a>        <span class="k">if</span> <span class="n">rho</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Problem-507"><a href="#Problem-507"><span class="linenos">507</span></a>            <span class="n">rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_rho</span>
</span><span id="Problem-508"><a href="#Problem-508"><span class="linenos">508</span></a>        <span class="n">image_std</span> <span class="o">=</span> <span class="n">find_sigma_hat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bg</span><span class="p">)</span>
</span><span id="Problem-509"><a href="#Problem-509"><span class="linenos">509</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">membrane_weight</span> <span class="o">=</span> <span class="n">make_membrane_weight</span><span class="p">(</span>
</span><span id="Problem-510"><a href="#Problem-510"><span class="linenos">510</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
</span><span id="Problem-511"><a href="#Problem-511"><span class="linenos">511</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">,</span>
</span><span id="Problem-512"><a href="#Problem-512"><span class="linenos">512</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">membrane_K</span><span class="p">,</span>
</span><span id="Problem-513"><a href="#Problem-513"><span class="linenos">513</span></a>            <span class="n">rho</span><span class="o">=</span><span class="n">rho</span><span class="p">,</span>
</span><span id="Problem-514"><a href="#Problem-514"><span class="linenos">514</span></a>            <span class="n">image_std</span><span class="o">=</span><span class="n">image_std</span><span class="p">,</span>
</span><span id="Problem-515"><a href="#Problem-515"><span class="linenos">515</span></a>            <span class="n">expected_mean_dist</span><span class="o">=</span><span class="n">expected_mean_dist</span><span class="p">,</span>
</span><span id="Problem-516"><a href="#Problem-516"><span class="linenos">516</span></a>            <span class="n">n_intg</span><span class="o">=</span><span class="n">n_intg</span><span class="p">,</span>
</span><span id="Problem-517"><a href="#Problem-517"><span class="linenos">517</span></a>        <span class="p">)</span>
</span><span id="Problem-518"><a href="#Problem-518"><span class="linenos">518</span></a>
</span><span id="Problem-519"><a href="#Problem-519"><span class="linenos">519</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">make_dirichlet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Problem-520"><a href="#Problem-520"><span class="linenos">520</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem-521"><a href="#Problem-521"><span class="linenos">521</span></a><span class="sd">        Build the reduced-DOF Dirichlet representation from linear constraints.</span>
</span><span id="Problem-522"><a href="#Problem-522"><span class="linenos">522</span></a>
</span><span id="Problem-523"><a href="#Problem-523"><span class="linenos">523</span></a><span class="sd">        The object `self.constraints` stores linear equality constraints of</span>
</span><span id="Problem-524"><a href="#Problem-524"><span class="linenos">524</span></a><span class="sd">        the form `D @ u = c`. This method converts this representation into a</span>
</span><span id="Problem-525"><a href="#Problem-525"><span class="linenos">525</span></a><span class="sd">        reduced-DOF Dirichlet mapping of the form</span>
</span><span id="Problem-526"><a href="#Problem-526"><span class="linenos">526</span></a>
</span><span id="Problem-527"><a href="#Problem-527"><span class="linenos">527</span></a><span class="sd">            u = C @ dof + k ,</span>
</span><span id="Problem-528"><a href="#Problem-528"><span class="linenos">528</span></a>
</span><span id="Problem-529"><a href="#Problem-529"><span class="linenos">529</span></a><span class="sd">        where `C` is a basis of the null space of `D` (`D @ C = 0`) and</span>
</span><span id="Problem-530"><a href="#Problem-530"><span class="linenos">530</span></a><span class="sd">        `k` is a particular solution satisfying `D @ k = c`.</span>
</span><span id="Problem-531"><a href="#Problem-531"><span class="linenos">531</span></a>
</span><span id="Problem-532"><a href="#Problem-532"><span class="linenos">532</span></a><span class="sd">        The resulting mapping is stored in `self.dirichlet` and is used to</span>
</span><span id="Problem-533"><a href="#Problem-533"><span class="linenos">533</span></a><span class="sd">        eliminate constrained degrees of freedom in the solver.</span>
</span><span id="Problem-534"><a href="#Problem-534"><span class="linenos">534</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem-535"><a href="#Problem-535"><span class="linenos">535</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dirichlet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">create_dirichlet</span><span class="p">()</span>
</span><span id="Problem-536"><a href="#Problem-536"><span class="linenos">536</span></a>
</span><span id="Problem-537"><a href="#Problem-537"><span class="linenos">537</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">one_gauss_newton_iter</span><span class="p">(</span>
</span><span id="Problem-538"><a href="#Problem-538"><span class="linenos">538</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Problem-539"><a href="#Problem-539"><span class="linenos">539</span></a>        <span class="n">u_field</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
</span><span id="Problem-540"><a href="#Problem-540"><span class="linenos">540</span></a>        <span class="n">rho</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="Problem-541"><a href="#Problem-541"><span class="linenos">541</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem-542"><a href="#Problem-542"><span class="linenos">542</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Problem-543"><a href="#Problem-543"><span class="linenos">543</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="n">sps</span><span class="o">.</span><span class="n">spmatrix</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Problem-544"><a href="#Problem-544"><span class="linenos">544</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem-545"><a href="#Problem-545"><span class="linenos">545</span></a><span class="sd">        Perform a single Gauss-Newton iteration for the VIC problem.</span>
</span><span id="Problem-546"><a href="#Problem-546"><span class="linenos">546</span></a>
</span><span id="Problem-547"><a href="#Problem-547"><span class="linenos">547</span></a><span class="sd">        This method updates the displacement field and the transition distance</span>
</span><span id="Problem-548"><a href="#Problem-548"><span class="linenos">548</span></a><span class="sd">        parameter `rho` by computing the incremental corrections using the</span>
</span><span id="Problem-549"><a href="#Problem-549"><span class="linenos">549</span></a><span class="sd">        Gauss-Newton scheme. The actual computation is performed by</span>
</span><span id="Problem-550"><a href="#Problem-550"><span class="linenos">550</span></a><span class="sd">        :func:`volVIC.solve.iteration`.</span>
</span><span id="Problem-551"><a href="#Problem-551"><span class="linenos">551</span></a>
</span><span id="Problem-552"><a href="#Problem-552"><span class="linenos">552</span></a><span class="sd">        Parameters</span>
</span><span id="Problem-553"><a href="#Problem-553"><span class="linenos">553</span></a><span class="sd">        ----------</span>
</span><span id="Problem-554"><a href="#Problem-554"><span class="linenos">554</span></a><span class="sd">        u_field : np.ndarray</span>
</span><span id="Problem-555"><a href="#Problem-555"><span class="linenos">555</span></a><span class="sd">            Current displacement field of the mesh nodes, shape (3, N).</span>
</span><span id="Problem-556"><a href="#Problem-556"><span class="linenos">556</span></a>
</span><span id="Problem-557"><a href="#Problem-557"><span class="linenos">557</span></a><span class="sd">        rho : float</span>
</span><span id="Problem-558"><a href="#Problem-558"><span class="linenos">558</span></a><span class="sd">            Current value of the transition distance parameter used in the VIC model.</span>
</span><span id="Problem-559"><a href="#Problem-559"><span class="linenos">559</span></a>
</span><span id="Problem-560"><a href="#Problem-560"><span class="linenos">560</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="Problem-561"><a href="#Problem-561"><span class="linenos">561</span></a><span class="sd">            If `True`, prints diagnostic information during the iteration.</span>
</span><span id="Problem-562"><a href="#Problem-562"><span class="linenos">562</span></a><span class="sd">            By default, `True`.</span>
</span><span id="Problem-563"><a href="#Problem-563"><span class="linenos">563</span></a>
</span><span id="Problem-564"><a href="#Problem-564"><span class="linenos">564</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="Problem-565"><a href="#Problem-565"><span class="linenos">565</span></a><span class="sd">            If `True`, disables parallel execution during the iteration.</span>
</span><span id="Problem-566"><a href="#Problem-566"><span class="linenos">566</span></a><span class="sd">            By default, `False`.</span>
</span><span id="Problem-567"><a href="#Problem-567"><span class="linenos">567</span></a>
</span><span id="Problem-568"><a href="#Problem-568"><span class="linenos">568</span></a><span class="sd">        Returns</span>
</span><span id="Problem-569"><a href="#Problem-569"><span class="linenos">569</span></a><span class="sd">        -------</span>
</span><span id="Problem-570"><a href="#Problem-570"><span class="linenos">570</span></a><span class="sd">        du_field : np.ndarray</span>
</span><span id="Problem-571"><a href="#Problem-571"><span class="linenos">571</span></a><span class="sd">            Incremental displacement field computed during this iteration.</span>
</span><span id="Problem-572"><a href="#Problem-572"><span class="linenos">572</span></a>
</span><span id="Problem-573"><a href="#Problem-573"><span class="linenos">573</span></a><span class="sd">        drho : float</span>
</span><span id="Problem-574"><a href="#Problem-574"><span class="linenos">574</span></a><span class="sd">            Incremental update of the transition distance parameter `rho`.</span>
</span><span id="Problem-575"><a href="#Problem-575"><span class="linenos">575</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem-576"><a href="#Problem-576"><span class="linenos">576</span></a>        <span class="n">du_field</span><span class="p">,</span> <span class="n">drho</span> <span class="o">=</span> <span class="n">iteration</span><span class="p">(</span>
</span><span id="Problem-577"><a href="#Problem-577"><span class="linenos">577</span></a>            <span class="n">u_field</span><span class="p">,</span>
</span><span id="Problem-578"><a href="#Problem-578"><span class="linenos">578</span></a>            <span class="n">rho</span><span class="p">,</span>
</span><span id="Problem-579"><a href="#Problem-579"><span class="linenos">579</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
</span><span id="Problem-580"><a href="#Problem-580"><span class="linenos">580</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">,</span>
</span><span id="Problem-581"><a href="#Problem-581"><span class="linenos">581</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span>
</span><span id="Problem-582"><a href="#Problem-582"><span class="linenos">582</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">membrane_K</span><span class="p">,</span>
</span><span id="Problem-583"><a href="#Problem-583"><span class="linenos">583</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">membrane_weight</span><span class="p">,</span>
</span><span id="Problem-584"><a href="#Problem-584"><span class="linenos">584</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dirichlet</span><span class="o">.</span><span class="n">C</span><span class="p">,</span>
</span><span id="Problem-585"><a href="#Problem-585"><span class="linenos">585</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="Problem-586"><a href="#Problem-586"><span class="linenos">586</span></a>            <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="Problem-587"><a href="#Problem-587"><span class="linenos">587</span></a>        <span class="p">)</span>
</span><span id="Problem-588"><a href="#Problem-588"><span class="linenos">588</span></a>        <span class="k">return</span> <span class="n">du_field</span><span class="p">,</span> <span class="n">drho</span>
</span><span id="Problem-589"><a href="#Problem-589"><span class="linenos">589</span></a>
</span><span id="Problem-590"><a href="#Problem-590"><span class="linenos">590</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span>
</span><span id="Problem-591"><a href="#Problem-591"><span class="linenos">591</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Problem-592"><a href="#Problem-592"><span class="linenos">592</span></a>        <span class="n">u_field</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem-593"><a href="#Problem-593"><span class="linenos">593</span></a>        <span class="n">rho</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem-594"><a href="#Problem-594"><span class="linenos">594</span></a>        <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5e-2</span><span class="p">,</span>
</span><span id="Problem-595"><a href="#Problem-595"><span class="linenos">595</span></a>        <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="Problem-596"><a href="#Problem-596"><span class="linenos">596</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem-597"><a href="#Problem-597"><span class="linenos">597</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Problem-598"><a href="#Problem-598"><span class="linenos">598</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Problem-599"><a href="#Problem-599"><span class="linenos">599</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem-600"><a href="#Problem-600"><span class="linenos">600</span></a><span class="sd">        Solve the VIC problem using a Gauss-Newton optimization.</span>
</span><span id="Problem-601"><a href="#Problem-601"><span class="linenos">601</span></a>
</span><span id="Problem-602"><a href="#Problem-602"><span class="linenos">602</span></a><span class="sd">        This method iteratively updates the displacement field and the transition</span>
</span><span id="Problem-603"><a href="#Problem-603"><span class="linenos">603</span></a><span class="sd">        distance parameter `rho` to minimize the VIC energy. Each iteration is</span>
</span><span id="Problem-604"><a href="#Problem-604"><span class="linenos">604</span></a><span class="sd">        performed using :meth:`one_gauss_newton_iter`.</span>
</span><span id="Problem-605"><a href="#Problem-605"><span class="linenos">605</span></a>
</span><span id="Problem-606"><a href="#Problem-606"><span class="linenos">606</span></a><span class="sd">        The iteration stops when either the maximum number of iterations is</span>
</span><span id="Problem-607"><a href="#Problem-607"><span class="linenos">607</span></a><span class="sd">        reached or the relative update of the displacement field is below</span>
</span><span id="Problem-608"><a href="#Problem-608"><span class="linenos">608</span></a><span class="sd">        `eps`.</span>
</span><span id="Problem-609"><a href="#Problem-609"><span class="linenos">609</span></a>
</span><span id="Problem-610"><a href="#Problem-610"><span class="linenos">610</span></a><span class="sd">        The displacement field is updated in-place and stored in `u_field`.</span>
</span><span id="Problem-611"><a href="#Problem-611"><span class="linenos">611</span></a><span class="sd">        The first iteration&#39;s data from all image energies are cached in</span>
</span><span id="Problem-612"><a href="#Problem-612"><span class="linenos">612</span></a><span class="sd">        `self.saved_data_0` for post-processing and visualization.</span>
</span><span id="Problem-613"><a href="#Problem-613"><span class="linenos">613</span></a>
</span><span id="Problem-614"><a href="#Problem-614"><span class="linenos">614</span></a><span class="sd">        Parameters</span>
</span><span id="Problem-615"><a href="#Problem-615"><span class="linenos">615</span></a><span class="sd">        ----------</span>
</span><span id="Problem-616"><a href="#Problem-616"><span class="linenos">616</span></a><span class="sd">        u_field : np.ndarray, optional</span>
</span><span id="Problem-617"><a href="#Problem-617"><span class="linenos">617</span></a><span class="sd">            Initial displacement field of shape (3, N). If `None` (default),</span>
</span><span id="Problem-618"><a href="#Problem-618"><span class="linenos">618</span></a><span class="sd">            initializes to zero.</span>
</span><span id="Problem-619"><a href="#Problem-619"><span class="linenos">619</span></a>
</span><span id="Problem-620"><a href="#Problem-620"><span class="linenos">620</span></a><span class="sd">        rho : float, optional</span>
</span><span id="Problem-621"><a href="#Problem-621"><span class="linenos">621</span></a><span class="sd">            Initial value of the distance scaling parameter. If `None` (default),</span>
</span><span id="Problem-622"><a href="#Problem-622"><span class="linenos">622</span></a><span class="sd">            `self.initial_rho` is used.</span>
</span><span id="Problem-623"><a href="#Problem-623"><span class="linenos">623</span></a>
</span><span id="Problem-624"><a href="#Problem-624"><span class="linenos">624</span></a><span class="sd">        eps : float, optional</span>
</span><span id="Problem-625"><a href="#Problem-625"><span class="linenos">625</span></a><span class="sd">            Convergence tolerance. The relative norm of the displacement update</span>
</span><span id="Problem-626"><a href="#Problem-626"><span class="linenos">626</span></a><span class="sd">            is compared to `eps` to decide convergence. Default is `5e-2`.</span>
</span><span id="Problem-627"><a href="#Problem-627"><span class="linenos">627</span></a>
</span><span id="Problem-628"><a href="#Problem-628"><span class="linenos">628</span></a><span class="sd">        max_iter : int, optional</span>
</span><span id="Problem-629"><a href="#Problem-629"><span class="linenos">629</span></a><span class="sd">            Maximum number of Gauss-Newton iterations. Default is `20`.</span>
</span><span id="Problem-630"><a href="#Problem-630"><span class="linenos">630</span></a>
</span><span id="Problem-631"><a href="#Problem-631"><span class="linenos">631</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="Problem-632"><a href="#Problem-632"><span class="linenos">632</span></a><span class="sd">            If `True`, prints iteration diagnostics including `rho` and</span>
</span><span id="Problem-633"><a href="#Problem-633"><span class="linenos">633</span></a><span class="sd">            relative displacement updates. Default is `True`.</span>
</span><span id="Problem-634"><a href="#Problem-634"><span class="linenos">634</span></a>
</span><span id="Problem-635"><a href="#Problem-635"><span class="linenos">635</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="Problem-636"><a href="#Problem-636"><span class="linenos">636</span></a><span class="sd">            If `True`, disables parallel execution during the iterations.</span>
</span><span id="Problem-637"><a href="#Problem-637"><span class="linenos">637</span></a><span class="sd">            Default is `False`.</span>
</span><span id="Problem-638"><a href="#Problem-638"><span class="linenos">638</span></a>
</span><span id="Problem-639"><a href="#Problem-639"><span class="linenos">639</span></a><span class="sd">        Returns</span>
</span><span id="Problem-640"><a href="#Problem-640"><span class="linenos">640</span></a><span class="sd">        -------</span>
</span><span id="Problem-641"><a href="#Problem-641"><span class="linenos">641</span></a><span class="sd">        u_field : np.ndarray</span>
</span><span id="Problem-642"><a href="#Problem-642"><span class="linenos">642</span></a><span class="sd">            Final displacement field after convergence or reaching `max_iter`.</span>
</span><span id="Problem-643"><a href="#Problem-643"><span class="linenos">643</span></a>
</span><span id="Problem-644"><a href="#Problem-644"><span class="linenos">644</span></a><span class="sd">        rho : float</span>
</span><span id="Problem-645"><a href="#Problem-645"><span class="linenos">645</span></a><span class="sd">            Final value of the transition distance parameter after convergence.</span>
</span><span id="Problem-646"><a href="#Problem-646"><span class="linenos">646</span></a>
</span><span id="Problem-647"><a href="#Problem-647"><span class="linenos">647</span></a><span class="sd">        Notes</span>
</span><span id="Problem-648"><a href="#Problem-648"><span class="linenos">648</span></a><span class="sd">        -----</span>
</span><span id="Problem-649"><a href="#Problem-649"><span class="linenos">649</span></a><span class="sd">        This method relies on :meth:`one_gauss_newton_iter` to compute the</span>
</span><span id="Problem-650"><a href="#Problem-650"><span class="linenos">650</span></a><span class="sd">        incremental updates for each iteration.</span>
</span><span id="Problem-651"><a href="#Problem-651"><span class="linenos">651</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem-652"><a href="#Problem-652"><span class="linenos">652</span></a>        <span class="k">if</span> <span class="n">u_field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Problem-653"><a href="#Problem-653"><span class="linenos">653</span></a>            <span class="n">u_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">connectivity</span><span class="o">.</span><span class="n">nb_unique_nodes</span><span class="p">))</span>
</span><span id="Problem-654"><a href="#Problem-654"><span class="linenos">654</span></a>        <span class="k">if</span> <span class="n">rho</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Problem-655"><a href="#Problem-655"><span class="linenos">655</span></a>            <span class="n">rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_rho</span>
</span><span id="Problem-656"><a href="#Problem-656"><span class="linenos">656</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
</span><span id="Problem-657"><a href="#Problem-657"><span class="linenos">657</span></a>            <span class="n">du_field</span><span class="p">,</span> <span class="n">drho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_gauss_newton_iter</span><span class="p">(</span>
</span><span id="Problem-658"><a href="#Problem-658"><span class="linenos">658</span></a>                <span class="n">u_field</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span>
</span><span id="Problem-659"><a href="#Problem-659"><span class="linenos">659</span></a>            <span class="p">)</span>
</span><span id="Problem-660"><a href="#Problem-660"><span class="linenos">660</span></a>            <span class="n">u_field</span> <span class="o">+=</span> <span class="n">du_field</span>
</span><span id="Problem-661"><a href="#Problem-661"><span class="linenos">661</span></a>            <span class="n">rho</span> <span class="o">+=</span> <span class="n">drho</span>
</span><span id="Problem-662"><a href="#Problem-662"><span class="linenos">662</span></a>            <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
</span><span id="Problem-663"><a href="#Problem-663"><span class="linenos">663</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Problem-664"><a href="#Problem-664"><span class="linenos">664</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">saved_data_0</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Problem-665"><a href="#Problem-665"><span class="linenos">665</span></a>                    <span class="n">deepcopy</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">saved_data</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span>
</span><span id="Problem-666"><a href="#Problem-666"><span class="linenos">666</span></a>                <span class="p">]</span>
</span><span id="Problem-667"><a href="#Problem-667"><span class="linenos">667</span></a>            <span class="n">du_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">du_field</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u_field</span><span class="p">)</span>
</span><span id="Problem-668"><a href="#Problem-668"><span class="linenos">668</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-669"><a href="#Problem-669"><span class="linenos">669</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;iter = </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, rho = </span><span class="si">{</span><span class="n">rho</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, du/u = </span><span class="si">{</span><span class="n">du_u</span><span class="si">:</span><span class="s2">.2E</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem-670"><a href="#Problem-670"><span class="linenos">670</span></a>            <span class="k">if</span> <span class="n">du_u</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">:</span>
</span><span id="Problem-671"><a href="#Problem-671"><span class="linenos">671</span></a>                <span class="k">break</span>
</span><span id="Problem-672"><a href="#Problem-672"><span class="linenos">672</span></a>        <span class="k">return</span> <span class="n">u_field</span><span class="p">,</span> <span class="n">rho</span>
</span><span id="Problem-673"><a href="#Problem-673"><span class="linenos">673</span></a>
</span><span id="Problem-674"><a href="#Problem-674"><span class="linenos">674</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_paraview</span><span class="p">(</span>
</span><span id="Problem-675"><a href="#Problem-675"><span class="linenos">675</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Problem-676"><a href="#Problem-676"><span class="linenos">676</span></a>        <span class="n">u_field</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
</span><span id="Problem-677"><a href="#Problem-677"><span class="linenos">677</span></a>        <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Problem-678"><a href="#Problem-678"><span class="linenos">678</span></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Problem-679"><a href="#Problem-679"><span class="linenos">679</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Problem-680"><a href="#Problem-680"><span class="linenos">680</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem-681"><a href="#Problem-681"><span class="linenos">681</span></a>    <span class="p">):</span>
</span><span id="Problem-682"><a href="#Problem-682"><span class="linenos">682</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem-683"><a href="#Problem-683"><span class="linenos">683</span></a><span class="sd">        Export the current VIC results to Paraview-compatible VTK files.</span>
</span><span id="Problem-684"><a href="#Problem-684"><span class="linenos">684</span></a>
</span><span id="Problem-685"><a href="#Problem-685"><span class="linenos">685</span></a><span class="sd">        This method computes the signed distance fields before and after the</span>
</span><span id="Problem-686"><a href="#Problem-686"><span class="linenos">686</span></a><span class="sd">        displacement update, associates them with the mesh nodes, and calls</span>
</span><span id="Problem-687"><a href="#Problem-687"><span class="linenos">687</span></a><span class="sd">        the mesh&#39;s :meth:`Mesh.save_paraview` method to save all fields for</span>
</span><span id="Problem-688"><a href="#Problem-688"><span class="linenos">688</span></a><span class="sd">        visualization in Paraview.</span>
</span><span id="Problem-689"><a href="#Problem-689"><span class="linenos">689</span></a>
</span><span id="Problem-690"><a href="#Problem-690"><span class="linenos">690</span></a><span class="sd">        The exported fields include:</span>
</span><span id="Problem-691"><a href="#Problem-691"><span class="linenos">691</span></a><span class="sd">            - `u`: displacement field provided in `u_field`.</span>
</span><span id="Problem-692"><a href="#Problem-692"><span class="linenos">692</span></a><span class="sd">            - `d0`: signed distance fields at the first iteration (cached in</span>
</span><span id="Problem-693"><a href="#Problem-693"><span class="linenos">693</span></a><span class="sd">              `self.saved_data_0`).</span>
</span><span id="Problem-694"><a href="#Problem-694"><span class="linenos">694</span></a><span class="sd">            - `d`: signed distance fields at the current iteration (not computed</span>
</span><span id="Problem-695"><a href="#Problem-695"><span class="linenos">695</span></a><span class="sd">              from `u_field`).</span>
</span><span id="Problem-696"><a href="#Problem-696"><span class="linenos">696</span></a>
</span><span id="Problem-697"><a href="#Problem-697"><span class="linenos">697</span></a><span class="sd">        Parameters</span>
</span><span id="Problem-698"><a href="#Problem-698"><span class="linenos">698</span></a><span class="sd">        ----------</span>
</span><span id="Problem-699"><a href="#Problem-699"><span class="linenos">699</span></a><span class="sd">        u_field : np.ndarray</span>
</span><span id="Problem-700"><a href="#Problem-700"><span class="linenos">700</span></a><span class="sd">            Displacement field of shape (3, N) to be saved.</span>
</span><span id="Problem-701"><a href="#Problem-701"><span class="linenos">701</span></a>
</span><span id="Problem-702"><a href="#Problem-702"><span class="linenos">702</span></a><span class="sd">        folder : str</span>
</span><span id="Problem-703"><a href="#Problem-703"><span class="linenos">703</span></a><span class="sd">            Destination folder where the VTK files will be written.</span>
</span><span id="Problem-704"><a href="#Problem-704"><span class="linenos">704</span></a>
</span><span id="Problem-705"><a href="#Problem-705"><span class="linenos">705</span></a><span class="sd">        name : str</span>
</span><span id="Problem-706"><a href="#Problem-706"><span class="linenos">706</span></a><span class="sd">            Base name for the exported VTK files.</span>
</span><span id="Problem-707"><a href="#Problem-707"><span class="linenos">707</span></a>
</span><span id="Problem-708"><a href="#Problem-708"><span class="linenos">708</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="Problem-709"><a href="#Problem-709"><span class="linenos">709</span></a><span class="sd">            If `True`, disables parallel execution for distance field computation</span>
</span><span id="Problem-710"><a href="#Problem-710"><span class="linenos">710</span></a><span class="sd">            and mesh export. Default is `False`.</span>
</span><span id="Problem-711"><a href="#Problem-711"><span class="linenos">711</span></a>
</span><span id="Problem-712"><a href="#Problem-712"><span class="linenos">712</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="Problem-713"><a href="#Problem-713"><span class="linenos">713</span></a><span class="sd">            If `True` (default), prints diagnostic messages during computation</span>
</span><span id="Problem-714"><a href="#Problem-714"><span class="linenos">714</span></a><span class="sd">            and export.</span>
</span><span id="Problem-715"><a href="#Problem-715"><span class="linenos">715</span></a>
</span><span id="Problem-716"><a href="#Problem-716"><span class="linenos">716</span></a><span class="sd">        Notes</span>
</span><span id="Problem-717"><a href="#Problem-717"><span class="linenos">717</span></a><span class="sd">        -----</span>
</span><span id="Problem-718"><a href="#Problem-718"><span class="linenos">718</span></a><span class="sd">        The method automatically constructs the `XI_list` from the parametric</span>
</span><span id="Problem-719"><a href="#Problem-719"><span class="linenos">719</span></a><span class="sd">        coordinates of each image energy element and sets</span>
</span><span id="Problem-720"><a href="#Problem-720"><span class="linenos">720</span></a><span class="sd">        `fields_on_interior_only=&quot;auto&quot;` for the mesh export.</span>
</span><span id="Problem-721"><a href="#Problem-721"><span class="linenos">721</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem-722"><a href="#Problem-722"><span class="linenos">722</span></a>        <span class="n">d0</span> <span class="o">=</span> <span class="n">compute_distance_field</span><span class="p">(</span>
</span><span id="Problem-723"><a href="#Problem-723"><span class="linenos">723</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">,</span>
</span><span id="Problem-724"><a href="#Problem-724"><span class="linenos">724</span></a>            <span class="n">saved_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_data_0</span><span class="p">,</span>
</span><span id="Problem-725"><a href="#Problem-725"><span class="linenos">725</span></a>            <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="Problem-726"><a href="#Problem-726"><span class="linenos">726</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="Problem-727"><a href="#Problem-727"><span class="linenos">727</span></a>        <span class="p">)</span>
</span><span id="Problem-728"><a href="#Problem-728"><span class="linenos">728</span></a>        <span class="n">d</span> <span class="o">=</span> <span class="n">compute_distance_field</span><span class="p">(</span>
</span><span id="Problem-729"><a href="#Problem-729"><span class="linenos">729</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">,</span>
</span><span id="Problem-730"><a href="#Problem-730"><span class="linenos">730</span></a>            <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="Problem-731"><a href="#Problem-731"><span class="linenos">731</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="Problem-732"><a href="#Problem-732"><span class="linenos">732</span></a>        <span class="p">)</span>
</span><span id="Problem-733"><a href="#Problem-733"><span class="linenos">733</span></a>        <span class="n">separated_fields</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">di</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="s2">&quot;d0&quot;</span><span class="p">:</span> <span class="n">d0i</span><span class="p">[</span><span class="kc">None</span><span class="p">]}</span> <span class="k">for</span> <span class="n">di</span><span class="p">,</span> <span class="n">d0i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d0</span><span class="p">)]</span>
</span><span id="Problem-734"><a href="#Problem-734"><span class="linenos">734</span></a>        <span class="n">unique_fields</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="n">u_field</span><span class="p">[</span><span class="kc">None</span><span class="p">]}</span>
</span><span id="Problem-735"><a href="#Problem-735"><span class="linenos">735</span></a>        <span class="n">XI_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">e</span><span class="o">.</span><span class="n">xi</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">eta</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">]</span>
</span><span id="Problem-736"><a href="#Problem-736"><span class="linenos">736</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">save_paraview</span><span class="p">(</span>
</span><span id="Problem-737"><a href="#Problem-737"><span class="linenos">737</span></a>            <span class="n">folder</span><span class="p">,</span>
</span><span id="Problem-738"><a href="#Problem-738"><span class="linenos">738</span></a>            <span class="n">name</span><span class="p">,</span>
</span><span id="Problem-739"><a href="#Problem-739"><span class="linenos">739</span></a>            <span class="n">unique_fields</span><span class="o">=</span><span class="n">unique_fields</span><span class="p">,</span>
</span><span id="Problem-740"><a href="#Problem-740"><span class="linenos">740</span></a>            <span class="n">separated_fields</span><span class="o">=</span><span class="n">separated_fields</span><span class="p">,</span>
</span><span id="Problem-741"><a href="#Problem-741"><span class="linenos">741</span></a>            <span class="n">XI_list</span><span class="o">=</span><span class="n">XI_list</span><span class="p">,</span>
</span><span id="Problem-742"><a href="#Problem-742"><span class="linenos">742</span></a>            <span class="n">fields_on_interior_only</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="Problem-743"><a href="#Problem-743"><span class="linenos">743</span></a>            <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="Problem-744"><a href="#Problem-744"><span class="linenos">744</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="Problem-745"><a href="#Problem-745"><span class="linenos">745</span></a>        <span class="p">)</span>
</span><span id="Problem-746"><a href="#Problem-746"><span class="linenos">746</span></a>
</span><span id="Problem-747"><a href="#Problem-747"><span class="linenos">747</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_results</span><span class="p">(</span>
</span><span id="Problem-748"><a href="#Problem-748"><span class="linenos">748</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Problem-749"><a href="#Problem-749"><span class="linenos">749</span></a>        <span class="n">u_field</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem-750"><a href="#Problem-750"><span class="linenos">750</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Problem-751"><a href="#Problem-751"><span class="linenos">751</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem-752"><a href="#Problem-752"><span class="linenos">752</span></a>        <span class="n">n_colors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
</span><span id="Problem-753"><a href="#Problem-753"><span class="linenos">753</span></a>        <span class="n">interior_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem-754"><a href="#Problem-754"><span class="linenos">754</span></a>        <span class="n">plt_ctrl_mesh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Problem-755"><a href="#Problem-755"><span class="linenos">755</span></a>        <span class="n">pv_plotter</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pv</span><span class="o">.</span><span class="n">Plotter</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem-756"><a href="#Problem-756"><span class="linenos">756</span></a>        <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem-757"><a href="#Problem-757"><span class="linenos">757</span></a>        <span class="n">elem_sep_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="Problem-758"><a href="#Problem-758"><span class="linenos">758</span></a>        <span class="n">ctrl_poly_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
</span><span id="Problem-759"><a href="#Problem-759"><span class="linenos">759</span></a>        <span class="o">**</span><span class="n">pv_add_mesh_kwargs</span><span class="p">,</span>
</span><span id="Problem-760"><a href="#Problem-760"><span class="linenos">760</span></a>    <span class="p">):</span>
</span><span id="Problem-761"><a href="#Problem-761"><span class="linenos">761</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem-762"><a href="#Problem-762"><span class="linenos">762</span></a><span class="sd">        Visualize VIC results with PyVista, optionally applying a displacement field.</span>
</span><span id="Problem-763"><a href="#Problem-763"><span class="linenos">763</span></a>
</span><span id="Problem-764"><a href="#Problem-764"><span class="linenos">764</span></a><span class="sd">        This method plots the signed distance fields of the mesh with respect to</span>
</span><span id="Problem-765"><a href="#Problem-765"><span class="linenos">765</span></a><span class="sd">        the image features. If a displacement field `u_field` is provided, it</span>
</span><span id="Problem-766"><a href="#Problem-766"><span class="linenos">766</span></a><span class="sd">        is applied to a copy of the mesh for visualization; otherwise, the</span>
</span><span id="Problem-767"><a href="#Problem-767"><span class="linenos">767</span></a><span class="sd">        distances from the first iteration are displayed. It is recommended</span>
</span><span id="Problem-768"><a href="#Problem-768"><span class="linenos">768</span></a><span class="sd">        to pass the displacement field obtained from `solve` to make sure to match</span>
</span><span id="Problem-769"><a href="#Problem-769"><span class="linenos">769</span></a><span class="sd">        the distance map to the correct displacement field.</span>
</span><span id="Problem-770"><a href="#Problem-770"><span class="linenos">770</span></a>
</span><span id="Problem-771"><a href="#Problem-771"><span class="linenos">771</span></a><span class="sd">        The visualization can be customized, including the number of colors,</span>
</span><span id="Problem-772"><a href="#Problem-772"><span class="linenos">772</span></a><span class="sd">        control mesh display, scalar bar, and interior-only rendering. Any</span>
</span><span id="Problem-773"><a href="#Problem-773"><span class="linenos">773</span></a><span class="sd">        additional keyword arguments are passed to :meth:`Mesh.plot`, which</span>
</span><span id="Problem-774"><a href="#Problem-774"><span class="linenos">774</span></a><span class="sd">        ultimately forwards them to :meth:`pv.Plotter.add_mesh`.</span>
</span><span id="Problem-775"><a href="#Problem-775"><span class="linenos">775</span></a>
</span><span id="Problem-776"><a href="#Problem-776"><span class="linenos">776</span></a><span class="sd">        Parameters</span>
</span><span id="Problem-777"><a href="#Problem-777"><span class="linenos">777</span></a><span class="sd">        ----------</span>
</span><span id="Problem-778"><a href="#Problem-778"><span class="linenos">778</span></a><span class="sd">        u_field : np.ndarray or None, optional</span>
</span><span id="Problem-779"><a href="#Problem-779"><span class="linenos">779</span></a><span class="sd">            Displacement field to apply to the mesh for visualization. If `None`</span>
</span><span id="Problem-780"><a href="#Problem-780"><span class="linenos">780</span></a><span class="sd">            (default), the distances from the first iteration (`self.saved_data_0`)</span>
</span><span id="Problem-781"><a href="#Problem-781"><span class="linenos">781</span></a><span class="sd">            are displayed. If provided, the mesh is warped according to this</span>
</span><span id="Problem-782"><a href="#Problem-782"><span class="linenos">782</span></a><span class="sd">            displacement. To correctly display the most recent VIC results,</span>
</span><span id="Problem-783"><a href="#Problem-783"><span class="linenos">783</span></a><span class="sd">            pass the `u_field` output from the `solve` method, as the distance</span>
</span><span id="Problem-784"><a href="#Problem-784"><span class="linenos">784</span></a><span class="sd">            map displayed corresponds to the last iteration computed by the</span>
</span><span id="Problem-785"><a href="#Problem-785"><span class="linenos">785</span></a><span class="sd">            image energy terms.</span>
</span><span id="Problem-786"><a href="#Problem-786"><span class="linenos">786</span></a>
</span><span id="Problem-787"><a href="#Problem-787"><span class="linenos">787</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="Problem-788"><a href="#Problem-788"><span class="linenos">788</span></a><span class="sd">            If `True`, disables parallel computation of distance fields.</span>
</span><span id="Problem-789"><a href="#Problem-789"><span class="linenos">789</span></a><span class="sd">            Default is `False`.</span>
</span><span id="Problem-790"><a href="#Problem-790"><span class="linenos">790</span></a>
</span><span id="Problem-791"><a href="#Problem-791"><span class="linenos">791</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="Problem-792"><a href="#Problem-792"><span class="linenos">792</span></a><span class="sd">            If `True`, prints diagnostic messages. Default is `True`.</span>
</span><span id="Problem-793"><a href="#Problem-793"><span class="linenos">793</span></a>
</span><span id="Problem-794"><a href="#Problem-794"><span class="linenos">794</span></a><span class="sd">        n_colors : int, optional</span>
</span><span id="Problem-795"><a href="#Problem-795"><span class="linenos">795</span></a><span class="sd">            Number of discrete colors in the colormap. Default is `15`.</span>
</span><span id="Problem-796"><a href="#Problem-796"><span class="linenos">796</span></a>
</span><span id="Problem-797"><a href="#Problem-797"><span class="linenos">797</span></a><span class="sd">        interior_only : bool, optional</span>
</span><span id="Problem-798"><a href="#Problem-798"><span class="linenos">798</span></a><span class="sd">            If `True`, only interior elements of the mesh are plotted.</span>
</span><span id="Problem-799"><a href="#Problem-799"><span class="linenos">799</span></a><span class="sd">            Default is `True`.</span>
</span><span id="Problem-800"><a href="#Problem-800"><span class="linenos">800</span></a>
</span><span id="Problem-801"><a href="#Problem-801"><span class="linenos">801</span></a><span class="sd">        plt_ctrl_mesh : bool, optional</span>
</span><span id="Problem-802"><a href="#Problem-802"><span class="linenos">802</span></a><span class="sd">            If `True`, overlays the control mesh on the plot.</span>
</span><span id="Problem-803"><a href="#Problem-803"><span class="linenos">803</span></a><span class="sd">            Default is `False`.</span>
</span><span id="Problem-804"><a href="#Problem-804"><span class="linenos">804</span></a>
</span><span id="Problem-805"><a href="#Problem-805"><span class="linenos">805</span></a><span class="sd">        pv_plotter : pv.Plotter or None, optional</span>
</span><span id="Problem-806"><a href="#Problem-806"><span class="linenos">806</span></a><span class="sd">            PyVista plotter object to use. If `None`, a new plotter is created.</span>
</span><span id="Problem-807"><a href="#Problem-807"><span class="linenos">807</span></a>
</span><span id="Problem-808"><a href="#Problem-808"><span class="linenos">808</span></a><span class="sd">        show : bool, optional</span>
</span><span id="Problem-809"><a href="#Problem-809"><span class="linenos">809</span></a><span class="sd">            If `True`, displays the plot immediately. Default is `True`.</span>
</span><span id="Problem-810"><a href="#Problem-810"><span class="linenos">810</span></a>
</span><span id="Problem-811"><a href="#Problem-811"><span class="linenos">811</span></a><span class="sd">        elem_sep_color : str, optional</span>
</span><span id="Problem-812"><a href="#Problem-812"><span class="linenos">812</span></a><span class="sd">            Color used for separating elements. Only applied if `interior_only`</span>
</span><span id="Problem-813"><a href="#Problem-813"><span class="linenos">813</span></a><span class="sd">            is `False`. Default is `&#39;black&#39;`.</span>
</span><span id="Problem-814"><a href="#Problem-814"><span class="linenos">814</span></a>
</span><span id="Problem-815"><a href="#Problem-815"><span class="linenos">815</span></a><span class="sd">        ctrl_poly_color : str, optional</span>
</span><span id="Problem-816"><a href="#Problem-816"><span class="linenos">816</span></a><span class="sd">            Color of the control mesh. Only applied if `plt_ctrl_mesh` is `True`</span>
</span><span id="Problem-817"><a href="#Problem-817"><span class="linenos">817</span></a><span class="sd">            and `interior_only` is `False`. Default is `&#39;green&#39;`.</span>
</span><span id="Problem-818"><a href="#Problem-818"><span class="linenos">818</span></a>
</span><span id="Problem-819"><a href="#Problem-819"><span class="linenos">819</span></a><span class="sd">        **pv_add_mesh_kwargs : dict, optional</span>
</span><span id="Problem-820"><a href="#Problem-820"><span class="linenos">820</span></a><span class="sd">            Additional keyword arguments passed to :meth:`Mesh.plot`, such as</span>
</span><span id="Problem-821"><a href="#Problem-821"><span class="linenos">821</span></a><span class="sd">            `cmap`, `clim`, `scalar_bar_args`, etc.</span>
</span><span id="Problem-822"><a href="#Problem-822"><span class="linenos">822</span></a>
</span><span id="Problem-823"><a href="#Problem-823"><span class="linenos">823</span></a><span class="sd">        Returns</span>
</span><span id="Problem-824"><a href="#Problem-824"><span class="linenos">824</span></a><span class="sd">        -------</span>
</span><span id="Problem-825"><a href="#Problem-825"><span class="linenos">825</span></a><span class="sd">        pv.Plotter or None</span>
</span><span id="Problem-826"><a href="#Problem-826"><span class="linenos">826</span></a><span class="sd">            The PyVista plotter object used for the visualization.</span>
</span><span id="Problem-827"><a href="#Problem-827"><span class="linenos">827</span></a>
</span><span id="Problem-828"><a href="#Problem-828"><span class="linenos">828</span></a><span class="sd">        Notes</span>
</span><span id="Problem-829"><a href="#Problem-829"><span class="linenos">829</span></a><span class="sd">        -----</span>
</span><span id="Problem-830"><a href="#Problem-830"><span class="linenos">830</span></a><span class="sd">        - The signed distance field `d` is computed from the image energies via</span>
</span><span id="Problem-831"><a href="#Problem-831"><span class="linenos">831</span></a><span class="sd">          :func:`volVIC.VirtualImageCorrelationEnergyElem.compute_distance_field`.</span>
</span><span id="Problem-832"><a href="#Problem-832"><span class="linenos">832</span></a><span class="sd">        - The default colormap is a resampled `&quot;RdBu&quot;` with `n_colors`.</span>
</span><span id="Problem-833"><a href="#Problem-833"><span class="linenos">833</span></a><span class="sd">        - Scalar bar properties are automatically set but can be overridden via</span>
</span><span id="Problem-834"><a href="#Problem-834"><span class="linenos">834</span></a><span class="sd">          `pv_add_mesh_kwargs[&quot;scalar_bar_args&quot;]`.</span>
</span><span id="Problem-835"><a href="#Problem-835"><span class="linenos">835</span></a><span class="sd">        - To make sure the deformation matches the distance field, always pass the</span>
</span><span id="Problem-836"><a href="#Problem-836"><span class="linenos">836</span></a><span class="sd">          displacement field returned by :meth:`solve`.</span>
</span><span id="Problem-837"><a href="#Problem-837"><span class="linenos">837</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem-838"><a href="#Problem-838"><span class="linenos">838</span></a>        <span class="k">if</span> <span class="n">u_field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Problem-839"><a href="#Problem-839"><span class="linenos">839</span></a>            <span class="n">d</span> <span class="o">=</span> <span class="n">compute_distance_field</span><span class="p">(</span>
</span><span id="Problem-840"><a href="#Problem-840"><span class="linenos">840</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">,</span>
</span><span id="Problem-841"><a href="#Problem-841"><span class="linenos">841</span></a>                <span class="n">saved_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_data_0</span><span class="p">,</span>
</span><span id="Problem-842"><a href="#Problem-842"><span class="linenos">842</span></a>                <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="Problem-843"><a href="#Problem-843"><span class="linenos">843</span></a>                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="Problem-844"><a href="#Problem-844"><span class="linenos">844</span></a>            <span class="p">)</span>
</span><span id="Problem-845"><a href="#Problem-845"><span class="linenos">845</span></a>            <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span>
</span><span id="Problem-846"><a href="#Problem-846"><span class="linenos">846</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Problem-847"><a href="#Problem-847"><span class="linenos">847</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem-848"><a href="#Problem-848"><span class="linenos">848</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assume last iteration state.&quot;</span><span class="p">)</span>
</span><span id="Problem-849"><a href="#Problem-849"><span class="linenos">849</span></a>            <span class="n">d</span> <span class="o">=</span> <span class="n">compute_distance_field</span><span class="p">(</span>
</span><span id="Problem-850"><a href="#Problem-850"><span class="linenos">850</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">,</span>
</span><span id="Problem-851"><a href="#Problem-851"><span class="linenos">851</span></a>                <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="Problem-852"><a href="#Problem-852"><span class="linenos">852</span></a>                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="Problem-853"><a href="#Problem-853"><span class="linenos">853</span></a>            <span class="p">)</span>
</span><span id="Problem-854"><a href="#Problem-854"><span class="linenos">854</span></a>            <span class="n">mesh</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
</span><span id="Problem-855"><a href="#Problem-855"><span class="linenos">855</span></a>            <span class="n">mesh</span><span class="o">.</span><span class="n">unique_ctrl_pts</span><span class="o">.</span><span class="n">flat</span> <span class="o">+=</span> <span class="n">u_field</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="Problem-856"><a href="#Problem-856"><span class="linenos">856</span></a>
</span><span id="Problem-857"><a href="#Problem-857"><span class="linenos">857</span></a>        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s2">&quot;RdBu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resampled</span><span class="p">(</span><span class="n">n_colors</span><span class="p">)</span>
</span><span id="Problem-858"><a href="#Problem-858"><span class="linenos">858</span></a>        <span class="n">pv_add_mesh_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;cmap&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="p">)</span>
</span><span id="Problem-859"><a href="#Problem-859"><span class="linenos">859</span></a>        <span class="k">if</span> <span class="s2">&quot;clim&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pv_add_mesh_kwargs</span><span class="p">:</span>
</span><span id="Problem-860"><a href="#Problem-860"><span class="linenos">860</span></a>            <span class="n">lim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="mf">1e-3</span>
</span><span id="Problem-861"><a href="#Problem-861"><span class="linenos">861</span></a>            <span class="n">pv_add_mesh_kwargs</span><span class="p">[</span><span class="s2">&quot;clim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">lim</span><span class="p">,</span> <span class="n">lim</span><span class="p">]</span>
</span><span id="Problem-862"><a href="#Problem-862"><span class="linenos">862</span></a>        <span class="n">sargs</span> <span class="o">=</span> <span class="n">pv_add_mesh_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scalar_bar_args&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Problem-863"><a href="#Problem-863"><span class="linenos">863</span></a>        <span class="n">defaults_sargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="Problem-864"><a href="#Problem-864"><span class="linenos">864</span></a>            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Signed distance to the image features [px]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Problem-865"><a href="#Problem-865"><span class="linenos">865</span></a>            <span class="n">vertical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Problem-866"><a href="#Problem-866"><span class="linenos">866</span></a>            <span class="n">position_x</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="Problem-867"><a href="#Problem-867"><span class="linenos">867</span></a>            <span class="n">position_y</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
</span><span id="Problem-868"><a href="#Problem-868"><span class="linenos">868</span></a>            <span class="n">height</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="Problem-869"><a href="#Problem-869"><span class="linenos">869</span></a>            <span class="n">width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="Problem-870"><a href="#Problem-870"><span class="linenos">870</span></a>            <span class="n">n_colors</span><span class="o">=</span><span class="n">n_colors</span><span class="p">,</span>
</span><span id="Problem-871"><a href="#Problem-871"><span class="linenos">871</span></a>            <span class="n">title_font_size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
</span><span id="Problem-872"><a href="#Problem-872"><span class="linenos">872</span></a>            <span class="n">label_font_size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
</span><span id="Problem-873"><a href="#Problem-873"><span class="linenos">873</span></a>        <span class="p">)</span>
</span><span id="Problem-874"><a href="#Problem-874"><span class="linenos">874</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults_sargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Problem-875"><a href="#Problem-875"><span class="linenos">875</span></a>            <span class="n">sargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="Problem-876"><a href="#Problem-876"><span class="linenos">876</span></a>        <span class="n">pv_add_mesh_kwargs</span><span class="p">[</span><span class="s2">&quot;scalar_bar_args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sargs</span>
</span><span id="Problem-877"><a href="#Problem-877"><span class="linenos">877</span></a>
</span><span id="Problem-878"><a href="#Problem-878"><span class="linenos">878</span></a>        <span class="n">XI_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">e</span><span class="o">.</span><span class="n">xi</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">eta</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">]</span>
</span><span id="Problem-879"><a href="#Problem-879"><span class="linenos">879</span></a>        <span class="k">return</span> <span class="n">mesh</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="Problem-880"><a href="#Problem-880"><span class="linenos">880</span></a>            <span class="n">XI_list</span><span class="o">=</span><span class="n">XI_list</span><span class="p">,</span>
</span><span id="Problem-881"><a href="#Problem-881"><span class="linenos">881</span></a>            <span class="n">separated_field</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
</span><span id="Problem-882"><a href="#Problem-882"><span class="linenos">882</span></a>            <span class="n">interior_only</span><span class="o">=</span><span class="n">interior_only</span><span class="p">,</span>
</span><span id="Problem-883"><a href="#Problem-883"><span class="linenos">883</span></a>            <span class="n">plt_ctrl_mesh</span><span class="o">=</span><span class="n">plt_ctrl_mesh</span><span class="p">,</span>
</span><span id="Problem-884"><a href="#Problem-884"><span class="linenos">884</span></a>            <span class="n">pv_plotter</span><span class="o">=</span><span class="n">pv_plotter</span><span class="p">,</span>
</span><span id="Problem-885"><a href="#Problem-885"><span class="linenos">885</span></a>            <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span>
</span><span id="Problem-886"><a href="#Problem-886"><span class="linenos">886</span></a>            <span class="n">elem_sep_color</span><span class="o">=</span><span class="n">elem_sep_color</span><span class="p">,</span>
</span><span id="Problem-887"><a href="#Problem-887"><span class="linenos">887</span></a>            <span class="n">ctrl_poly_color</span><span class="o">=</span><span class="n">ctrl_poly_color</span><span class="p">,</span>
</span><span id="Problem-888"><a href="#Problem-888"><span class="linenos">888</span></a>            <span class="o">**</span><span class="n">pv_add_mesh_kwargs</span><span class="p">,</span>
</span><span id="Problem-889"><a href="#Problem-889"><span class="linenos">889</span></a>        <span class="p">)</span>
</span><span id="Problem-890"><a href="#Problem-890"><span class="linenos">890</span></a>
</span><span id="Problem-891"><a href="#Problem-891"><span class="linenos">891</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">propagate_displacement_to_volume_mesh</span><span class="p">(</span>
</span><span id="Problem-892"><a href="#Problem-892"><span class="linenos">892</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Problem-893"><a href="#Problem-893"><span class="linenos">893</span></a>        <span class="n">u_field</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
</span><span id="Problem-894"><a href="#Problem-894"><span class="linenos">894</span></a>        <span class="n">volume_mesh</span><span class="p">:</span> <span class="n">Mesh</span><span class="p">,</span>
</span><span id="Problem-895"><a href="#Problem-895"><span class="linenos">895</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Problem-896"><a href="#Problem-896"><span class="linenos">896</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]:</span>
</span><span id="Problem-897"><a href="#Problem-897"><span class="linenos">897</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem-898"><a href="#Problem-898"><span class="linenos">898</span></a><span class="sd">        Propagate the surface displacement field to a volumetric mesh.</span>
</span><span id="Problem-899"><a href="#Problem-899"><span class="linenos">899</span></a>
</span><span id="Problem-900"><a href="#Problem-900"><span class="linenos">900</span></a><span class="sd">        This method maps the displacement field computed on the surface mesh</span>
</span><span id="Problem-901"><a href="#Problem-901"><span class="linenos">901</span></a><span class="sd">        (`self.mesh`) to a target volume mesh (`volume_mesh`). The mapping uses</span>
</span><span id="Problem-902"><a href="#Problem-902"><span class="linenos">902</span></a><span class="sd">        the surface-to-volume interpolation implemented in</span>
</span><span id="Problem-903"><a href="#Problem-903"><span class="linenos">903</span></a><span class="sd">        :meth:`Mesh.propagate_field_from_submesh`. The resulting volumetric</span>
</span><span id="Problem-904"><a href="#Problem-904"><span class="linenos">904</span></a><span class="sd">        displacement field is returned in the same coordinate system as the</span>
</span><span id="Problem-905"><a href="#Problem-905"><span class="linenos">905</span></a><span class="sd">        original surface mesh (before ICP).</span>
</span><span id="Problem-906"><a href="#Problem-906"><span class="linenos">906</span></a>
</span><span id="Problem-907"><a href="#Problem-907"><span class="linenos">907</span></a><span class="sd">        Parameters</span>
</span><span id="Problem-908"><a href="#Problem-908"><span class="linenos">908</span></a><span class="sd">        ----------</span>
</span><span id="Problem-909"><a href="#Problem-909"><span class="linenos">909</span></a><span class="sd">        u_field : np.ndarray[np.floating]</span>
</span><span id="Problem-910"><a href="#Problem-910"><span class="linenos">910</span></a><span class="sd">            Surface displacement field to propagate. Typically, this is the</span>
</span><span id="Problem-911"><a href="#Problem-911"><span class="linenos">911</span></a><span class="sd">            `u_field` obtained from the :meth:`solve` method.</span>
</span><span id="Problem-912"><a href="#Problem-912"><span class="linenos">912</span></a>
</span><span id="Problem-913"><a href="#Problem-913"><span class="linenos">913</span></a><span class="sd">        volume_mesh : Mesh</span>
</span><span id="Problem-914"><a href="#Problem-914"><span class="linenos">914</span></a><span class="sd">            Target volumetric mesh on which to propagate the displacement.</span>
</span><span id="Problem-915"><a href="#Problem-915"><span class="linenos">915</span></a>
</span><span id="Problem-916"><a href="#Problem-916"><span class="linenos">916</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="Problem-917"><a href="#Problem-917"><span class="linenos">917</span></a><span class="sd">            If `True`, disables parallel computation. Default is `False`.</span>
</span><span id="Problem-918"><a href="#Problem-918"><span class="linenos">918</span></a>
</span><span id="Problem-919"><a href="#Problem-919"><span class="linenos">919</span></a><span class="sd">        Returns</span>
</span><span id="Problem-920"><a href="#Problem-920"><span class="linenos">920</span></a><span class="sd">        -------</span>
</span><span id="Problem-921"><a href="#Problem-921"><span class="linenos">921</span></a><span class="sd">        np.ndarray[np.floating]</span>
</span><span id="Problem-922"><a href="#Problem-922"><span class="linenos">922</span></a><span class="sd">            Displacement field defined on the volume mesh, in the same</span>
</span><span id="Problem-923"><a href="#Problem-923"><span class="linenos">923</span></a><span class="sd">            coordinate system as the input surface displacement.</span>
</span><span id="Problem-924"><a href="#Problem-924"><span class="linenos">924</span></a>
</span><span id="Problem-925"><a href="#Problem-925"><span class="linenos">925</span></a><span class="sd">        Notes</span>
</span><span id="Problem-926"><a href="#Problem-926"><span class="linenos">926</span></a><span class="sd">        -----</span>
</span><span id="Problem-927"><a href="#Problem-927"><span class="linenos">927</span></a><span class="sd">        - The propagation is performed via</span>
</span><span id="Problem-928"><a href="#Problem-928"><span class="linenos">928</span></a><span class="sd">          :meth:`Mesh.propagate_field_from_submesh`, which interpolates the</span>
</span><span id="Problem-929"><a href="#Problem-929"><span class="linenos">929</span></a><span class="sd">          surface displacement onto the volume nodes.</span>
</span><span id="Problem-930"><a href="#Problem-930"><span class="linenos">930</span></a><span class="sd">        - The method internally applies and then removes the rigid-body</span>
</span><span id="Problem-931"><a href="#Problem-931"><span class="linenos">931</span></a><span class="sd">          rotation `self.Rmat` used during VIC initialization to ensure</span>
</span><span id="Problem-932"><a href="#Problem-932"><span class="linenos">932</span></a><span class="sd">          consistency between surface and volume coordinate frames.</span>
</span><span id="Problem-933"><a href="#Problem-933"><span class="linenos">933</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem-934"><a href="#Problem-934"><span class="linenos">934</span></a>
</span><span id="Problem-935"><a href="#Problem-935"><span class="linenos">935</span></a>        <span class="n">u_vol_field</span> <span class="o">=</span> <span class="n">volume_mesh</span><span class="o">.</span><span class="n">propagate_field_from_submesh</span><span class="p">(</span>
</span><span id="Problem-936"><a href="#Problem-936"><span class="linenos">936</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
</span><span id="Problem-937"><a href="#Problem-937"><span class="linenos">937</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Rmat</span> <span class="o">@</span> <span class="n">u_field</span><span class="p">,</span>
</span><span id="Problem-938"><a href="#Problem-938"><span class="linenos">938</span></a>            <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="Problem-939"><a href="#Problem-939"><span class="linenos">939</span></a>        <span class="p">)</span>
</span><span id="Problem-940"><a href="#Problem-940"><span class="linenos">940</span></a>        <span class="n">u_vol_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rmat</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">u_vol_field</span>
</span><span id="Problem-941"><a href="#Problem-941"><span class="linenos">941</span></a>        <span class="k">return</span> <span class="n">u_vol_field</span>
</span></pre></div>


            <div class="docstring"><p>Virtual Image Correlation (VIC) problem definition and solver.</p>

<p>This class encapsulates the full setup of a surface-based VIC problem:
geometry, image model, regularization, constraints, and nonlinear solver.
A typical workflow is:
    1. Instantiate a Problem from a mesh and an image
    2. Call <code><a href="#Problem.solve">solve</a></code> to estimate the displacement field
    3. Export results using <code><a href="#Problem.save_paraview">save_paraview</a></code> or propagate them to a volume mesh</p>

<h6 id="attributes">Attributes</h6>

<ul>
<li><strong>mesh</strong> (Mesh):
Surface mesh used in the VIC problem.</li>
<li><strong>image</strong> (np.ndarray):
Image converted to floating-point format for computations.</li>
<li><strong>fg, bg</strong> (float):
Estimated or user-defined foreground and background gray levels.</li>
<li><strong>Rmat</strong> (np.ndarray):
Rotation matrix resulting from ICP initialization.</li>
<li><strong>tvec</strong> (np.ndarray):
Translation vector resulting from ICP initialization.</li>
<li><strong>image_energies</strong> (list[VirtualImageCorrelationEnergyElem]):
Image energy elements used to assemble the VIC objective.</li>
<li><strong>constraints</strong> (DirichletConstraintHandler):
Handler storing linear equality constraints (e.g. CÂ¹ continuity).</li>
<li><strong>dirichlet</strong> (Dirichlet):
Dirichlet constraint object derived from the constraint handler.</li>
<li><strong>membrane_K</strong> (scipy.sparse.spmatrix):
Membrane stiffness matrix used for regularization.</li>
<li><strong>membrane_weight</strong> (float):
Weight associated with the membrane regularization term.</li>
<li><strong>initial_rho</strong> (float):
Initial value of the distance scaling parameter.</li>
<li><strong>saved_data_0</strong> (list[dict[str, np.ndarray]]):
Cached image energy data from the first iteration, used for
post-processing and visualization.</li>
</ul>
</div>


                            <div id="Problem.__init__" class="classattr">
                                        <input id="Problem.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Problem</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">mesh</span><span class="p">:</span> <span class="n"><a href="Mesh.html#Mesh">volVIC.Mesh.Mesh</a></span>,</span><span class="param">	<span class="n">image</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">uint16</span><span class="p">]</span>,</span><span class="param">	<span class="n">ICP_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">reversed_normals</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">fg_bg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">fg_bg_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;otsu&#39;</span><span class="p">,</span> <span class="s1">&#39;interp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;otsu&#39;</span>,</span><span class="param">	<span class="n">virtual_image</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">]]]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">g_slide</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">h</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">width_dx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span>,</span><span class="param">	<span class="n">surf_dx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">alpha</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="mf">0.0</span>,</span><span class="param">	<span class="n">C1_mode</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NoneType</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">membrane_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">initial_rho</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span>,</span><span class="param">	<span class="n">expected_mean_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span>,</span><span class="param">	<span class="n">n_intg_membrane_weight_comput</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>,</span><span class="param">	<span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span>)</span>

                <label class="view-source-button" for="Problem.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Problem.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Problem.__init__-90"><a href="#Problem.__init__-90"><span class="linenos"> 90</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="Problem.__init__-91"><a href="#Problem.__init__-91"><span class="linenos"> 91</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Problem.__init__-92"><a href="#Problem.__init__-92"><span class="linenos"> 92</span></a>        <span class="n">mesh</span><span class="p">:</span> <span class="n">Mesh</span><span class="p">,</span>
</span><span id="Problem.__init__-93"><a href="#Problem.__init__-93"><span class="linenos"> 93</span></a>        <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">],</span>
</span><span id="Problem.__init__-94"><a href="#Problem.__init__-94"><span class="linenos"> 94</span></a>        <span class="n">ICP_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem.__init__-95"><a href="#Problem.__init__-95"><span class="linenos"> 95</span></a>        <span class="n">reversed_normals</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Problem.__init__-96"><a href="#Problem.__init__-96"><span class="linenos"> 96</span></a>        <span class="n">fg_bg</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem.__init__-97"><a href="#Problem.__init__-97"><span class="linenos"> 97</span></a>        <span class="n">fg_bg_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;otsu&quot;</span><span class="p">,</span> <span class="s2">&quot;interp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;otsu&quot;</span><span class="p">,</span>
</span><span id="Problem.__init__-98"><a href="#Problem.__init__-98"><span class="linenos"> 98</span></a>        <span class="n">virtual_image</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
</span><span id="Problem.__init__-99"><a href="#Problem.__init__-99"><span class="linenos"> 99</span></a>            <span class="p">[</span>
</span><span id="Problem.__init__-100"><a href="#Problem.__init__-100"><span class="linenos">100</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
</span><span id="Problem.__init__-101"><a href="#Problem.__init__-101"><span class="linenos">101</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
</span><span id="Problem.__init__-102"><a href="#Problem.__init__-102"><span class="linenos">102</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
</span><span id="Problem.__init__-103"><a href="#Problem.__init__-103"><span class="linenos">103</span></a>                <span class="nb">float</span><span class="p">,</span>
</span><span id="Problem.__init__-104"><a href="#Problem.__init__-104"><span class="linenos">104</span></a>            <span class="p">],</span>
</span><span id="Problem.__init__-105"><a href="#Problem.__init__-105"><span class="linenos">105</span></a>            <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]],</span>
</span><span id="Problem.__init__-106"><a href="#Problem.__init__-106"><span class="linenos">106</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">g_slide</span><span class="p">,</span>
</span><span id="Problem.__init__-107"><a href="#Problem.__init__-107"><span class="linenos">107</span></a>        <span class="n">h</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem.__init__-108"><a href="#Problem.__init__-108"><span class="linenos">108</span></a>        <span class="n">width_dx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
</span><span id="Problem.__init__-109"><a href="#Problem.__init__-109"><span class="linenos">109</span></a>        <span class="n">surf_dx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="Problem.__init__-110"><a href="#Problem.__init__-110"><span class="linenos">110</span></a>        <span class="n">alpha</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="Problem.__init__-111"><a href="#Problem.__init__-111"><span class="linenos">111</span></a>        <span class="n">C1_mode</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="Problem.__init__-112"><a href="#Problem.__init__-112"><span class="linenos">112</span></a>            <span class="kc">None</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">]</span>
</span><span id="Problem.__init__-113"><a href="#Problem.__init__-113"><span class="linenos">113</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem.__init__-114"><a href="#Problem.__init__-114"><span class="linenos">114</span></a>        <span class="n">membrane_weight</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem.__init__-115"><a href="#Problem.__init__-115"><span class="linenos">115</span></a>        <span class="n">initial_rho</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
</span><span id="Problem.__init__-116"><a href="#Problem.__init__-116"><span class="linenos">116</span></a>        <span class="n">expected_mean_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
</span><span id="Problem.__init__-117"><a href="#Problem.__init__-117"><span class="linenos">117</span></a>        <span class="n">n_intg_membrane_weight_comput</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
</span><span id="Problem.__init__-118"><a href="#Problem.__init__-118"><span class="linenos">118</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Problem.__init__-119"><a href="#Problem.__init__-119"><span class="linenos">119</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem.__init__-120"><a href="#Problem.__init__-120"><span class="linenos">120</span></a>    <span class="p">):</span>
</span><span id="Problem.__init__-121"><a href="#Problem.__init__-121"><span class="linenos">121</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem.__init__-122"><a href="#Problem.__init__-122"><span class="linenos">122</span></a><span class="sd">        Initialize a Virtual Image Correlation (VIC) problem.</span>
</span><span id="Problem.__init__-123"><a href="#Problem.__init__-123"><span class="linenos">123</span></a>
</span><span id="Problem.__init__-124"><a href="#Problem.__init__-124"><span class="linenos">124</span></a><span class="sd">        This constructor performs the full problem setup, including:</span>
</span><span id="Problem.__init__-125"><a href="#Problem.__init__-125"><span class="linenos">125</span></a><span class="sd">        - foreground/background gray-level estimation,</span>
</span><span id="Problem.__init__-126"><a href="#Problem.__init__-126"><span class="linenos">126</span></a><span class="sd">        - optional rigid-body ICP alignment between mesh and image,</span>
</span><span id="Problem.__init__-127"><a href="#Problem.__init__-127"><span class="linenos">127</span></a><span class="sd">        - construction of virtual image energies,</span>
</span><span id="Problem.__init__-128"><a href="#Problem.__init__-128"><span class="linenos">128</span></a><span class="sd">        - assembly of CÂ¹ continuity constraints,</span>
</span><span id="Problem.__init__-129"><a href="#Problem.__init__-129"><span class="linenos">129</span></a><span class="sd">        - assembly of membrane regularization,</span>
</span><span id="Problem.__init__-130"><a href="#Problem.__init__-130"><span class="linenos">130</span></a><span class="sd">        - estimation of the coresponding regularization weight,</span>
</span><span id="Problem.__init__-131"><a href="#Problem.__init__-131"><span class="linenos">131</span></a><span class="sd">        - initialization of all data structures required by the nonlinear solver.</span>
</span><span id="Problem.__init__-132"><a href="#Problem.__init__-132"><span class="linenos">132</span></a>
</span><span id="Problem.__init__-133"><a href="#Problem.__init__-133"><span class="linenos">133</span></a><span class="sd">        After initialization, the problem is ready to be solved using</span>
</span><span id="Problem.__init__-134"><a href="#Problem.__init__-134"><span class="linenos">134</span></a><span class="sd">        :meth:`solve`, which performs a GaussâNewton optimization to estimate</span>
</span><span id="Problem.__init__-135"><a href="#Problem.__init__-135"><span class="linenos">135</span></a><span class="sd">        the displacement field and the distance scaling parameter.</span>
</span><span id="Problem.__init__-136"><a href="#Problem.__init__-136"><span class="linenos">136</span></a>
</span><span id="Problem.__init__-137"><a href="#Problem.__init__-137"><span class="linenos">137</span></a><span class="sd">        The mesh coordinates are assumed to be expressed in image voxel units.</span>
</span><span id="Problem.__init__-138"><a href="#Problem.__init__-138"><span class="linenos">138</span></a><span class="sd">        No unit conversion or rescaling is performed internally.</span>
</span><span id="Problem.__init__-139"><a href="#Problem.__init__-139"><span class="linenos">139</span></a>
</span><span id="Problem.__init__-140"><a href="#Problem.__init__-140"><span class="linenos">140</span></a><span class="sd">        Parameters</span>
</span><span id="Problem.__init__-141"><a href="#Problem.__init__-141"><span class="linenos">141</span></a><span class="sd">        ----------</span>
</span><span id="Problem.__init__-142"><a href="#Problem.__init__-142"><span class="linenos">142</span></a><span class="sd">        mesh : Mesh</span>
</span><span id="Problem.__init__-143"><a href="#Problem.__init__-143"><span class="linenos">143</span></a><span class="sd">            Surface mesh defining the geometry to be matched to the image.</span>
</span><span id="Problem.__init__-144"><a href="#Problem.__init__-144"><span class="linenos">144</span></a><span class="sd">            The mesh coordinates must be expressed in image voxel units.</span>
</span><span id="Problem.__init__-145"><a href="#Problem.__init__-145"><span class="linenos">145</span></a><span class="sd">            Any conversion from physical units (e.g. mm or m) to voxel coordinates</span>
</span><span id="Problem.__init__-146"><a href="#Problem.__init__-146"><span class="linenos">146</span></a><span class="sd">            must be performed beforehand by the user.</span>
</span><span id="Problem.__init__-147"><a href="#Problem.__init__-147"><span class="linenos">147</span></a><span class="sd">            If `ICP_init=True`, a rigid-body alignment is performed, but this</span>
</span><span id="Problem.__init__-148"><a href="#Problem.__init__-148"><span class="linenos">148</span></a><span class="sd">            does not handle unit conversion or rescaling. ICP only corrects</span>
</span><span id="Problem.__init__-149"><a href="#Problem.__init__-149"><span class="linenos">149</span></a><span class="sd">            for rotation and translation, assuming consistent units.</span>
</span><span id="Problem.__init__-150"><a href="#Problem.__init__-150"><span class="linenos">150</span></a>
</span><span id="Problem.__init__-151"><a href="#Problem.__init__-151"><span class="linenos">151</span></a><span class="sd">        image : np.ndarray[np.uint16]</span>
</span><span id="Problem.__init__-152"><a href="#Problem.__init__-152"><span class="linenos">152</span></a><span class="sd">            3D volumetric image (e.g. CT scan). The gray-level distribution is</span>
</span><span id="Problem.__init__-153"><a href="#Problem.__init__-153"><span class="linenos">153</span></a><span class="sd">            assumed to be bimodal (background / foreground).</span>
</span><span id="Problem.__init__-154"><a href="#Problem.__init__-154"><span class="linenos">154</span></a>
</span><span id="Problem.__init__-155"><a href="#Problem.__init__-155"><span class="linenos">155</span></a><span class="sd">        ICP_init : bool, optional</span>
</span><span id="Problem.__init__-156"><a href="#Problem.__init__-156"><span class="linenos">156</span></a><span class="sd">            If `True` (default), a rigid-body ICP is performed to align the mesh</span>
</span><span id="Problem.__init__-157"><a href="#Problem.__init__-157"><span class="linenos">157</span></a><span class="sd">            with the image prior to solving the VIC problem.</span>
</span><span id="Problem.__init__-158"><a href="#Problem.__init__-158"><span class="linenos">158</span></a><span class="sd">            Disable only if the mesh is already well aligned.</span>
</span><span id="Problem.__init__-159"><a href="#Problem.__init__-159"><span class="linenos">159</span></a>
</span><span id="Problem.__init__-160"><a href="#Problem.__init__-160"><span class="linenos">160</span></a><span class="sd">        reversed_normals : bool, optional</span>
</span><span id="Problem.__init__-161"><a href="#Problem.__init__-161"><span class="linenos">161</span></a><span class="sd">            If `True`, swaps the foreground/background convention in the virtual</span>
</span><span id="Problem.__init__-162"><a href="#Problem.__init__-162"><span class="linenos">162</span></a><span class="sd">            image model. Useful if the mesh normals are oriented inward instead</span>
</span><span id="Problem.__init__-163"><a href="#Problem.__init__-163"><span class="linenos">163</span></a><span class="sd">            of outward. By default, `False`.</span>
</span><span id="Problem.__init__-164"><a href="#Problem.__init__-164"><span class="linenos">164</span></a>
</span><span id="Problem.__init__-165"><a href="#Problem.__init__-165"><span class="linenos">165</span></a><span class="sd">        fg_bg : tuple[float, float] or None, optional</span>
</span><span id="Problem.__init__-166"><a href="#Problem.__init__-166"><span class="linenos">166</span></a><span class="sd">            Tuple `(fg, bg)` specifying the foreground and background gray levels.</span>
</span><span id="Problem.__init__-167"><a href="#Problem.__init__-167"><span class="linenos">167</span></a><span class="sd">            If `None` (default), these values are automatically estimated from the</span>
</span><span id="Problem.__init__-168"><a href="#Problem.__init__-168"><span class="linenos">168</span></a><span class="sd">            image.</span>
</span><span id="Problem.__init__-169"><a href="#Problem.__init__-169"><span class="linenos">169</span></a>
</span><span id="Problem.__init__-170"><a href="#Problem.__init__-170"><span class="linenos">170</span></a><span class="sd">        fg_bg_method : Literal[&quot;otsu&quot;, &quot;interp&quot;], optional</span>
</span><span id="Problem.__init__-171"><a href="#Problem.__init__-171"><span class="linenos">171</span></a><span class="sd">            Method to compute the foreground and background gray levels. `&#39;otsu&#39;`</span>
</span><span id="Problem.__init__-172"><a href="#Problem.__init__-172"><span class="linenos">172</span></a><span class="sd">            uses :func:`image_utils.otsu_threshold` to compute the gray levels based</span>
</span><span id="Problem.__init__-173"><a href="#Problem.__init__-173"><span class="linenos">173</span></a><span class="sd">            on Otsu&#39;s method. `&#39;interp&#39;` uses :func:`image_utils.interp_fg_bg` to</span>
</span><span id="Problem.__init__-174"><a href="#Problem.__init__-174"><span class="linenos">174</span></a><span class="sd">            compute the gray levels using interpolation of histogram peaks.</span>
</span><span id="Problem.__init__-175"><a href="#Problem.__init__-175"><span class="linenos">175</span></a><span class="sd">            Default is `&#39;otsu&#39;`.</span>
</span><span id="Problem.__init__-176"><a href="#Problem.__init__-176"><span class="linenos">176</span></a>
</span><span id="Problem.__init__-177"><a href="#Problem.__init__-177"><span class="linenos">177</span></a><span class="sd">        virtual_image : Callable, optional</span>
</span><span id="Problem.__init__-178"><a href="#Problem.__init__-178"><span class="linenos">178</span></a><span class="sd">            Virtual image model mapping signed distance values to gray levels.</span>
</span><span id="Problem.__init__-179"><a href="#Problem.__init__-179"><span class="linenos">179</span></a><span class="sd">            The default (`g_slide`) is suitable for sharp material/background</span>
</span><span id="Problem.__init__-180"><a href="#Problem.__init__-180"><span class="linenos">180</span></a><span class="sd">            transitions. See :func:`virtual_image.g_slide` for the function</span>
</span><span id="Problem.__init__-181"><a href="#Problem.__init__-181"><span class="linenos">181</span></a><span class="sd">            signature.</span>
</span><span id="Problem.__init__-182"><a href="#Problem.__init__-182"><span class="linenos">182</span></a>
</span><span id="Problem.__init__-183"><a href="#Problem.__init__-183"><span class="linenos">183</span></a><span class="sd">        h : float or None, optional</span>
</span><span id="Problem.__init__-184"><a href="#Problem.__init__-184"><span class="linenos">184</span></a><span class="sd">            Half-width of the search domain along surface normals.</span>
</span><span id="Problem.__init__-185"><a href="#Problem.__init__-185"><span class="linenos">185</span></a><span class="sd">            If `None` (default), `h` is automatically estimated from the image</span>
</span><span id="Problem.__init__-186"><a href="#Problem.__init__-186"><span class="linenos">186</span></a><span class="sd">            during initialization.</span>
</span><span id="Problem.__init__-187"><a href="#Problem.__init__-187"><span class="linenos">187</span></a>
</span><span id="Problem.__init__-188"><a href="#Problem.__init__-188"><span class="linenos">188</span></a><span class="sd">        width_dx : float, optional</span>
</span><span id="Problem.__init__-189"><a href="#Problem.__init__-189"><span class="linenos">189</span></a><span class="sd">            Integration step along the normal direction for image energies.</span>
</span><span id="Problem.__init__-190"><a href="#Problem.__init__-190"><span class="linenos">190</span></a>
</span><span id="Problem.__init__-191"><a href="#Problem.__init__-191"><span class="linenos">191</span></a><span class="sd">        surf_dx : float, optional</span>
</span><span id="Problem.__init__-192"><a href="#Problem.__init__-192"><span class="linenos">192</span></a><span class="sd">            Integration step along the surface for image energies.</span>
</span><span id="Problem.__init__-193"><a href="#Problem.__init__-193"><span class="linenos">193</span></a>
</span><span id="Problem.__init__-194"><a href="#Problem.__init__-194"><span class="linenos">194</span></a><span class="sd">        alpha : float or tuple, optional</span>
</span><span id="Problem.__init__-195"><a href="#Problem.__init__-195"><span class="linenos">195</span></a><span class="sd">            Tangential regularization weight used in the image energies.</span>
</span><span id="Problem.__init__-196"><a href="#Problem.__init__-196"><span class="linenos">196</span></a><span class="sd">            A value of 0.0 (default) disables tangential smoothing.</span>
</span><span id="Problem.__init__-197"><a href="#Problem.__init__-197"><span class="linenos">197</span></a>
</span><span id="Problem.__init__-198"><a href="#Problem.__init__-198"><span class="linenos">198</span></a><span class="sd">        C1_mode : {&quot;auto&quot;, &quot;none&quot;, &quot;all&quot;} or np.ndarray or None, optional</span>
</span><span id="Problem.__init__-199"><a href="#Problem.__init__-199"><span class="linenos">199</span></a><span class="sd">            Definition of CÂ¹ continuity constraints between patches:</span>
</span><span id="Problem.__init__-200"><a href="#Problem.__init__-200"><span class="linenos">200</span></a><span class="sd">                - &quot;auto&quot;: automatically selected constraints (recommended)</span>
</span><span id="Problem.__init__-201"><a href="#Problem.__init__-201"><span class="linenos">201</span></a><span class="sd">                - &quot;none&quot;: no CÂ¹ constraints</span>
</span><span id="Problem.__init__-202"><a href="#Problem.__init__-202"><span class="linenos">202</span></a><span class="sd">                - &quot;all&quot;: enforce CÂ¹ everywhere</span>
</span><span id="Problem.__init__-203"><a href="#Problem.__init__-203"><span class="linenos">203</span></a><span class="sd">                - array: user-defined triplets of constrained control points</span>
</span><span id="Problem.__init__-204"><a href="#Problem.__init__-204"><span class="linenos">204</span></a>
</span><span id="Problem.__init__-205"><a href="#Problem.__init__-205"><span class="linenos">205</span></a><span class="sd">        membrane_weight : float or None, optional</span>
</span><span id="Problem.__init__-206"><a href="#Problem.__init__-206"><span class="linenos">206</span></a><span class="sd">            Weight of the membrane (elastic) regularization term.</span>
</span><span id="Problem.__init__-207"><a href="#Problem.__init__-207"><span class="linenos">207</span></a><span class="sd">            If None (default), the weight is automatically calibrated.</span>
</span><span id="Problem.__init__-208"><a href="#Problem.__init__-208"><span class="linenos">208</span></a>
</span><span id="Problem.__init__-209"><a href="#Problem.__init__-209"><span class="linenos">209</span></a><span class="sd">        initial_rho : float, optional</span>
</span><span id="Problem.__init__-210"><a href="#Problem.__init__-210"><span class="linenos">210</span></a><span class="sd">            Initial value of the transition distance parameter used in the VIC model.</span>
</span><span id="Problem.__init__-211"><a href="#Problem.__init__-211"><span class="linenos">211</span></a>
</span><span id="Problem.__init__-212"><a href="#Problem.__init__-212"><span class="linenos">212</span></a><span class="sd">        expected_mean_dist : float, optional</span>
</span><span id="Problem.__init__-213"><a href="#Problem.__init__-213"><span class="linenos">213</span></a><span class="sd">            Expected mean distance (in image units) used for automatic membrane</span>
</span><span id="Problem.__init__-214"><a href="#Problem.__init__-214"><span class="linenos">214</span></a><span class="sd">            weight calibration.</span>
</span><span id="Problem.__init__-215"><a href="#Problem.__init__-215"><span class="linenos">215</span></a>
</span><span id="Problem.__init__-216"><a href="#Problem.__init__-216"><span class="linenos">216</span></a><span class="sd">        n_intg_membrane_weight_comput : int, optional</span>
</span><span id="Problem.__init__-217"><a href="#Problem.__init__-217"><span class="linenos">217</span></a><span class="sd">            Number of integration points used to compute the membrane weight</span>
</span><span id="Problem.__init__-218"><a href="#Problem.__init__-218"><span class="linenos">218</span></a><span class="sd">            when it is determined automatically.</span>
</span><span id="Problem.__init__-219"><a href="#Problem.__init__-219"><span class="linenos">219</span></a>
</span><span id="Problem.__init__-220"><a href="#Problem.__init__-220"><span class="linenos">220</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="Problem.__init__-221"><a href="#Problem.__init__-221"><span class="linenos">221</span></a><span class="sd">            If True, disables parallel execution (useful for debugging or</span>
</span><span id="Problem.__init__-222"><a href="#Problem.__init__-222"><span class="linenos">222</span></a><span class="sd">            reproducibility).</span>
</span><span id="Problem.__init__-223"><a href="#Problem.__init__-223"><span class="linenos">223</span></a>
</span><span id="Problem.__init__-224"><a href="#Problem.__init__-224"><span class="linenos">224</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="Problem.__init__-225"><a href="#Problem.__init__-225"><span class="linenos">225</span></a><span class="sd">            If True, prints detailed information during initialization and</span>
</span><span id="Problem.__init__-226"><a href="#Problem.__init__-226"><span class="linenos">226</span></a><span class="sd">            subsequent computations.</span>
</span><span id="Problem.__init__-227"><a href="#Problem.__init__-227"><span class="linenos">227</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem.__init__-228"><a href="#Problem.__init__-228"><span class="linenos">228</span></a>
</span><span id="Problem.__init__-229"><a href="#Problem.__init__-229"><span class="linenos">229</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.__init__-230"><a href="#Problem.__init__-230"><span class="linenos">230</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Initializing VIC problem&quot;</span><span class="p">)</span>
</span><span id="Problem.__init__-231"><a href="#Problem.__init__-231"><span class="linenos">231</span></a>
</span><span id="Problem.__init__-232"><a href="#Problem.__init__-232"><span class="linenos">232</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>
</span><span id="Problem.__init__-233"><a href="#Problem.__init__-233"><span class="linenos">233</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span>
</span><span id="Problem.__init__-234"><a href="#Problem.__init__-234"><span class="linenos">234</span></a>
</span><span id="Problem.__init__-235"><a href="#Problem.__init__-235"><span class="linenos">235</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.__init__-236"><a href="#Problem.__init__-236"><span class="linenos">236</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] Image shape: </span><span class="si">{</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, dtype: </span><span class="si">{</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem.__init__-237"><a href="#Problem.__init__-237"><span class="linenos">237</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] Mesh: </span><span class="si">{</span><span class="n">mesh</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem.__init__-238"><a href="#Problem.__init__-238"><span class="linenos">238</span></a>
</span><span id="Problem.__init__-239"><a href="#Problem.__init__-239"><span class="linenos">239</span></a>        <span class="c1"># --- Foreground / Background -------------------------------------------------</span>
</span><span id="Problem.__init__-240"><a href="#Problem.__init__-240"><span class="linenos">240</span></a>        <span class="k">if</span> <span class="n">fg_bg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Problem.__init__-241"><a href="#Problem.__init__-241"><span class="linenos">241</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.__init__-242"><a href="#Problem.__init__-242"><span class="linenos">242</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Estimating foreground/background levels from image&quot;</span><span class="p">)</span>
</span><span id="Problem.__init__-243"><a href="#Problem.__init__-243"><span class="linenos">243</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_fg_bg</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">fg_bg_method</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</span><span id="Problem.__init__-244"><a href="#Problem.__init__-244"><span class="linenos">244</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Problem.__init__-245"><a href="#Problem.__init__-245"><span class="linenos">245</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bg</span> <span class="o">=</span> <span class="n">fg_bg</span>
</span><span id="Problem.__init__-246"><a href="#Problem.__init__-246"><span class="linenos">246</span></a>
</span><span id="Problem.__init__-247"><a href="#Problem.__init__-247"><span class="linenos">247</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.__init__-248"><a href="#Problem.__init__-248"><span class="linenos">248</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] fg = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="si">}</span><span class="s2">, bg = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem.__init__-249"><a href="#Problem.__init__-249"><span class="linenos">249</span></a>
</span><span id="Problem.__init__-250"><a href="#Problem.__init__-250"><span class="linenos">250</span></a>        <span class="c1"># --- ICP + h initialization --------------------------------------------------</span>
</span><span id="Problem.__init__-251"><a href="#Problem.__init__-251"><span class="linenos">251</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.__init__-252"><a href="#Problem.__init__-252"><span class="linenos">252</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Initializing placement and research half width h&quot;</span><span class="p">)</span>
</span><span id="Problem.__init__-253"><a href="#Problem.__init__-253"><span class="linenos">253</span></a>
</span><span id="Problem.__init__-254"><a href="#Problem.__init__-254"><span class="linenos">254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Rmat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvec</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_h_mesh_ICP</span><span class="p">(</span>
</span><span id="Problem.__init__-255"><a href="#Problem.__init__-255"><span class="linenos">255</span></a>            <span class="n">ICP_init</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
</span><span id="Problem.__init__-256"><a href="#Problem.__init__-256"><span class="linenos">256</span></a>        <span class="p">)</span>
</span><span id="Problem.__init__-257"><a href="#Problem.__init__-257"><span class="linenos">257</span></a>
</span><span id="Problem.__init__-258"><a href="#Problem.__init__-258"><span class="linenos">258</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.__init__-259"><a href="#Problem.__init__-259"><span class="linenos">259</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] h = </span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem.__init__-260"><a href="#Problem.__init__-260"><span class="linenos">260</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] Rmat:</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Rmat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem.__init__-261"><a href="#Problem.__init__-261"><span class="linenos">261</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] tvec: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tvec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem.__init__-262"><a href="#Problem.__init__-262"><span class="linenos">262</span></a>
</span><span id="Problem.__init__-263"><a href="#Problem.__init__-263"><span class="linenos">263</span></a>        <span class="c1"># --- Virtual image ------------------------------------------------------------</span>
</span><span id="Problem.__init__-264"><a href="#Problem.__init__-264"><span class="linenos">264</span></a>        <span class="k">if</span> <span class="n">reversed_normals</span><span class="p">:</span>
</span><span id="Problem.__init__-265"><a href="#Problem.__init__-265"><span class="linenos">265</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.__init__-266"><a href="#Problem.__init__-266"><span class="linenos">266</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Using reversed normals for virtual image&quot;</span><span class="p">)</span>
</span><span id="Problem.__init__-267"><a href="#Problem.__init__-267"><span class="linenos">267</span></a>            <span class="n">g</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">virtual_image</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bg</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="p">)</span>
</span><span id="Problem.__init__-268"><a href="#Problem.__init__-268"><span class="linenos">268</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Problem.__init__-269"><a href="#Problem.__init__-269"><span class="linenos">269</span></a>            <span class="n">g</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">virtual_image</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bg</span><span class="p">)</span>
</span><span id="Problem.__init__-270"><a href="#Problem.__init__-270"><span class="linenos">270</span></a>
</span><span id="Problem.__init__-271"><a href="#Problem.__init__-271"><span class="linenos">271</span></a>        <span class="c1"># --- Image energies -----------------------------------------------------------</span>
</span><span id="Problem.__init__-272"><a href="#Problem.__init__-272"><span class="linenos">272</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.__init__-273"><a href="#Problem.__init__-273"><span class="linenos">273</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Building image energies&quot;</span><span class="p">)</span>
</span><span id="Problem.__init__-274"><a href="#Problem.__init__-274"><span class="linenos">274</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="Problem.__init__-275"><a href="#Problem.__init__-275"><span class="linenos">275</span></a>                <span class="sa">f</span><span class="s2">&quot;[VIC] Integration params: surf_dx=</span><span class="si">{</span><span class="n">surf_dx</span><span class="si">}</span><span class="s2">, width_dx=</span><span class="si">{</span><span class="n">width_dx</span><span class="si">}</span><span class="s2">, alpha=</span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Problem.__init__-276"><a href="#Problem.__init__-276"><span class="linenos">276</span></a>            <span class="p">)</span>
</span><span id="Problem.__init__-277"><a href="#Problem.__init__-277"><span class="linenos">277</span></a>
</span><span id="Problem.__init__-278"><a href="#Problem.__init__-278"><span class="linenos">278</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span> <span class="o">=</span> <span class="n">make_image_energies</span><span class="p">(</span>
</span><span id="Problem.__init__-279"><a href="#Problem.__init__-279"><span class="linenos">279</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
</span><span id="Problem.__init__-280"><a href="#Problem.__init__-280"><span class="linenos">280</span></a>            <span class="n">h</span><span class="p">,</span>
</span><span id="Problem.__init__-281"><a href="#Problem.__init__-281"><span class="linenos">281</span></a>            <span class="n">width_dx</span><span class="o">=</span><span class="n">width_dx</span><span class="p">,</span>
</span><span id="Problem.__init__-282"><a href="#Problem.__init__-282"><span class="linenos">282</span></a>            <span class="n">surf_dx</span><span class="o">=</span><span class="n">surf_dx</span><span class="p">,</span>
</span><span id="Problem.__init__-283"><a href="#Problem.__init__-283"><span class="linenos">283</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
</span><span id="Problem.__init__-284"><a href="#Problem.__init__-284"><span class="linenos">284</span></a>            <span class="n">virtual_image</span><span class="o">=</span><span class="n">g</span><span class="p">,</span>
</span><span id="Problem.__init__-285"><a href="#Problem.__init__-285"><span class="linenos">285</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="Problem.__init__-286"><a href="#Problem.__init__-286"><span class="linenos">286</span></a>            <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="Problem.__init__-287"><a href="#Problem.__init__-287"><span class="linenos">287</span></a>        <span class="p">)</span>
</span><span id="Problem.__init__-288"><a href="#Problem.__init__-288"><span class="linenos">288</span></a>
</span><span id="Problem.__init__-289"><a href="#Problem.__init__-289"><span class="linenos">289</span></a>        <span class="c1"># --- C1 constraints -----------------------------------------------------------</span>
</span><span id="Problem.__init__-290"><a href="#Problem.__init__-290"><span class="linenos">290</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.__init__-291"><a href="#Problem.__init__-291"><span class="linenos">291</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Building C1 constraints&quot;</span><span class="p">)</span>
</span><span id="Problem.__init__-292"><a href="#Problem.__init__-292"><span class="linenos">292</span></a>
</span><span id="Problem.__init__-293"><a href="#Problem.__init__-293"><span class="linenos">293</span></a>        <span class="n">C1_eqs</span> <span class="o">=</span> <span class="n">make_C1_eqs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">C1_mode</span><span class="p">)</span>
</span><span id="Problem.__init__-294"><a href="#Problem.__init__-294"><span class="linenos">294</span></a>
</span><span id="Problem.__init__-295"><a href="#Problem.__init__-295"><span class="linenos">295</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">DirichletConstraintHandler</span><span class="p">(</span>
</span><span id="Problem.__init__-296"><a href="#Problem.__init__-296"><span class="linenos">296</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">connectivity</span><span class="o">.</span><span class="n">nb_unique_nodes</span> <span class="o">*</span> <span class="mi">3</span>
</span><span id="Problem.__init__-297"><a href="#Problem.__init__-297"><span class="linenos">297</span></a>        <span class="p">)</span>
</span><span id="Problem.__init__-298"><a href="#Problem.__init__-298"><span class="linenos">298</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">add_eqs</span><span class="p">(</span><span class="n">C1_eqs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">C1_eqs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">))</span>
</span><span id="Problem.__init__-299"><a href="#Problem.__init__-299"><span class="linenos">299</span></a>
</span><span id="Problem.__init__-300"><a href="#Problem.__init__-300"><span class="linenos">300</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.__init__-301"><a href="#Problem.__init__-301"><span class="linenos">301</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] Number of C1 equations: </span><span class="si">{</span><span class="n">C1_eqs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem.__init__-302"><a href="#Problem.__init__-302"><span class="linenos">302</span></a>
</span><span id="Problem.__init__-303"><a href="#Problem.__init__-303"><span class="linenos">303</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dirichlet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_dirichlet</span><span class="p">()</span>
</span><span id="Problem.__init__-304"><a href="#Problem.__init__-304"><span class="linenos">304</span></a>
</span><span id="Problem.__init__-305"><a href="#Problem.__init__-305"><span class="linenos">305</span></a>        <span class="c1"># --- Membrane stiffness -------------------------------------------------------</span>
</span><span id="Problem.__init__-306"><a href="#Problem.__init__-306"><span class="linenos">306</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.__init__-307"><a href="#Problem.__init__-307"><span class="linenos">307</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Assembling membrane stiffness matrix&quot;</span><span class="p">)</span>
</span><span id="Problem.__init__-308"><a href="#Problem.__init__-308"><span class="linenos">308</span></a>
</span><span id="Problem.__init__-309"><a href="#Problem.__init__-309"><span class="linenos">309</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">membrane_K</span> <span class="o">=</span> <span class="n">make_membrane_stifness</span><span class="p">(</span>
</span><span id="Problem.__init__-310"><a href="#Problem.__init__-310"><span class="linenos">310</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span>
</span><span id="Problem.__init__-311"><a href="#Problem.__init__-311"><span class="linenos">311</span></a>        <span class="p">)</span>
</span><span id="Problem.__init__-312"><a href="#Problem.__init__-312"><span class="linenos">312</span></a>
</span><span id="Problem.__init__-313"><a href="#Problem.__init__-313"><span class="linenos">313</span></a>        <span class="c1"># --- Membrane weight ----------------------------------------------------------</span>
</span><span id="Problem.__init__-314"><a href="#Problem.__init__-314"><span class="linenos">314</span></a>        <span class="k">if</span> <span class="n">membrane_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Problem.__init__-315"><a href="#Problem.__init__-315"><span class="linenos">315</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.__init__-316"><a href="#Problem.__init__-316"><span class="linenos">316</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Computing membrane weight automatically&quot;</span><span class="p">)</span>
</span><span id="Problem.__init__-317"><a href="#Problem.__init__-317"><span class="linenos">317</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="Problem.__init__-318"><a href="#Problem.__init__-318"><span class="linenos">318</span></a>                    <span class="sa">f</span><span class="s2">&quot;[VIC] initial_rho=</span><span class="si">{</span><span class="n">initial_rho</span><span class="si">}</span><span class="s2">, expected_mean_dist=</span><span class="si">{</span><span class="n">expected_mean_dist</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Problem.__init__-319"><a href="#Problem.__init__-319"><span class="linenos">319</span></a>                <span class="p">)</span>
</span><span id="Problem.__init__-320"><a href="#Problem.__init__-320"><span class="linenos">320</span></a>
</span><span id="Problem.__init__-321"><a href="#Problem.__init__-321"><span class="linenos">321</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">make_membrane_weight</span><span class="p">(</span>
</span><span id="Problem.__init__-322"><a href="#Problem.__init__-322"><span class="linenos">322</span></a>                <span class="n">initial_rho</span><span class="p">,</span>
</span><span id="Problem.__init__-323"><a href="#Problem.__init__-323"><span class="linenos">323</span></a>                <span class="n">expected_mean_dist</span><span class="o">=</span><span class="n">expected_mean_dist</span><span class="p">,</span>
</span><span id="Problem.__init__-324"><a href="#Problem.__init__-324"><span class="linenos">324</span></a>                <span class="n">n_intg</span><span class="o">=</span><span class="n">n_intg_membrane_weight_comput</span><span class="p">,</span>
</span><span id="Problem.__init__-325"><a href="#Problem.__init__-325"><span class="linenos">325</span></a>            <span class="p">)</span>
</span><span id="Problem.__init__-326"><a href="#Problem.__init__-326"><span class="linenos">326</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.__init__-327"><a href="#Problem.__init__-327"><span class="linenos">327</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] Computed membrane weight : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">membrane_weight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem.__init__-328"><a href="#Problem.__init__-328"><span class="linenos">328</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Problem.__init__-329"><a href="#Problem.__init__-329"><span class="linenos">329</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">membrane_weight</span> <span class="o">=</span> <span class="n">membrane_weight</span>
</span><span id="Problem.__init__-330"><a href="#Problem.__init__-330"><span class="linenos">330</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.__init__-331"><a href="#Problem.__init__-331"><span class="linenos">331</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] Using user-defined membrane_weight = </span><span class="si">{</span><span class="n">membrane_weight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem.__init__-332"><a href="#Problem.__init__-332"><span class="linenos">332</span></a>
</span><span id="Problem.__init__-333"><a href="#Problem.__init__-333"><span class="linenos">333</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">initial_rho</span> <span class="o">=</span> <span class="n">initial_rho</span>
</span><span id="Problem.__init__-334"><a href="#Problem.__init__-334"><span class="linenos">334</span></a>
</span><span id="Problem.__init__-335"><a href="#Problem.__init__-335"><span class="linenos">335</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
</span><span id="Problem.__init__-336"><a href="#Problem.__init__-336"><span class="linenos">336</span></a>            <span class="nb">float</span>
</span><span id="Problem.__init__-337"><a href="#Problem.__init__-337"><span class="linenos">337</span></a>        <span class="p">)</span>  <span class="c1"># TODO remove casting by adapting interpolation</span>
</span><span id="Problem.__init__-338"><a href="#Problem.__init__-338"><span class="linenos">338</span></a>
</span><span id="Problem.__init__-339"><a href="#Problem.__init__-339"><span class="linenos">339</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.__init__-340"><a href="#Problem.__init__-340"><span class="linenos">340</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[VIC] Initialization done â&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize a Virtual Image Correlation (VIC) problem.</p>

<p>This constructor performs the full problem setup, including:</p>

<ul>
<li>foreground/background gray-level estimation,</li>
<li>optional rigid-body ICP alignment between mesh and image,</li>
<li>construction of virtual image energies,</li>
<li>assembly of CÂ¹ continuity constraints,</li>
<li>assembly of membrane regularization,</li>
<li>estimation of the coresponding regularization weight,</li>
<li>initialization of all data structures required by the nonlinear solver.</li>
</ul>

<p>After initialization, the problem is ready to be solved using
<code><a href="#Problem.solve">solve()</a></code>, which performs a GaussâNewton optimization to estimate
the displacement field and the distance scaling parameter.</p>

<p>The mesh coordinates are assumed to be expressed in image voxel units.
No unit conversion or rescaling is performed internally.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>mesh</strong> (Mesh):
Surface mesh defining the geometry to be matched to the image.
The mesh coordinates must be expressed in image voxel units.
Any conversion from physical units (e.g. mm or m) to voxel coordinates
must be performed beforehand by the user.
If <code>ICP_init=True</code>, a rigid-body alignment is performed, but this
does not handle unit conversion or rescaling. ICP only corrects
for rotation and translation, assuming consistent units.</li>
<li><strong>image</strong> (np.ndarray[np.uint16]):
3D volumetric image (e.g. CT scan). The gray-level distribution is
assumed to be bimodal (background / foreground).</li>
<li><strong>ICP_init</strong> (bool, optional):
If <code>True</code> (default), a rigid-body ICP is performed to align the mesh
with the image prior to solving the VIC problem.
Disable only if the mesh is already well aligned.</li>
<li><strong>reversed_normals</strong> (bool, optional):
If <code>True</code>, swaps the foreground/background convention in the virtual
image model. Useful if the mesh normals are oriented inward instead
of outward. By default, <code>False</code>.</li>
<li><strong>fg_bg</strong> (tuple[float, float] or None, optional):
Tuple <code>(fg, bg)</code> specifying the foreground and background gray levels.
If <code>None</code> (default), these values are automatically estimated from the
image.</li>
<li><strong>fg_bg_method</strong> (Literal["otsu", "interp"], optional):
Method to compute the foreground and background gray levels. <code>'otsu'</code>
uses <code>image_utils.otsu_threshold()</code> to compute the gray levels based
on Otsu's method. <code>'interp'</code> uses <code>image_utils.interp_fg_bg()</code> to
compute the gray levels using interpolation of histogram peaks.
Default is <code>'otsu'</code>.</li>
<li><strong>virtual_image</strong> (Callable, optional):
Virtual image model mapping signed distance values to gray levels.
The default (<code>g_slide</code>) is suitable for sharp material/background
transitions. See <code>virtual_image.g_slide()</code> for the function
signature.</li>
<li><strong>h</strong> (float or None, optional):
Half-width of the search domain along surface normals.
If <code>None</code> (default), <code>h</code> is automatically estimated from the image
during initialization.</li>
<li><strong>width_dx</strong> (float, optional):
Integration step along the normal direction for image energies.</li>
<li><strong>surf_dx</strong> (float, optional):
Integration step along the surface for image energies.</li>
<li><strong>alpha</strong> (float or tuple, optional):
Tangential regularization weight used in the image energies.
A value of 0.0 (default) disables tangential smoothing.</li>
<li><strong>C1_mode</strong> ({"auto", "none", "all"} or np.ndarray or None, optional):
Definition of CÂ¹ continuity constraints between patches:
    - "auto": automatically selected constraints (recommended)
    - "none": no CÂ¹ constraints
    - "all": enforce CÂ¹ everywhere
    - array: user-defined triplets of constrained control points</li>
<li><strong>membrane_weight</strong> (float or None, optional):
Weight of the membrane (elastic) regularization term.
If None (default), the weight is automatically calibrated.</li>
<li><strong>initial_rho</strong> (float, optional):
Initial value of the transition distance parameter used in the VIC model.</li>
<li><strong>expected_mean_dist</strong> (float, optional):
Expected mean distance (in image units) used for automatic membrane
weight calibration.</li>
<li><strong>n_intg_membrane_weight_comput</strong> (int, optional):
Number of integration points used to compute the membrane weight
when it is determined automatically.</li>
<li><strong>disable_parallel</strong> (bool, optional):
If True, disables parallel execution (useful for debugging or
reproducibility).</li>
<li><strong>verbose</strong> (bool, optional):
If True, prints detailed information during initialization and
subsequent computations.</li>
</ul>
</div>


                            </div>
                            <div id="Problem.mesh" class="classattr">
                                <div class="attr variable">
            <span class="name">mesh</span><span class="annotation">: <a href="Mesh.html#Mesh">volVIC.Mesh.Mesh</a></span>

        
    </div>
    <a class="headerlink" href="#Problem.mesh"></a>
    
    

                            </div>
                            <div id="Problem.image" class="classattr">
                                <div class="attr variable">
            <span class="name">image</span><span class="annotation">: numpy.ndarray[numpy.uint16]</span>

        
    </div>
    <a class="headerlink" href="#Problem.image"></a>
    
    

                            </div>
                            <div id="Problem.fg" class="classattr">
                                <div class="attr variable">
            <span class="name">fg</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#Problem.fg"></a>
    
    

                            </div>
                            <div id="Problem.bg" class="classattr">
                                <div class="attr variable">
            <span class="name">bg</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#Problem.bg"></a>
    
    

                            </div>
                            <div id="Problem.Rmat" class="classattr">
                                <div class="attr variable">
            <span class="name">Rmat</span><span class="annotation">: numpy.ndarray[numpy.floating]</span>

        
    </div>
    <a class="headerlink" href="#Problem.Rmat"></a>
    
    

                            </div>
                            <div id="Problem.tvec" class="classattr">
                                <div class="attr variable">
            <span class="name">tvec</span><span class="annotation">: numpy.ndarray[numpy.floating]</span>

        
    </div>
    <a class="headerlink" href="#Problem.tvec"></a>
    
    

                            </div>
                            <div id="Problem.image_energies" class="classattr">
                                <div class="attr variable">
            <span class="name">image_energies</span><span class="annotation">: list[<a href="virtual_image_correlation_energy.html#VirtualImageCorrelationEnergyElem">volVIC.virtual_image_correlation_energy.VirtualImageCorrelationEnergyElem</a>]</span>

        
    </div>
    <a class="headerlink" href="#Problem.image_energies"></a>
    
    

                            </div>
                            <div id="Problem.constraints" class="classattr">
                                <div class="attr variable">
            <span class="name">constraints</span><span class="annotation">: IGA_for_bsplyne.Dirichlet.DirichletConstraintHandler</span>

        
    </div>
    <a class="headerlink" href="#Problem.constraints"></a>
    
    

                            </div>
                            <div id="Problem.dirichlet" class="classattr">
                                <div class="attr variable">
            <span class="name">dirichlet</span><span class="annotation">: IGA_for_bsplyne.Dirichlet.Dirichlet</span>

        
    </div>
    <a class="headerlink" href="#Problem.dirichlet"></a>
    
    

                            </div>
                            <div id="Problem.membrane_K" class="classattr">
                                <div class="attr variable">
            <span class="name">membrane_K</span><span class="annotation">: scipy.sparse._matrix.spmatrix</span>

        
    </div>
    <a class="headerlink" href="#Problem.membrane_K"></a>
    
    

                            </div>
                            <div id="Problem.membrane_weight" class="classattr">
                                <div class="attr variable">
            <span class="name">membrane_weight</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#Problem.membrane_weight"></a>
    
    

                            </div>
                            <div id="Problem.initial_rho" class="classattr">
                                <div class="attr variable">
            <span class="name">initial_rho</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#Problem.initial_rho"></a>
    
    

                            </div>
                            <div id="Problem.saved_data_0" class="classattr">
                                <div class="attr variable">
            <span class="name">saved_data_0</span><span class="annotation">: list[dict[str, numpy.ndarray[numpy.floating]]]</span>

        
    </div>
    <a class="headerlink" href="#Problem.saved_data_0"></a>
    
    

                            </div>
                            <div id="Problem.find_fg_bg" class="classattr">
                                        <input id="Problem.find_fg_bg-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">find_fg_bg</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;otsu&#39;</span><span class="p">,</span> <span class="s1">&#39;interp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;otsu&#39;</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Problem.find_fg_bg-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Problem.find_fg_bg"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Problem.find_fg_bg-342"><a href="#Problem.find_fg_bg-342"><span class="linenos">342</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_fg_bg</span><span class="p">(</span>
</span><span id="Problem.find_fg_bg-343"><a href="#Problem.find_fg_bg-343"><span class="linenos">343</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;otsu&quot;</span><span class="p">,</span> <span class="s2">&quot;interp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;otsu&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Problem.find_fg_bg-344"><a href="#Problem.find_fg_bg-344"><span class="linenos">344</span></a>    <span class="p">):</span>
</span><span id="Problem.find_fg_bg-345"><a href="#Problem.find_fg_bg-345"><span class="linenos">345</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem.find_fg_bg-346"><a href="#Problem.find_fg_bg-346"><span class="linenos">346</span></a><span class="sd">        Estimate foreground and background gray levels from the input image.</span>
</span><span id="Problem.find_fg_bg-347"><a href="#Problem.find_fg_bg-347"><span class="linenos">347</span></a>
</span><span id="Problem.find_fg_bg-348"><a href="#Problem.find_fg_bg-348"><span class="linenos">348</span></a><span class="sd">        This method analyzes the gray-level distribution of the volumetric image</span>
</span><span id="Problem.find_fg_bg-349"><a href="#Problem.find_fg_bg-349"><span class="linenos">349</span></a><span class="sd">        and returns representative foreground (`fg`) and background (`bg`) values.</span>
</span><span id="Problem.find_fg_bg-350"><a href="#Problem.find_fg_bg-350"><span class="linenos">350</span></a><span class="sd">        These values are used by the virtual image model to map signed distances</span>
</span><span id="Problem.find_fg_bg-351"><a href="#Problem.find_fg_bg-351"><span class="linenos">351</span></a><span class="sd">        to gray levels in the VIC formulation.</span>
</span><span id="Problem.find_fg_bg-352"><a href="#Problem.find_fg_bg-352"><span class="linenos">352</span></a>
</span><span id="Problem.find_fg_bg-353"><a href="#Problem.find_fg_bg-353"><span class="linenos">353</span></a><span class="sd">        Parameters</span>
</span><span id="Problem.find_fg_bg-354"><a href="#Problem.find_fg_bg-354"><span class="linenos">354</span></a><span class="sd">        ----------</span>
</span><span id="Problem.find_fg_bg-355"><a href="#Problem.find_fg_bg-355"><span class="linenos">355</span></a><span class="sd">        method : Literal[&quot;otsu&quot;, &quot;interp&quot;], optional</span>
</span><span id="Problem.find_fg_bg-356"><a href="#Problem.find_fg_bg-356"><span class="linenos">356</span></a><span class="sd">            Strategy used to estimate foreground and background levels:</span>
</span><span id="Problem.find_fg_bg-357"><a href="#Problem.find_fg_bg-357"><span class="linenos">357</span></a><span class="sd">                - &quot;otsu&quot;: threshold-based estimation using Otsu&#39;s method.</span>
</span><span id="Problem.find_fg_bg-358"><a href="#Problem.find_fg_bg-358"><span class="linenos">358</span></a><span class="sd">                - &quot;interp&quot;: estimation based on interpolation of histogram peaks.</span>
</span><span id="Problem.find_fg_bg-359"><a href="#Problem.find_fg_bg-359"><span class="linenos">359</span></a><span class="sd">            Default is &quot;otsu&quot;.</span>
</span><span id="Problem.find_fg_bg-360"><a href="#Problem.find_fg_bg-360"><span class="linenos">360</span></a>
</span><span id="Problem.find_fg_bg-361"><a href="#Problem.find_fg_bg-361"><span class="linenos">361</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="Problem.find_fg_bg-362"><a href="#Problem.find_fg_bg-362"><span class="linenos">362</span></a><span class="sd">            If True, prints diagnostic information during the estimation process.</span>
</span><span id="Problem.find_fg_bg-363"><a href="#Problem.find_fg_bg-363"><span class="linenos">363</span></a>
</span><span id="Problem.find_fg_bg-364"><a href="#Problem.find_fg_bg-364"><span class="linenos">364</span></a><span class="sd">        Returns</span>
</span><span id="Problem.find_fg_bg-365"><a href="#Problem.find_fg_bg-365"><span class="linenos">365</span></a><span class="sd">        -------</span>
</span><span id="Problem.find_fg_bg-366"><a href="#Problem.find_fg_bg-366"><span class="linenos">366</span></a><span class="sd">        fg : float</span>
</span><span id="Problem.find_fg_bg-367"><a href="#Problem.find_fg_bg-367"><span class="linenos">367</span></a><span class="sd">            Estimated foreground gray level.</span>
</span><span id="Problem.find_fg_bg-368"><a href="#Problem.find_fg_bg-368"><span class="linenos">368</span></a>
</span><span id="Problem.find_fg_bg-369"><a href="#Problem.find_fg_bg-369"><span class="linenos">369</span></a><span class="sd">        bg : float</span>
</span><span id="Problem.find_fg_bg-370"><a href="#Problem.find_fg_bg-370"><span class="linenos">370</span></a><span class="sd">            Estimated background gray level.</span>
</span><span id="Problem.find_fg_bg-371"><a href="#Problem.find_fg_bg-371"><span class="linenos">371</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem.find_fg_bg-372"><a href="#Problem.find_fg_bg-372"><span class="linenos">372</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.find_fg_bg-373"><a href="#Problem.find_fg_bg-373"><span class="linenos">373</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC][FG/BG] method=</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem.find_fg_bg-374"><a href="#Problem.find_fg_bg-374"><span class="linenos">374</span></a>        <span class="n">fg</span><span class="p">,</span> <span class="n">bg</span> <span class="o">=</span> <span class="n">find_fg_bg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">save_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="Problem.find_fg_bg-375"><a href="#Problem.find_fg_bg-375"><span class="linenos">375</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.find_fg_bg-376"><a href="#Problem.find_fg_bg-376"><span class="linenos">376</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC][FG/BG] fg=</span><span class="si">{</span><span class="n">fg</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, bg=</span><span class="si">{</span><span class="n">bg</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem.find_fg_bg-377"><a href="#Problem.find_fg_bg-377"><span class="linenos">377</span></a>        <span class="k">return</span> <span class="n">fg</span><span class="p">,</span> <span class="n">bg</span>
</span></pre></div>


            <div class="docstring"><p>Estimate foreground and background gray levels from the input image.</p>

<p>This method analyzes the gray-level distribution of the volumetric image
and returns representative foreground (<code><a href="#Problem.fg">fg</a></code>) and background (<code><a href="#Problem.bg">bg</a></code>) values.
These values are used by the virtual image model to map signed distances
to gray levels in the VIC formulation.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>method</strong> (Literal["otsu", "interp"], optional):
Strategy used to estimate foreground and background levels:
    - "otsu": threshold-based estimation using Otsu's method.
    - "interp": estimation based on interpolation of histogram peaks.
Default is "otsu".</li>
<li><strong>verbose</strong> (bool, optional):
If True, prints diagnostic information during the estimation process.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>fg</strong> (float):
Estimated foreground gray level.</li>
<li><strong>bg</strong> (float):
Estimated background gray level.</li>
</ul>
</div>


                            </div>
                            <div id="Problem.initialize_h_mesh_ICP" class="classattr">
                                        <input id="Problem.initialize_h_mesh_ICP-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">initialize_h_mesh_ICP</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">ICP_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">h</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Problem.initialize_h_mesh_ICP-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Problem.initialize_h_mesh_ICP"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Problem.initialize_h_mesh_ICP-379"><a href="#Problem.initialize_h_mesh_ICP-379"><span class="linenos">379</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_h_mesh_ICP</span><span class="p">(</span>
</span><span id="Problem.initialize_h_mesh_ICP-380"><a href="#Problem.initialize_h_mesh_ICP-380"><span class="linenos">380</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Problem.initialize_h_mesh_ICP-381"><a href="#Problem.initialize_h_mesh_ICP-381"><span class="linenos">381</span></a>        <span class="n">ICP_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem.initialize_h_mesh_ICP-382"><a href="#Problem.initialize_h_mesh_ICP-382"><span class="linenos">382</span></a>        <span class="n">h</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem.initialize_h_mesh_ICP-383"><a href="#Problem.initialize_h_mesh_ICP-383"><span class="linenos">383</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Problem.initialize_h_mesh_ICP-384"><a href="#Problem.initialize_h_mesh_ICP-384"><span class="linenos">384</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem.initialize_h_mesh_ICP-385"><a href="#Problem.initialize_h_mesh_ICP-385"><span class="linenos">385</span></a>    <span class="p">):</span>
</span><span id="Problem.initialize_h_mesh_ICP-386"><a href="#Problem.initialize_h_mesh_ICP-386"><span class="linenos">386</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem.initialize_h_mesh_ICP-387"><a href="#Problem.initialize_h_mesh_ICP-387"><span class="linenos">387</span></a><span class="sd">        Initialize the mesh placement and the normal search half-width `h`.</span>
</span><span id="Problem.initialize_h_mesh_ICP-388"><a href="#Problem.initialize_h_mesh_ICP-388"><span class="linenos">388</span></a>
</span><span id="Problem.initialize_h_mesh_ICP-389"><a href="#Problem.initialize_h_mesh_ICP-389"><span class="linenos">389</span></a><span class="sd">        This method optionally performs a rigid-body Iterative Closest Point (ICP)</span>
</span><span id="Problem.initialize_h_mesh_ICP-390"><a href="#Problem.initialize_h_mesh_ICP-390"><span class="linenos">390</span></a><span class="sd">        alignment between the surface mesh and an isosurface extracted from the</span>
</span><span id="Problem.initialize_h_mesh_ICP-391"><a href="#Problem.initialize_h_mesh_ICP-391"><span class="linenos">391</span></a><span class="sd">        image. It also initializes the normal search half-width `h`, which</span>
</span><span id="Problem.initialize_h_mesh_ICP-392"><a href="#Problem.initialize_h_mesh_ICP-392"><span class="linenos">392</span></a><span class="sd">        defines the integration domain along surface normals for the image</span>
</span><span id="Problem.initialize_h_mesh_ICP-393"><a href="#Problem.initialize_h_mesh_ICP-393"><span class="linenos">393</span></a><span class="sd">        correlation energies.</span>
</span><span id="Problem.initialize_h_mesh_ICP-394"><a href="#Problem.initialize_h_mesh_ICP-394"><span class="linenos">394</span></a>
</span><span id="Problem.initialize_h_mesh_ICP-395"><a href="#Problem.initialize_h_mesh_ICP-395"><span class="linenos">395</span></a><span class="sd">        The isosurface is obtained using a marching-cubes extraction at the</span>
</span><span id="Problem.initialize_h_mesh_ICP-396"><a href="#Problem.initialize_h_mesh_ICP-396"><span class="linenos">396</span></a><span class="sd">        mid-gray level between the estimated foreground and background values.</span>
</span><span id="Problem.initialize_h_mesh_ICP-397"><a href="#Problem.initialize_h_mesh_ICP-397"><span class="linenos">397</span></a>
</span><span id="Problem.initialize_h_mesh_ICP-398"><a href="#Problem.initialize_h_mesh_ICP-398"><span class="linenos">398</span></a><span class="sd">        Behavior depends on the input parameters:</span>
</span><span id="Problem.initialize_h_mesh_ICP-399"><a href="#Problem.initialize_h_mesh_ICP-399"><span class="linenos">399</span></a><span class="sd">            - If `ICP_init=True`, a rigid-body ICP alignment is performed and</span>
</span><span id="Problem.initialize_h_mesh_ICP-400"><a href="#Problem.initialize_h_mesh_ICP-400"><span class="linenos">400</span></a><span class="sd">              the resulting rotation matrix and translation vector are returned.</span>
</span><span id="Problem.initialize_h_mesh_ICP-401"><a href="#Problem.initialize_h_mesh_ICP-401"><span class="linenos">401</span></a><span class="sd">            - If `h` is `None`, the value of `h` is automatically estimated</span>
</span><span id="Problem.initialize_h_mesh_ICP-402"><a href="#Problem.initialize_h_mesh_ICP-402"><span class="linenos">402</span></a><span class="sd">              from the maximum distance between the mesh and the extracted</span>
</span><span id="Problem.initialize_h_mesh_ICP-403"><a href="#Problem.initialize_h_mesh_ICP-403"><span class="linenos">403</span></a><span class="sd">              isosurface.</span>
</span><span id="Problem.initialize_h_mesh_ICP-404"><a href="#Problem.initialize_h_mesh_ICP-404"><span class="linenos">404</span></a><span class="sd">            - If `ICP_init=False` and `h` is provided, no alignment is</span>
</span><span id="Problem.initialize_h_mesh_ICP-405"><a href="#Problem.initialize_h_mesh_ICP-405"><span class="linenos">405</span></a><span class="sd">              performed and `h` is left unchanged.</span>
</span><span id="Problem.initialize_h_mesh_ICP-406"><a href="#Problem.initialize_h_mesh_ICP-406"><span class="linenos">406</span></a>
</span><span id="Problem.initialize_h_mesh_ICP-407"><a href="#Problem.initialize_h_mesh_ICP-407"><span class="linenos">407</span></a><span class="sd">        Parameters</span>
</span><span id="Problem.initialize_h_mesh_ICP-408"><a href="#Problem.initialize_h_mesh_ICP-408"><span class="linenos">408</span></a><span class="sd">        ----------</span>
</span><span id="Problem.initialize_h_mesh_ICP-409"><a href="#Problem.initialize_h_mesh_ICP-409"><span class="linenos">409</span></a><span class="sd">        ICP_init : bool, optional</span>
</span><span id="Problem.initialize_h_mesh_ICP-410"><a href="#Problem.initialize_h_mesh_ICP-410"><span class="linenos">410</span></a><span class="sd">            If `True` (default), performs a rigid-body ICP alignment between the</span>
</span><span id="Problem.initialize_h_mesh_ICP-411"><a href="#Problem.initialize_h_mesh_ICP-411"><span class="linenos">411</span></a><span class="sd">            mesh and the image-derived isosurface.</span>
</span><span id="Problem.initialize_h_mesh_ICP-412"><a href="#Problem.initialize_h_mesh_ICP-412"><span class="linenos">412</span></a>
</span><span id="Problem.initialize_h_mesh_ICP-413"><a href="#Problem.initialize_h_mesh_ICP-413"><span class="linenos">413</span></a><span class="sd">        h : float or None, optional</span>
</span><span id="Problem.initialize_h_mesh_ICP-414"><a href="#Problem.initialize_h_mesh_ICP-414"><span class="linenos">414</span></a><span class="sd">            Normal search half-width used in image energy integration.</span>
</span><span id="Problem.initialize_h_mesh_ICP-415"><a href="#Problem.initialize_h_mesh_ICP-415"><span class="linenos">415</span></a><span class="sd">            If `None` (default), `h` is automatically estimated from the maximum</span>
</span><span id="Problem.initialize_h_mesh_ICP-416"><a href="#Problem.initialize_h_mesh_ICP-416"><span class="linenos">416</span></a><span class="sd">            mesh-to-image distance.</span>
</span><span id="Problem.initialize_h_mesh_ICP-417"><a href="#Problem.initialize_h_mesh_ICP-417"><span class="linenos">417</span></a>
</span><span id="Problem.initialize_h_mesh_ICP-418"><a href="#Problem.initialize_h_mesh_ICP-418"><span class="linenos">418</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="Problem.initialize_h_mesh_ICP-419"><a href="#Problem.initialize_h_mesh_ICP-419"><span class="linenos">419</span></a><span class="sd">            If `True`, disables parallel execution during ICP and distance-field</span>
</span><span id="Problem.initialize_h_mesh_ICP-420"><a href="#Problem.initialize_h_mesh_ICP-420"><span class="linenos">420</span></a><span class="sd">            computations. By default, `False`.</span>
</span><span id="Problem.initialize_h_mesh_ICP-421"><a href="#Problem.initialize_h_mesh_ICP-421"><span class="linenos">421</span></a>
</span><span id="Problem.initialize_h_mesh_ICP-422"><a href="#Problem.initialize_h_mesh_ICP-422"><span class="linenos">422</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="Problem.initialize_h_mesh_ICP-423"><a href="#Problem.initialize_h_mesh_ICP-423"><span class="linenos">423</span></a><span class="sd">            If `True`, prints diagnostic information during initialization.</span>
</span><span id="Problem.initialize_h_mesh_ICP-424"><a href="#Problem.initialize_h_mesh_ICP-424"><span class="linenos">424</span></a><span class="sd">            By default, `True`.</span>
</span><span id="Problem.initialize_h_mesh_ICP-425"><a href="#Problem.initialize_h_mesh_ICP-425"><span class="linenos">425</span></a>
</span><span id="Problem.initialize_h_mesh_ICP-426"><a href="#Problem.initialize_h_mesh_ICP-426"><span class="linenos">426</span></a><span class="sd">        Returns</span>
</span><span id="Problem.initialize_h_mesh_ICP-427"><a href="#Problem.initialize_h_mesh_ICP-427"><span class="linenos">427</span></a><span class="sd">        -------</span>
</span><span id="Problem.initialize_h_mesh_ICP-428"><a href="#Problem.initialize_h_mesh_ICP-428"><span class="linenos">428</span></a><span class="sd">        Rmat : np.ndarray</span>
</span><span id="Problem.initialize_h_mesh_ICP-429"><a href="#Problem.initialize_h_mesh_ICP-429"><span class="linenos">429</span></a><span class="sd">            3x3 rotation matrix resulting from the ICP alignment.</span>
</span><span id="Problem.initialize_h_mesh_ICP-430"><a href="#Problem.initialize_h_mesh_ICP-430"><span class="linenos">430</span></a><span class="sd">            Identity if no ICP is performed.</span>
</span><span id="Problem.initialize_h_mesh_ICP-431"><a href="#Problem.initialize_h_mesh_ICP-431"><span class="linenos">431</span></a>
</span><span id="Problem.initialize_h_mesh_ICP-432"><a href="#Problem.initialize_h_mesh_ICP-432"><span class="linenos">432</span></a><span class="sd">        tvec : np.ndarray</span>
</span><span id="Problem.initialize_h_mesh_ICP-433"><a href="#Problem.initialize_h_mesh_ICP-433"><span class="linenos">433</span></a><span class="sd">            Translation vector resulting from the ICP alignment.</span>
</span><span id="Problem.initialize_h_mesh_ICP-434"><a href="#Problem.initialize_h_mesh_ICP-434"><span class="linenos">434</span></a><span class="sd">            Zero vector if no ICP is performed.</span>
</span><span id="Problem.initialize_h_mesh_ICP-435"><a href="#Problem.initialize_h_mesh_ICP-435"><span class="linenos">435</span></a>
</span><span id="Problem.initialize_h_mesh_ICP-436"><a href="#Problem.initialize_h_mesh_ICP-436"><span class="linenos">436</span></a><span class="sd">        h : float</span>
</span><span id="Problem.initialize_h_mesh_ICP-437"><a href="#Problem.initialize_h_mesh_ICP-437"><span class="linenos">437</span></a><span class="sd">            Initialized normal search half-width.</span>
</span><span id="Problem.initialize_h_mesh_ICP-438"><a href="#Problem.initialize_h_mesh_ICP-438"><span class="linenos">438</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem.initialize_h_mesh_ICP-439"><a href="#Problem.initialize_h_mesh_ICP-439"><span class="linenos">439</span></a>        <span class="n">compute_h</span> <span class="o">=</span> <span class="n">h</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="Problem.initialize_h_mesh_ICP-440"><a href="#Problem.initialize_h_mesh_ICP-440"><span class="linenos">440</span></a>        <span class="k">if</span> <span class="n">ICP_init</span> <span class="ow">or</span> <span class="n">compute_h</span><span class="p">:</span>
</span><span id="Problem.initialize_h_mesh_ICP-441"><a href="#Problem.initialize_h_mesh_ICP-441"><span class="linenos">441</span></a>            <span class="n">stl_mc</span> <span class="o">=</span> <span class="n">marching_cubes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fg</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bg</span><span class="p">))</span>
</span><span id="Problem.initialize_h_mesh_ICP-442"><a href="#Problem.initialize_h_mesh_ICP-442"><span class="linenos">442</span></a>            <span class="k">if</span> <span class="n">ICP_init</span><span class="p">:</span>
</span><span id="Problem.initialize_h_mesh_ICP-443"><a href="#Problem.initialize_h_mesh_ICP-443"><span class="linenos">443</span></a>                <span class="n">Rmat</span><span class="p">,</span> <span class="n">tvec</span><span class="p">,</span> <span class="n">max_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">ICP_rigid_body_transform</span><span class="p">(</span>
</span><span id="Problem.initialize_h_mesh_ICP-444"><a href="#Problem.initialize_h_mesh_ICP-444"><span class="linenos">444</span></a>                    <span class="n">stl_mc</span><span class="p">,</span> <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span> <span class="n">plot_after</span><span class="o">=</span><span class="n">verbose</span>
</span><span id="Problem.initialize_h_mesh_ICP-445"><a href="#Problem.initialize_h_mesh_ICP-445"><span class="linenos">445</span></a>                <span class="p">)</span>
</span><span id="Problem.initialize_h_mesh_ICP-446"><a href="#Problem.initialize_h_mesh_ICP-446"><span class="linenos">446</span></a>                <span class="k">if</span> <span class="n">compute_h</span><span class="p">:</span>
</span><span id="Problem.initialize_h_mesh_ICP-447"><a href="#Problem.initialize_h_mesh_ICP-447"><span class="linenos">447</span></a>                    <span class="n">h</span> <span class="o">=</span> <span class="n">max_dist</span> <span class="o">+</span> <span class="mf">1.0</span>
</span><span id="Problem.initialize_h_mesh_ICP-448"><a href="#Problem.initialize_h_mesh_ICP-448"><span class="linenos">448</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.initialize_h_mesh_ICP-449"><a href="#Problem.initialize_h_mesh_ICP-449"><span class="linenos">449</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[VIC] ICP done | max_dist=</span><span class="si">{</span><span class="n">max_dist</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">, h=</span><span class="si">{</span><span class="n">h</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem.initialize_h_mesh_ICP-450"><a href="#Problem.initialize_h_mesh_ICP-450"><span class="linenos">450</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Problem.initialize_h_mesh_ICP-451"><a href="#Problem.initialize_h_mesh_ICP-451"><span class="linenos">451</span></a>                <span class="n">Rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="Problem.initialize_h_mesh_ICP-452"><a href="#Problem.initialize_h_mesh_ICP-452"><span class="linenos">452</span></a>                <span class="n">tvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="Problem.initialize_h_mesh_ICP-453"><a href="#Problem.initialize_h_mesh_ICP-453"><span class="linenos">453</span></a>                <span class="k">if</span> <span class="n">compute_h</span><span class="p">:</span>
</span><span id="Problem.initialize_h_mesh_ICP-454"><a href="#Problem.initialize_h_mesh_ICP-454"><span class="linenos">454</span></a>                    <span class="n">distance_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">distance_to_meshio</span><span class="p">(</span><span class="n">stl_mc</span><span class="p">)</span>
</span><span id="Problem.initialize_h_mesh_ICP-455"><a href="#Problem.initialize_h_mesh_ICP-455"><span class="linenos">455</span></a>                    <span class="n">max_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
</span><span id="Problem.initialize_h_mesh_ICP-456"><a href="#Problem.initialize_h_mesh_ICP-456"><span class="linenos">456</span></a>                        <span class="n">distance_mesh</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s2">&quot;implicit_distance&quot;</span><span class="p">]</span>
</span><span id="Problem.initialize_h_mesh_ICP-457"><a href="#Problem.initialize_h_mesh_ICP-457"><span class="linenos">457</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="Problem.initialize_h_mesh_ICP-458"><a href="#Problem.initialize_h_mesh_ICP-458"><span class="linenos">458</span></a>                    <span class="n">h</span> <span class="o">=</span> <span class="n">max_dist</span> <span class="o">+</span> <span class="mf">1.0</span>
</span><span id="Problem.initialize_h_mesh_ICP-459"><a href="#Problem.initialize_h_mesh_ICP-459"><span class="linenos">459</span></a>                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.initialize_h_mesh_ICP-460"><a href="#Problem.initialize_h_mesh_ICP-460"><span class="linenos">460</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="Problem.initialize_h_mesh_ICP-461"><a href="#Problem.initialize_h_mesh_ICP-461"><span class="linenos">461</span></a>                            <span class="sa">f</span><span class="s2">&quot;[VIC] h from distance field | max_dist=</span><span class="si">{</span><span class="n">max_dist</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">, h=</span><span class="si">{</span><span class="n">h</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Problem.initialize_h_mesh_ICP-462"><a href="#Problem.initialize_h_mesh_ICP-462"><span class="linenos">462</span></a>                        <span class="p">)</span>
</span><span id="Problem.initialize_h_mesh_ICP-463"><a href="#Problem.initialize_h_mesh_ICP-463"><span class="linenos">463</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Problem.initialize_h_mesh_ICP-464"><a href="#Problem.initialize_h_mesh_ICP-464"><span class="linenos">464</span></a>            <span class="n">Rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="Problem.initialize_h_mesh_ICP-465"><a href="#Problem.initialize_h_mesh_ICP-465"><span class="linenos">465</span></a>            <span class="n">tvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="Problem.initialize_h_mesh_ICP-466"><a href="#Problem.initialize_h_mesh_ICP-466"><span class="linenos">466</span></a>        <span class="k">return</span> <span class="n">Rmat</span><span class="p">,</span> <span class="n">tvec</span><span class="p">,</span> <span class="n">h</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the mesh placement and the normal search half-width <code>h</code>.</p>

<p>This method optionally performs a rigid-body Iterative Closest Point (ICP)
alignment between the surface mesh and an isosurface extracted from the
image. It also initializes the normal search half-width <code>h</code>, which
defines the integration domain along surface normals for the image
correlation energies.</p>

<p>The isosurface is obtained using a marching-cubes extraction at the
mid-gray level between the estimated foreground and background values.</p>

<p>Behavior depends on the input parameters:
    - If <code>ICP_init=True</code>, a rigid-body ICP alignment is performed and
      the resulting rotation matrix and translation vector are returned.
    - If <code>h</code> is <code>None</code>, the value of <code>h</code> is automatically estimated
      from the maximum distance between the mesh and the extracted
      isosurface.
    - If <code>ICP_init=False</code> and <code>h</code> is provided, no alignment is
      performed and <code>h</code> is left unchanged.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>ICP_init</strong> (bool, optional):
If <code>True</code> (default), performs a rigid-body ICP alignment between the
mesh and the image-derived isosurface.</li>
<li><strong>h</strong> (float or None, optional):
Normal search half-width used in image energy integration.
If <code>None</code> (default), <code>h</code> is automatically estimated from the maximum
mesh-to-image distance.</li>
<li><strong>disable_parallel</strong> (bool, optional):
If <code>True</code>, disables parallel execution during ICP and distance-field
computations. By default, <code>False</code>.</li>
<li><strong>verbose</strong> (bool, optional):
If <code>True</code>, prints diagnostic information during initialization.
By default, <code>True</code>.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>Rmat</strong> (np.ndarray):
3x3 rotation matrix resulting from the ICP alignment.
Identity if no ICP is performed.</li>
<li><strong>tvec</strong> (np.ndarray):
Translation vector resulting from the ICP alignment.
Zero vector if no ICP is performed.</li>
<li><strong>h</strong> (float):
Initialized normal search half-width.</li>
</ul>
</div>


                            </div>
                            <div id="Problem.make_membrane_weight" class="classattr">
                                        <input id="Problem.make_membrane_weight-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">make_membrane_weight</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">rho</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">expected_mean_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span>,</span><span class="param">	<span class="n">n_intg</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Problem.make_membrane_weight-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Problem.make_membrane_weight"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Problem.make_membrane_weight-468"><a href="#Problem.make_membrane_weight-468"><span class="linenos">468</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">make_membrane_weight</span><span class="p">(</span>
</span><span id="Problem.make_membrane_weight-469"><a href="#Problem.make_membrane_weight-469"><span class="linenos">469</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Problem.make_membrane_weight-470"><a href="#Problem.make_membrane_weight-470"><span class="linenos">470</span></a>        <span class="n">rho</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem.make_membrane_weight-471"><a href="#Problem.make_membrane_weight-471"><span class="linenos">471</span></a>        <span class="n">expected_mean_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
</span><span id="Problem.make_membrane_weight-472"><a href="#Problem.make_membrane_weight-472"><span class="linenos">472</span></a>        <span class="n">n_intg</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
</span><span id="Problem.make_membrane_weight-473"><a href="#Problem.make_membrane_weight-473"><span class="linenos">473</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Problem.make_membrane_weight-474"><a href="#Problem.make_membrane_weight-474"><span class="linenos">474</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem.make_membrane_weight-475"><a href="#Problem.make_membrane_weight-475"><span class="linenos">475</span></a><span class="sd">        Compute and set the membrane regularization weight.</span>
</span><span id="Problem.make_membrane_weight-476"><a href="#Problem.make_membrane_weight-476"><span class="linenos">476</span></a>
</span><span id="Problem.make_membrane_weight-477"><a href="#Problem.make_membrane_weight-477"><span class="linenos">477</span></a><span class="sd">        This method computes the weight associated with the membrane (elastic)</span>
</span><span id="Problem.make_membrane_weight-478"><a href="#Problem.make_membrane_weight-478"><span class="linenos">478</span></a><span class="sd">        regularization term based on the current problem configuration and image</span>
</span><span id="Problem.make_membrane_weight-479"><a href="#Problem.make_membrane_weight-479"><span class="linenos">479</span></a><span class="sd">        statistics. The weight is calibrated such that the regularization term</span>
</span><span id="Problem.make_membrane_weight-480"><a href="#Problem.make_membrane_weight-480"><span class="linenos">480</span></a><span class="sd">        is consistent with the expected image-to-surface distance scale.</span>
</span><span id="Problem.make_membrane_weight-481"><a href="#Problem.make_membrane_weight-481"><span class="linenos">481</span></a>
</span><span id="Problem.make_membrane_weight-482"><a href="#Problem.make_membrane_weight-482"><span class="linenos">482</span></a><span class="sd">        The actual computation is delegated to</span>
</span><span id="Problem.make_membrane_weight-483"><a href="#Problem.make_membrane_weight-483"><span class="linenos">483</span></a><span class="sd">        :func:`volVIC.membrane_stiffness.make_membrane_weight`.</span>
</span><span id="Problem.make_membrane_weight-484"><a href="#Problem.make_membrane_weight-484"><span class="linenos">484</span></a>
</span><span id="Problem.make_membrane_weight-485"><a href="#Problem.make_membrane_weight-485"><span class="linenos">485</span></a><span class="sd">        Parameters</span>
</span><span id="Problem.make_membrane_weight-486"><a href="#Problem.make_membrane_weight-486"><span class="linenos">486</span></a><span class="sd">        ----------</span>
</span><span id="Problem.make_membrane_weight-487"><a href="#Problem.make_membrane_weight-487"><span class="linenos">487</span></a><span class="sd">        rho : float or None, optional</span>
</span><span id="Problem.make_membrane_weight-488"><a href="#Problem.make_membrane_weight-488"><span class="linenos">488</span></a><span class="sd">            Value of the transition distance parameter used in the VIC</span>
</span><span id="Problem.make_membrane_weight-489"><a href="#Problem.make_membrane_weight-489"><span class="linenos">489</span></a><span class="sd">            model. If `None` (default), `self.initial_rho` is used.</span>
</span><span id="Problem.make_membrane_weight-490"><a href="#Problem.make_membrane_weight-490"><span class="linenos">490</span></a>
</span><span id="Problem.make_membrane_weight-491"><a href="#Problem.make_membrane_weight-491"><span class="linenos">491</span></a><span class="sd">        expected_mean_dist : float, optional</span>
</span><span id="Problem.make_membrane_weight-492"><a href="#Problem.make_membrane_weight-492"><span class="linenos">492</span></a><span class="sd">            Expected mean signed distance (in image units) between the surface</span>
</span><span id="Problem.make_membrane_weight-493"><a href="#Problem.make_membrane_weight-493"><span class="linenos">493</span></a><span class="sd">            and the image features. This value is used to calibrate the membrane</span>
</span><span id="Problem.make_membrane_weight-494"><a href="#Problem.make_membrane_weight-494"><span class="linenos">494</span></a><span class="sd">            weight. Default is `5.0`.</span>
</span><span id="Problem.make_membrane_weight-495"><a href="#Problem.make_membrane_weight-495"><span class="linenos">495</span></a>
</span><span id="Problem.make_membrane_weight-496"><a href="#Problem.make_membrane_weight-496"><span class="linenos">496</span></a><span class="sd">        n_intg : int, optional</span>
</span><span id="Problem.make_membrane_weight-497"><a href="#Problem.make_membrane_weight-497"><span class="linenos">497</span></a><span class="sd">            Number of integration points used to estimate the membrane weight.</span>
</span><span id="Problem.make_membrane_weight-498"><a href="#Problem.make_membrane_weight-498"><span class="linenos">498</span></a><span class="sd">            Higher values improve accuracy at the cost of additional computation.</span>
</span><span id="Problem.make_membrane_weight-499"><a href="#Problem.make_membrane_weight-499"><span class="linenos">499</span></a><span class="sd">            Default is `100`.</span>
</span><span id="Problem.make_membrane_weight-500"><a href="#Problem.make_membrane_weight-500"><span class="linenos">500</span></a>
</span><span id="Problem.make_membrane_weight-501"><a href="#Problem.make_membrane_weight-501"><span class="linenos">501</span></a><span class="sd">        Returns</span>
</span><span id="Problem.make_membrane_weight-502"><a href="#Problem.make_membrane_weight-502"><span class="linenos">502</span></a><span class="sd">        -------</span>
</span><span id="Problem.make_membrane_weight-503"><a href="#Problem.make_membrane_weight-503"><span class="linenos">503</span></a><span class="sd">        float</span>
</span><span id="Problem.make_membrane_weight-504"><a href="#Problem.make_membrane_weight-504"><span class="linenos">504</span></a><span class="sd">            Computed membrane regularization weight.</span>
</span><span id="Problem.make_membrane_weight-505"><a href="#Problem.make_membrane_weight-505"><span class="linenos">505</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem.make_membrane_weight-506"><a href="#Problem.make_membrane_weight-506"><span class="linenos">506</span></a>        <span class="k">if</span> <span class="n">rho</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Problem.make_membrane_weight-507"><a href="#Problem.make_membrane_weight-507"><span class="linenos">507</span></a>            <span class="n">rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_rho</span>
</span><span id="Problem.make_membrane_weight-508"><a href="#Problem.make_membrane_weight-508"><span class="linenos">508</span></a>        <span class="n">image_std</span> <span class="o">=</span> <span class="n">find_sigma_hat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bg</span><span class="p">)</span>
</span><span id="Problem.make_membrane_weight-509"><a href="#Problem.make_membrane_weight-509"><span class="linenos">509</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">membrane_weight</span> <span class="o">=</span> <span class="n">make_membrane_weight</span><span class="p">(</span>
</span><span id="Problem.make_membrane_weight-510"><a href="#Problem.make_membrane_weight-510"><span class="linenos">510</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
</span><span id="Problem.make_membrane_weight-511"><a href="#Problem.make_membrane_weight-511"><span class="linenos">511</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">,</span>
</span><span id="Problem.make_membrane_weight-512"><a href="#Problem.make_membrane_weight-512"><span class="linenos">512</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">membrane_K</span><span class="p">,</span>
</span><span id="Problem.make_membrane_weight-513"><a href="#Problem.make_membrane_weight-513"><span class="linenos">513</span></a>            <span class="n">rho</span><span class="o">=</span><span class="n">rho</span><span class="p">,</span>
</span><span id="Problem.make_membrane_weight-514"><a href="#Problem.make_membrane_weight-514"><span class="linenos">514</span></a>            <span class="n">image_std</span><span class="o">=</span><span class="n">image_std</span><span class="p">,</span>
</span><span id="Problem.make_membrane_weight-515"><a href="#Problem.make_membrane_weight-515"><span class="linenos">515</span></a>            <span class="n">expected_mean_dist</span><span class="o">=</span><span class="n">expected_mean_dist</span><span class="p">,</span>
</span><span id="Problem.make_membrane_weight-516"><a href="#Problem.make_membrane_weight-516"><span class="linenos">516</span></a>            <span class="n">n_intg</span><span class="o">=</span><span class="n">n_intg</span><span class="p">,</span>
</span><span id="Problem.make_membrane_weight-517"><a href="#Problem.make_membrane_weight-517"><span class="linenos">517</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compute and set the membrane regularization weight.</p>

<p>This method computes the weight associated with the membrane (elastic)
regularization term based on the current problem configuration and image
statistics. The weight is calibrated such that the regularization term
is consistent with the expected image-to-surface distance scale.</p>

<p>The actual computation is delegated to
<code><a href="membrane_stiffness.html#make_membrane_weight">volVIC.membrane_stiffness.make_membrane_weight()</a></code>.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>rho</strong> (float or None, optional):
Value of the transition distance parameter used in the VIC
model. If <code>None</code> (default), <code>self.initial_rho</code> is used.</li>
<li><strong>expected_mean_dist</strong> (float, optional):
Expected mean signed distance (in image units) between the surface
and the image features. This value is used to calibrate the membrane
weight. Default is <code>5.0</code>.</li>
<li><strong>n_intg</strong> (int, optional):
Number of integration points used to estimate the membrane weight.
Higher values improve accuracy at the cost of additional computation.
Default is <code>100</code>.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>float</strong>: Computed membrane regularization weight.</li>
</ul>
</div>


                            </div>
                            <div id="Problem.make_dirichlet" class="classattr">
                                        <input id="Problem.make_dirichlet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">make_dirichlet</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Problem.make_dirichlet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Problem.make_dirichlet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Problem.make_dirichlet-519"><a href="#Problem.make_dirichlet-519"><span class="linenos">519</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">make_dirichlet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Problem.make_dirichlet-520"><a href="#Problem.make_dirichlet-520"><span class="linenos">520</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem.make_dirichlet-521"><a href="#Problem.make_dirichlet-521"><span class="linenos">521</span></a><span class="sd">        Build the reduced-DOF Dirichlet representation from linear constraints.</span>
</span><span id="Problem.make_dirichlet-522"><a href="#Problem.make_dirichlet-522"><span class="linenos">522</span></a>
</span><span id="Problem.make_dirichlet-523"><a href="#Problem.make_dirichlet-523"><span class="linenos">523</span></a><span class="sd">        The object `self.constraints` stores linear equality constraints of</span>
</span><span id="Problem.make_dirichlet-524"><a href="#Problem.make_dirichlet-524"><span class="linenos">524</span></a><span class="sd">        the form `D @ u = c`. This method converts this representation into a</span>
</span><span id="Problem.make_dirichlet-525"><a href="#Problem.make_dirichlet-525"><span class="linenos">525</span></a><span class="sd">        reduced-DOF Dirichlet mapping of the form</span>
</span><span id="Problem.make_dirichlet-526"><a href="#Problem.make_dirichlet-526"><span class="linenos">526</span></a>
</span><span id="Problem.make_dirichlet-527"><a href="#Problem.make_dirichlet-527"><span class="linenos">527</span></a><span class="sd">            u = C @ dof + k ,</span>
</span><span id="Problem.make_dirichlet-528"><a href="#Problem.make_dirichlet-528"><span class="linenos">528</span></a>
</span><span id="Problem.make_dirichlet-529"><a href="#Problem.make_dirichlet-529"><span class="linenos">529</span></a><span class="sd">        where `C` is a basis of the null space of `D` (`D @ C = 0`) and</span>
</span><span id="Problem.make_dirichlet-530"><a href="#Problem.make_dirichlet-530"><span class="linenos">530</span></a><span class="sd">        `k` is a particular solution satisfying `D @ k = c`.</span>
</span><span id="Problem.make_dirichlet-531"><a href="#Problem.make_dirichlet-531"><span class="linenos">531</span></a>
</span><span id="Problem.make_dirichlet-532"><a href="#Problem.make_dirichlet-532"><span class="linenos">532</span></a><span class="sd">        The resulting mapping is stored in `self.dirichlet` and is used to</span>
</span><span id="Problem.make_dirichlet-533"><a href="#Problem.make_dirichlet-533"><span class="linenos">533</span></a><span class="sd">        eliminate constrained degrees of freedom in the solver.</span>
</span><span id="Problem.make_dirichlet-534"><a href="#Problem.make_dirichlet-534"><span class="linenos">534</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem.make_dirichlet-535"><a href="#Problem.make_dirichlet-535"><span class="linenos">535</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dirichlet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">create_dirichlet</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Build the reduced-DOF Dirichlet representation from linear constraints.</p>

<p>The object <code>self.constraints</code> stores linear equality constraints of
the form <code>D @ u = c</code>. This method converts this representation into a
reduced-DOF Dirichlet mapping of the form</p>

<pre><code>u = C @ dof + k ,
</code></pre>

<p>where <code>C</code> is a basis of the null space of <code>D</code> (<code>D @ C = 0</code>) and
<code>k</code> is a particular solution satisfying <code>D @ k = c</code>.</p>

<p>The resulting mapping is stored in <code>self.dirichlet</code> and is used to
eliminate constrained degrees of freedom in the solver.</p>
</div>


                            </div>
                            <div id="Problem.one_gauss_newton_iter" class="classattr">
                                        <input id="Problem.one_gauss_newton_iter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">one_gauss_newton_iter</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">u_field</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">]</span>,</span><span class="param">	<span class="n">rho</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">_matrix</span><span class="o">.</span><span class="n">spmatrix</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Problem.one_gauss_newton_iter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Problem.one_gauss_newton_iter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Problem.one_gauss_newton_iter-537"><a href="#Problem.one_gauss_newton_iter-537"><span class="linenos">537</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">one_gauss_newton_iter</span><span class="p">(</span>
</span><span id="Problem.one_gauss_newton_iter-538"><a href="#Problem.one_gauss_newton_iter-538"><span class="linenos">538</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Problem.one_gauss_newton_iter-539"><a href="#Problem.one_gauss_newton_iter-539"><span class="linenos">539</span></a>        <span class="n">u_field</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
</span><span id="Problem.one_gauss_newton_iter-540"><a href="#Problem.one_gauss_newton_iter-540"><span class="linenos">540</span></a>        <span class="n">rho</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="Problem.one_gauss_newton_iter-541"><a href="#Problem.one_gauss_newton_iter-541"><span class="linenos">541</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem.one_gauss_newton_iter-542"><a href="#Problem.one_gauss_newton_iter-542"><span class="linenos">542</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Problem.one_gauss_newton_iter-543"><a href="#Problem.one_gauss_newton_iter-543"><span class="linenos">543</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="n">sps</span><span class="o">.</span><span class="n">spmatrix</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Problem.one_gauss_newton_iter-544"><a href="#Problem.one_gauss_newton_iter-544"><span class="linenos">544</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem.one_gauss_newton_iter-545"><a href="#Problem.one_gauss_newton_iter-545"><span class="linenos">545</span></a><span class="sd">        Perform a single Gauss-Newton iteration for the VIC problem.</span>
</span><span id="Problem.one_gauss_newton_iter-546"><a href="#Problem.one_gauss_newton_iter-546"><span class="linenos">546</span></a>
</span><span id="Problem.one_gauss_newton_iter-547"><a href="#Problem.one_gauss_newton_iter-547"><span class="linenos">547</span></a><span class="sd">        This method updates the displacement field and the transition distance</span>
</span><span id="Problem.one_gauss_newton_iter-548"><a href="#Problem.one_gauss_newton_iter-548"><span class="linenos">548</span></a><span class="sd">        parameter `rho` by computing the incremental corrections using the</span>
</span><span id="Problem.one_gauss_newton_iter-549"><a href="#Problem.one_gauss_newton_iter-549"><span class="linenos">549</span></a><span class="sd">        Gauss-Newton scheme. The actual computation is performed by</span>
</span><span id="Problem.one_gauss_newton_iter-550"><a href="#Problem.one_gauss_newton_iter-550"><span class="linenos">550</span></a><span class="sd">        :func:`volVIC.solve.iteration`.</span>
</span><span id="Problem.one_gauss_newton_iter-551"><a href="#Problem.one_gauss_newton_iter-551"><span class="linenos">551</span></a>
</span><span id="Problem.one_gauss_newton_iter-552"><a href="#Problem.one_gauss_newton_iter-552"><span class="linenos">552</span></a><span class="sd">        Parameters</span>
</span><span id="Problem.one_gauss_newton_iter-553"><a href="#Problem.one_gauss_newton_iter-553"><span class="linenos">553</span></a><span class="sd">        ----------</span>
</span><span id="Problem.one_gauss_newton_iter-554"><a href="#Problem.one_gauss_newton_iter-554"><span class="linenos">554</span></a><span class="sd">        u_field : np.ndarray</span>
</span><span id="Problem.one_gauss_newton_iter-555"><a href="#Problem.one_gauss_newton_iter-555"><span class="linenos">555</span></a><span class="sd">            Current displacement field of the mesh nodes, shape (3, N).</span>
</span><span id="Problem.one_gauss_newton_iter-556"><a href="#Problem.one_gauss_newton_iter-556"><span class="linenos">556</span></a>
</span><span id="Problem.one_gauss_newton_iter-557"><a href="#Problem.one_gauss_newton_iter-557"><span class="linenos">557</span></a><span class="sd">        rho : float</span>
</span><span id="Problem.one_gauss_newton_iter-558"><a href="#Problem.one_gauss_newton_iter-558"><span class="linenos">558</span></a><span class="sd">            Current value of the transition distance parameter used in the VIC model.</span>
</span><span id="Problem.one_gauss_newton_iter-559"><a href="#Problem.one_gauss_newton_iter-559"><span class="linenos">559</span></a>
</span><span id="Problem.one_gauss_newton_iter-560"><a href="#Problem.one_gauss_newton_iter-560"><span class="linenos">560</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="Problem.one_gauss_newton_iter-561"><a href="#Problem.one_gauss_newton_iter-561"><span class="linenos">561</span></a><span class="sd">            If `True`, prints diagnostic information during the iteration.</span>
</span><span id="Problem.one_gauss_newton_iter-562"><a href="#Problem.one_gauss_newton_iter-562"><span class="linenos">562</span></a><span class="sd">            By default, `True`.</span>
</span><span id="Problem.one_gauss_newton_iter-563"><a href="#Problem.one_gauss_newton_iter-563"><span class="linenos">563</span></a>
</span><span id="Problem.one_gauss_newton_iter-564"><a href="#Problem.one_gauss_newton_iter-564"><span class="linenos">564</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="Problem.one_gauss_newton_iter-565"><a href="#Problem.one_gauss_newton_iter-565"><span class="linenos">565</span></a><span class="sd">            If `True`, disables parallel execution during the iteration.</span>
</span><span id="Problem.one_gauss_newton_iter-566"><a href="#Problem.one_gauss_newton_iter-566"><span class="linenos">566</span></a><span class="sd">            By default, `False`.</span>
</span><span id="Problem.one_gauss_newton_iter-567"><a href="#Problem.one_gauss_newton_iter-567"><span class="linenos">567</span></a>
</span><span id="Problem.one_gauss_newton_iter-568"><a href="#Problem.one_gauss_newton_iter-568"><span class="linenos">568</span></a><span class="sd">        Returns</span>
</span><span id="Problem.one_gauss_newton_iter-569"><a href="#Problem.one_gauss_newton_iter-569"><span class="linenos">569</span></a><span class="sd">        -------</span>
</span><span id="Problem.one_gauss_newton_iter-570"><a href="#Problem.one_gauss_newton_iter-570"><span class="linenos">570</span></a><span class="sd">        du_field : np.ndarray</span>
</span><span id="Problem.one_gauss_newton_iter-571"><a href="#Problem.one_gauss_newton_iter-571"><span class="linenos">571</span></a><span class="sd">            Incremental displacement field computed during this iteration.</span>
</span><span id="Problem.one_gauss_newton_iter-572"><a href="#Problem.one_gauss_newton_iter-572"><span class="linenos">572</span></a>
</span><span id="Problem.one_gauss_newton_iter-573"><a href="#Problem.one_gauss_newton_iter-573"><span class="linenos">573</span></a><span class="sd">        drho : float</span>
</span><span id="Problem.one_gauss_newton_iter-574"><a href="#Problem.one_gauss_newton_iter-574"><span class="linenos">574</span></a><span class="sd">            Incremental update of the transition distance parameter `rho`.</span>
</span><span id="Problem.one_gauss_newton_iter-575"><a href="#Problem.one_gauss_newton_iter-575"><span class="linenos">575</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem.one_gauss_newton_iter-576"><a href="#Problem.one_gauss_newton_iter-576"><span class="linenos">576</span></a>        <span class="n">du_field</span><span class="p">,</span> <span class="n">drho</span> <span class="o">=</span> <span class="n">iteration</span><span class="p">(</span>
</span><span id="Problem.one_gauss_newton_iter-577"><a href="#Problem.one_gauss_newton_iter-577"><span class="linenos">577</span></a>            <span class="n">u_field</span><span class="p">,</span>
</span><span id="Problem.one_gauss_newton_iter-578"><a href="#Problem.one_gauss_newton_iter-578"><span class="linenos">578</span></a>            <span class="n">rho</span><span class="p">,</span>
</span><span id="Problem.one_gauss_newton_iter-579"><a href="#Problem.one_gauss_newton_iter-579"><span class="linenos">579</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
</span><span id="Problem.one_gauss_newton_iter-580"><a href="#Problem.one_gauss_newton_iter-580"><span class="linenos">580</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">,</span>
</span><span id="Problem.one_gauss_newton_iter-581"><a href="#Problem.one_gauss_newton_iter-581"><span class="linenos">581</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span>
</span><span id="Problem.one_gauss_newton_iter-582"><a href="#Problem.one_gauss_newton_iter-582"><span class="linenos">582</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">membrane_K</span><span class="p">,</span>
</span><span id="Problem.one_gauss_newton_iter-583"><a href="#Problem.one_gauss_newton_iter-583"><span class="linenos">583</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">membrane_weight</span><span class="p">,</span>
</span><span id="Problem.one_gauss_newton_iter-584"><a href="#Problem.one_gauss_newton_iter-584"><span class="linenos">584</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dirichlet</span><span class="o">.</span><span class="n">C</span><span class="p">,</span>
</span><span id="Problem.one_gauss_newton_iter-585"><a href="#Problem.one_gauss_newton_iter-585"><span class="linenos">585</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="Problem.one_gauss_newton_iter-586"><a href="#Problem.one_gauss_newton_iter-586"><span class="linenos">586</span></a>            <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="Problem.one_gauss_newton_iter-587"><a href="#Problem.one_gauss_newton_iter-587"><span class="linenos">587</span></a>        <span class="p">)</span>
</span><span id="Problem.one_gauss_newton_iter-588"><a href="#Problem.one_gauss_newton_iter-588"><span class="linenos">588</span></a>        <span class="k">return</span> <span class="n">du_field</span><span class="p">,</span> <span class="n">drho</span>
</span></pre></div>


            <div class="docstring"><p>Perform a single Gauss-Newton iteration for the VIC problem.</p>

<p>This method updates the displacement field and the transition distance
parameter <code>rho</code> by computing the incremental corrections using the
Gauss-Newton scheme. The actual computation is performed by
<code><a href="solve.html#iteration">volVIC.solve.iteration()</a></code>.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>u_field</strong> (np.ndarray):
Current displacement field of the mesh nodes, shape (3, N).</li>
<li><strong>rho</strong> (float):
Current value of the transition distance parameter used in the VIC model.</li>
<li><strong>verbose</strong> (bool, optional):
If <code>True</code>, prints diagnostic information during the iteration.
By default, <code>True</code>.</li>
<li><strong>disable_parallel</strong> (bool, optional):
If <code>True</code>, disables parallel execution during the iteration.
By default, <code>False</code>.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>du_field</strong> (np.ndarray):
Incremental displacement field computed during this iteration.</li>
<li><strong>drho</strong> (float):
Incremental update of the transition distance parameter <code>rho</code>.</li>
</ul>
</div>


                            </div>
                            <div id="Problem.solve" class="classattr">
                                        <input id="Problem.solve-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">solve</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">u_field</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">rho</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span>,</span><span class="param">	<span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Problem.solve-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Problem.solve"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Problem.solve-590"><a href="#Problem.solve-590"><span class="linenos">590</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span>
</span><span id="Problem.solve-591"><a href="#Problem.solve-591"><span class="linenos">591</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Problem.solve-592"><a href="#Problem.solve-592"><span class="linenos">592</span></a>        <span class="n">u_field</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem.solve-593"><a href="#Problem.solve-593"><span class="linenos">593</span></a>        <span class="n">rho</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem.solve-594"><a href="#Problem.solve-594"><span class="linenos">594</span></a>        <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5e-2</span><span class="p">,</span>
</span><span id="Problem.solve-595"><a href="#Problem.solve-595"><span class="linenos">595</span></a>        <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="Problem.solve-596"><a href="#Problem.solve-596"><span class="linenos">596</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem.solve-597"><a href="#Problem.solve-597"><span class="linenos">597</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Problem.solve-598"><a href="#Problem.solve-598"><span class="linenos">598</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Problem.solve-599"><a href="#Problem.solve-599"><span class="linenos">599</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem.solve-600"><a href="#Problem.solve-600"><span class="linenos">600</span></a><span class="sd">        Solve the VIC problem using a Gauss-Newton optimization.</span>
</span><span id="Problem.solve-601"><a href="#Problem.solve-601"><span class="linenos">601</span></a>
</span><span id="Problem.solve-602"><a href="#Problem.solve-602"><span class="linenos">602</span></a><span class="sd">        This method iteratively updates the displacement field and the transition</span>
</span><span id="Problem.solve-603"><a href="#Problem.solve-603"><span class="linenos">603</span></a><span class="sd">        distance parameter `rho` to minimize the VIC energy. Each iteration is</span>
</span><span id="Problem.solve-604"><a href="#Problem.solve-604"><span class="linenos">604</span></a><span class="sd">        performed using :meth:`one_gauss_newton_iter`.</span>
</span><span id="Problem.solve-605"><a href="#Problem.solve-605"><span class="linenos">605</span></a>
</span><span id="Problem.solve-606"><a href="#Problem.solve-606"><span class="linenos">606</span></a><span class="sd">        The iteration stops when either the maximum number of iterations is</span>
</span><span id="Problem.solve-607"><a href="#Problem.solve-607"><span class="linenos">607</span></a><span class="sd">        reached or the relative update of the displacement field is below</span>
</span><span id="Problem.solve-608"><a href="#Problem.solve-608"><span class="linenos">608</span></a><span class="sd">        `eps`.</span>
</span><span id="Problem.solve-609"><a href="#Problem.solve-609"><span class="linenos">609</span></a>
</span><span id="Problem.solve-610"><a href="#Problem.solve-610"><span class="linenos">610</span></a><span class="sd">        The displacement field is updated in-place and stored in `u_field`.</span>
</span><span id="Problem.solve-611"><a href="#Problem.solve-611"><span class="linenos">611</span></a><span class="sd">        The first iteration&#39;s data from all image energies are cached in</span>
</span><span id="Problem.solve-612"><a href="#Problem.solve-612"><span class="linenos">612</span></a><span class="sd">        `self.saved_data_0` for post-processing and visualization.</span>
</span><span id="Problem.solve-613"><a href="#Problem.solve-613"><span class="linenos">613</span></a>
</span><span id="Problem.solve-614"><a href="#Problem.solve-614"><span class="linenos">614</span></a><span class="sd">        Parameters</span>
</span><span id="Problem.solve-615"><a href="#Problem.solve-615"><span class="linenos">615</span></a><span class="sd">        ----------</span>
</span><span id="Problem.solve-616"><a href="#Problem.solve-616"><span class="linenos">616</span></a><span class="sd">        u_field : np.ndarray, optional</span>
</span><span id="Problem.solve-617"><a href="#Problem.solve-617"><span class="linenos">617</span></a><span class="sd">            Initial displacement field of shape (3, N). If `None` (default),</span>
</span><span id="Problem.solve-618"><a href="#Problem.solve-618"><span class="linenos">618</span></a><span class="sd">            initializes to zero.</span>
</span><span id="Problem.solve-619"><a href="#Problem.solve-619"><span class="linenos">619</span></a>
</span><span id="Problem.solve-620"><a href="#Problem.solve-620"><span class="linenos">620</span></a><span class="sd">        rho : float, optional</span>
</span><span id="Problem.solve-621"><a href="#Problem.solve-621"><span class="linenos">621</span></a><span class="sd">            Initial value of the distance scaling parameter. If `None` (default),</span>
</span><span id="Problem.solve-622"><a href="#Problem.solve-622"><span class="linenos">622</span></a><span class="sd">            `self.initial_rho` is used.</span>
</span><span id="Problem.solve-623"><a href="#Problem.solve-623"><span class="linenos">623</span></a>
</span><span id="Problem.solve-624"><a href="#Problem.solve-624"><span class="linenos">624</span></a><span class="sd">        eps : float, optional</span>
</span><span id="Problem.solve-625"><a href="#Problem.solve-625"><span class="linenos">625</span></a><span class="sd">            Convergence tolerance. The relative norm of the displacement update</span>
</span><span id="Problem.solve-626"><a href="#Problem.solve-626"><span class="linenos">626</span></a><span class="sd">            is compared to `eps` to decide convergence. Default is `5e-2`.</span>
</span><span id="Problem.solve-627"><a href="#Problem.solve-627"><span class="linenos">627</span></a>
</span><span id="Problem.solve-628"><a href="#Problem.solve-628"><span class="linenos">628</span></a><span class="sd">        max_iter : int, optional</span>
</span><span id="Problem.solve-629"><a href="#Problem.solve-629"><span class="linenos">629</span></a><span class="sd">            Maximum number of Gauss-Newton iterations. Default is `20`.</span>
</span><span id="Problem.solve-630"><a href="#Problem.solve-630"><span class="linenos">630</span></a>
</span><span id="Problem.solve-631"><a href="#Problem.solve-631"><span class="linenos">631</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="Problem.solve-632"><a href="#Problem.solve-632"><span class="linenos">632</span></a><span class="sd">            If `True`, prints iteration diagnostics including `rho` and</span>
</span><span id="Problem.solve-633"><a href="#Problem.solve-633"><span class="linenos">633</span></a><span class="sd">            relative displacement updates. Default is `True`.</span>
</span><span id="Problem.solve-634"><a href="#Problem.solve-634"><span class="linenos">634</span></a>
</span><span id="Problem.solve-635"><a href="#Problem.solve-635"><span class="linenos">635</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="Problem.solve-636"><a href="#Problem.solve-636"><span class="linenos">636</span></a><span class="sd">            If `True`, disables parallel execution during the iterations.</span>
</span><span id="Problem.solve-637"><a href="#Problem.solve-637"><span class="linenos">637</span></a><span class="sd">            Default is `False`.</span>
</span><span id="Problem.solve-638"><a href="#Problem.solve-638"><span class="linenos">638</span></a>
</span><span id="Problem.solve-639"><a href="#Problem.solve-639"><span class="linenos">639</span></a><span class="sd">        Returns</span>
</span><span id="Problem.solve-640"><a href="#Problem.solve-640"><span class="linenos">640</span></a><span class="sd">        -------</span>
</span><span id="Problem.solve-641"><a href="#Problem.solve-641"><span class="linenos">641</span></a><span class="sd">        u_field : np.ndarray</span>
</span><span id="Problem.solve-642"><a href="#Problem.solve-642"><span class="linenos">642</span></a><span class="sd">            Final displacement field after convergence or reaching `max_iter`.</span>
</span><span id="Problem.solve-643"><a href="#Problem.solve-643"><span class="linenos">643</span></a>
</span><span id="Problem.solve-644"><a href="#Problem.solve-644"><span class="linenos">644</span></a><span class="sd">        rho : float</span>
</span><span id="Problem.solve-645"><a href="#Problem.solve-645"><span class="linenos">645</span></a><span class="sd">            Final value of the transition distance parameter after convergence.</span>
</span><span id="Problem.solve-646"><a href="#Problem.solve-646"><span class="linenos">646</span></a>
</span><span id="Problem.solve-647"><a href="#Problem.solve-647"><span class="linenos">647</span></a><span class="sd">        Notes</span>
</span><span id="Problem.solve-648"><a href="#Problem.solve-648"><span class="linenos">648</span></a><span class="sd">        -----</span>
</span><span id="Problem.solve-649"><a href="#Problem.solve-649"><span class="linenos">649</span></a><span class="sd">        This method relies on :meth:`one_gauss_newton_iter` to compute the</span>
</span><span id="Problem.solve-650"><a href="#Problem.solve-650"><span class="linenos">650</span></a><span class="sd">        incremental updates for each iteration.</span>
</span><span id="Problem.solve-651"><a href="#Problem.solve-651"><span class="linenos">651</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem.solve-652"><a href="#Problem.solve-652"><span class="linenos">652</span></a>        <span class="k">if</span> <span class="n">u_field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Problem.solve-653"><a href="#Problem.solve-653"><span class="linenos">653</span></a>            <span class="n">u_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">connectivity</span><span class="o">.</span><span class="n">nb_unique_nodes</span><span class="p">))</span>
</span><span id="Problem.solve-654"><a href="#Problem.solve-654"><span class="linenos">654</span></a>        <span class="k">if</span> <span class="n">rho</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Problem.solve-655"><a href="#Problem.solve-655"><span class="linenos">655</span></a>            <span class="n">rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_rho</span>
</span><span id="Problem.solve-656"><a href="#Problem.solve-656"><span class="linenos">656</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
</span><span id="Problem.solve-657"><a href="#Problem.solve-657"><span class="linenos">657</span></a>            <span class="n">du_field</span><span class="p">,</span> <span class="n">drho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_gauss_newton_iter</span><span class="p">(</span>
</span><span id="Problem.solve-658"><a href="#Problem.solve-658"><span class="linenos">658</span></a>                <span class="n">u_field</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span>
</span><span id="Problem.solve-659"><a href="#Problem.solve-659"><span class="linenos">659</span></a>            <span class="p">)</span>
</span><span id="Problem.solve-660"><a href="#Problem.solve-660"><span class="linenos">660</span></a>            <span class="n">u_field</span> <span class="o">+=</span> <span class="n">du_field</span>
</span><span id="Problem.solve-661"><a href="#Problem.solve-661"><span class="linenos">661</span></a>            <span class="n">rho</span> <span class="o">+=</span> <span class="n">drho</span>
</span><span id="Problem.solve-662"><a href="#Problem.solve-662"><span class="linenos">662</span></a>            <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
</span><span id="Problem.solve-663"><a href="#Problem.solve-663"><span class="linenos">663</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Problem.solve-664"><a href="#Problem.solve-664"><span class="linenos">664</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">saved_data_0</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Problem.solve-665"><a href="#Problem.solve-665"><span class="linenos">665</span></a>                    <span class="n">deepcopy</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">saved_data</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span>
</span><span id="Problem.solve-666"><a href="#Problem.solve-666"><span class="linenos">666</span></a>                <span class="p">]</span>
</span><span id="Problem.solve-667"><a href="#Problem.solve-667"><span class="linenos">667</span></a>            <span class="n">du_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">du_field</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u_field</span><span class="p">)</span>
</span><span id="Problem.solve-668"><a href="#Problem.solve-668"><span class="linenos">668</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.solve-669"><a href="#Problem.solve-669"><span class="linenos">669</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;iter = </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, rho = </span><span class="si">{</span><span class="n">rho</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, du/u = </span><span class="si">{</span><span class="n">du_u</span><span class="si">:</span><span class="s2">.2E</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Problem.solve-670"><a href="#Problem.solve-670"><span class="linenos">670</span></a>            <span class="k">if</span> <span class="n">du_u</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">:</span>
</span><span id="Problem.solve-671"><a href="#Problem.solve-671"><span class="linenos">671</span></a>                <span class="k">break</span>
</span><span id="Problem.solve-672"><a href="#Problem.solve-672"><span class="linenos">672</span></a>        <span class="k">return</span> <span class="n">u_field</span><span class="p">,</span> <span class="n">rho</span>
</span></pre></div>


            <div class="docstring"><p>Solve the VIC problem using a Gauss-Newton optimization.</p>

<p>This method iteratively updates the displacement field and the transition
distance parameter <code>rho</code> to minimize the VIC energy. Each iteration is
performed using <code><a href="#Problem.one_gauss_newton_iter">one_gauss_newton_iter()</a></code>.</p>

<p>The iteration stops when either the maximum number of iterations is
reached or the relative update of the displacement field is below
<code>eps</code>.</p>

<p>The displacement field is updated in-place and stored in <code>u_field</code>.
The first iteration's data from all image energies are cached in
<code>self.saved_data_0</code> for post-processing and visualization.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>u_field</strong> (np.ndarray, optional):
Initial displacement field of shape (3, N). If <code>None</code> (default),
initializes to zero.</li>
<li><strong>rho</strong> (float, optional):
Initial value of the distance scaling parameter. If <code>None</code> (default),
<code>self.initial_rho</code> is used.</li>
<li><strong>eps</strong> (float, optional):
Convergence tolerance. The relative norm of the displacement update
is compared to <code>eps</code> to decide convergence. Default is <code>5e-2</code>.</li>
<li><strong>max_iter</strong> (int, optional):
Maximum number of Gauss-Newton iterations. Default is <code>20</code>.</li>
<li><strong>verbose</strong> (bool, optional):
If <code>True</code>, prints iteration diagnostics including <code>rho</code> and
relative displacement updates. Default is <code>True</code>.</li>
<li><strong>disable_parallel</strong> (bool, optional):
If <code>True</code>, disables parallel execution during the iterations.
Default is <code>False</code>.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>u_field</strong> (np.ndarray):
Final displacement field after convergence or reaching <code>max_iter</code>.</li>
<li><strong>rho</strong> (float):
Final value of the transition distance parameter after convergence.</li>
</ul>

<h6 id="notes">Notes</h6>

<p>This method relies on <code><a href="#Problem.one_gauss_newton_iter">one_gauss_newton_iter()</a></code> to compute the
incremental updates for each iteration.</p>
</div>


                            </div>
                            <div id="Problem.save_paraview" class="classattr">
                                        <input id="Problem.save_paraview-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_paraview</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">u_field</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">]</span>,</span><span class="param">	<span class="n">folder</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Problem.save_paraview-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Problem.save_paraview"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Problem.save_paraview-674"><a href="#Problem.save_paraview-674"><span class="linenos">674</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_paraview</span><span class="p">(</span>
</span><span id="Problem.save_paraview-675"><a href="#Problem.save_paraview-675"><span class="linenos">675</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Problem.save_paraview-676"><a href="#Problem.save_paraview-676"><span class="linenos">676</span></a>        <span class="n">u_field</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
</span><span id="Problem.save_paraview-677"><a href="#Problem.save_paraview-677"><span class="linenos">677</span></a>        <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Problem.save_paraview-678"><a href="#Problem.save_paraview-678"><span class="linenos">678</span></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Problem.save_paraview-679"><a href="#Problem.save_paraview-679"><span class="linenos">679</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Problem.save_paraview-680"><a href="#Problem.save_paraview-680"><span class="linenos">680</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem.save_paraview-681"><a href="#Problem.save_paraview-681"><span class="linenos">681</span></a>    <span class="p">):</span>
</span><span id="Problem.save_paraview-682"><a href="#Problem.save_paraview-682"><span class="linenos">682</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem.save_paraview-683"><a href="#Problem.save_paraview-683"><span class="linenos">683</span></a><span class="sd">        Export the current VIC results to Paraview-compatible VTK files.</span>
</span><span id="Problem.save_paraview-684"><a href="#Problem.save_paraview-684"><span class="linenos">684</span></a>
</span><span id="Problem.save_paraview-685"><a href="#Problem.save_paraview-685"><span class="linenos">685</span></a><span class="sd">        This method computes the signed distance fields before and after the</span>
</span><span id="Problem.save_paraview-686"><a href="#Problem.save_paraview-686"><span class="linenos">686</span></a><span class="sd">        displacement update, associates them with the mesh nodes, and calls</span>
</span><span id="Problem.save_paraview-687"><a href="#Problem.save_paraview-687"><span class="linenos">687</span></a><span class="sd">        the mesh&#39;s :meth:`Mesh.save_paraview` method to save all fields for</span>
</span><span id="Problem.save_paraview-688"><a href="#Problem.save_paraview-688"><span class="linenos">688</span></a><span class="sd">        visualization in Paraview.</span>
</span><span id="Problem.save_paraview-689"><a href="#Problem.save_paraview-689"><span class="linenos">689</span></a>
</span><span id="Problem.save_paraview-690"><a href="#Problem.save_paraview-690"><span class="linenos">690</span></a><span class="sd">        The exported fields include:</span>
</span><span id="Problem.save_paraview-691"><a href="#Problem.save_paraview-691"><span class="linenos">691</span></a><span class="sd">            - `u`: displacement field provided in `u_field`.</span>
</span><span id="Problem.save_paraview-692"><a href="#Problem.save_paraview-692"><span class="linenos">692</span></a><span class="sd">            - `d0`: signed distance fields at the first iteration (cached in</span>
</span><span id="Problem.save_paraview-693"><a href="#Problem.save_paraview-693"><span class="linenos">693</span></a><span class="sd">              `self.saved_data_0`).</span>
</span><span id="Problem.save_paraview-694"><a href="#Problem.save_paraview-694"><span class="linenos">694</span></a><span class="sd">            - `d`: signed distance fields at the current iteration (not computed</span>
</span><span id="Problem.save_paraview-695"><a href="#Problem.save_paraview-695"><span class="linenos">695</span></a><span class="sd">              from `u_field`).</span>
</span><span id="Problem.save_paraview-696"><a href="#Problem.save_paraview-696"><span class="linenos">696</span></a>
</span><span id="Problem.save_paraview-697"><a href="#Problem.save_paraview-697"><span class="linenos">697</span></a><span class="sd">        Parameters</span>
</span><span id="Problem.save_paraview-698"><a href="#Problem.save_paraview-698"><span class="linenos">698</span></a><span class="sd">        ----------</span>
</span><span id="Problem.save_paraview-699"><a href="#Problem.save_paraview-699"><span class="linenos">699</span></a><span class="sd">        u_field : np.ndarray</span>
</span><span id="Problem.save_paraview-700"><a href="#Problem.save_paraview-700"><span class="linenos">700</span></a><span class="sd">            Displacement field of shape (3, N) to be saved.</span>
</span><span id="Problem.save_paraview-701"><a href="#Problem.save_paraview-701"><span class="linenos">701</span></a>
</span><span id="Problem.save_paraview-702"><a href="#Problem.save_paraview-702"><span class="linenos">702</span></a><span class="sd">        folder : str</span>
</span><span id="Problem.save_paraview-703"><a href="#Problem.save_paraview-703"><span class="linenos">703</span></a><span class="sd">            Destination folder where the VTK files will be written.</span>
</span><span id="Problem.save_paraview-704"><a href="#Problem.save_paraview-704"><span class="linenos">704</span></a>
</span><span id="Problem.save_paraview-705"><a href="#Problem.save_paraview-705"><span class="linenos">705</span></a><span class="sd">        name : str</span>
</span><span id="Problem.save_paraview-706"><a href="#Problem.save_paraview-706"><span class="linenos">706</span></a><span class="sd">            Base name for the exported VTK files.</span>
</span><span id="Problem.save_paraview-707"><a href="#Problem.save_paraview-707"><span class="linenos">707</span></a>
</span><span id="Problem.save_paraview-708"><a href="#Problem.save_paraview-708"><span class="linenos">708</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="Problem.save_paraview-709"><a href="#Problem.save_paraview-709"><span class="linenos">709</span></a><span class="sd">            If `True`, disables parallel execution for distance field computation</span>
</span><span id="Problem.save_paraview-710"><a href="#Problem.save_paraview-710"><span class="linenos">710</span></a><span class="sd">            and mesh export. Default is `False`.</span>
</span><span id="Problem.save_paraview-711"><a href="#Problem.save_paraview-711"><span class="linenos">711</span></a>
</span><span id="Problem.save_paraview-712"><a href="#Problem.save_paraview-712"><span class="linenos">712</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="Problem.save_paraview-713"><a href="#Problem.save_paraview-713"><span class="linenos">713</span></a><span class="sd">            If `True` (default), prints diagnostic messages during computation</span>
</span><span id="Problem.save_paraview-714"><a href="#Problem.save_paraview-714"><span class="linenos">714</span></a><span class="sd">            and export.</span>
</span><span id="Problem.save_paraview-715"><a href="#Problem.save_paraview-715"><span class="linenos">715</span></a>
</span><span id="Problem.save_paraview-716"><a href="#Problem.save_paraview-716"><span class="linenos">716</span></a><span class="sd">        Notes</span>
</span><span id="Problem.save_paraview-717"><a href="#Problem.save_paraview-717"><span class="linenos">717</span></a><span class="sd">        -----</span>
</span><span id="Problem.save_paraview-718"><a href="#Problem.save_paraview-718"><span class="linenos">718</span></a><span class="sd">        The method automatically constructs the `XI_list` from the parametric</span>
</span><span id="Problem.save_paraview-719"><a href="#Problem.save_paraview-719"><span class="linenos">719</span></a><span class="sd">        coordinates of each image energy element and sets</span>
</span><span id="Problem.save_paraview-720"><a href="#Problem.save_paraview-720"><span class="linenos">720</span></a><span class="sd">        `fields_on_interior_only=&quot;auto&quot;` for the mesh export.</span>
</span><span id="Problem.save_paraview-721"><a href="#Problem.save_paraview-721"><span class="linenos">721</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem.save_paraview-722"><a href="#Problem.save_paraview-722"><span class="linenos">722</span></a>        <span class="n">d0</span> <span class="o">=</span> <span class="n">compute_distance_field</span><span class="p">(</span>
</span><span id="Problem.save_paraview-723"><a href="#Problem.save_paraview-723"><span class="linenos">723</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">,</span>
</span><span id="Problem.save_paraview-724"><a href="#Problem.save_paraview-724"><span class="linenos">724</span></a>            <span class="n">saved_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_data_0</span><span class="p">,</span>
</span><span id="Problem.save_paraview-725"><a href="#Problem.save_paraview-725"><span class="linenos">725</span></a>            <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="Problem.save_paraview-726"><a href="#Problem.save_paraview-726"><span class="linenos">726</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="Problem.save_paraview-727"><a href="#Problem.save_paraview-727"><span class="linenos">727</span></a>        <span class="p">)</span>
</span><span id="Problem.save_paraview-728"><a href="#Problem.save_paraview-728"><span class="linenos">728</span></a>        <span class="n">d</span> <span class="o">=</span> <span class="n">compute_distance_field</span><span class="p">(</span>
</span><span id="Problem.save_paraview-729"><a href="#Problem.save_paraview-729"><span class="linenos">729</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">,</span>
</span><span id="Problem.save_paraview-730"><a href="#Problem.save_paraview-730"><span class="linenos">730</span></a>            <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="Problem.save_paraview-731"><a href="#Problem.save_paraview-731"><span class="linenos">731</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="Problem.save_paraview-732"><a href="#Problem.save_paraview-732"><span class="linenos">732</span></a>        <span class="p">)</span>
</span><span id="Problem.save_paraview-733"><a href="#Problem.save_paraview-733"><span class="linenos">733</span></a>        <span class="n">separated_fields</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">di</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="s2">&quot;d0&quot;</span><span class="p">:</span> <span class="n">d0i</span><span class="p">[</span><span class="kc">None</span><span class="p">]}</span> <span class="k">for</span> <span class="n">di</span><span class="p">,</span> <span class="n">d0i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d0</span><span class="p">)]</span>
</span><span id="Problem.save_paraview-734"><a href="#Problem.save_paraview-734"><span class="linenos">734</span></a>        <span class="n">unique_fields</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="n">u_field</span><span class="p">[</span><span class="kc">None</span><span class="p">]}</span>
</span><span id="Problem.save_paraview-735"><a href="#Problem.save_paraview-735"><span class="linenos">735</span></a>        <span class="n">XI_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">e</span><span class="o">.</span><span class="n">xi</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">eta</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">]</span>
</span><span id="Problem.save_paraview-736"><a href="#Problem.save_paraview-736"><span class="linenos">736</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">save_paraview</span><span class="p">(</span>
</span><span id="Problem.save_paraview-737"><a href="#Problem.save_paraview-737"><span class="linenos">737</span></a>            <span class="n">folder</span><span class="p">,</span>
</span><span id="Problem.save_paraview-738"><a href="#Problem.save_paraview-738"><span class="linenos">738</span></a>            <span class="n">name</span><span class="p">,</span>
</span><span id="Problem.save_paraview-739"><a href="#Problem.save_paraview-739"><span class="linenos">739</span></a>            <span class="n">unique_fields</span><span class="o">=</span><span class="n">unique_fields</span><span class="p">,</span>
</span><span id="Problem.save_paraview-740"><a href="#Problem.save_paraview-740"><span class="linenos">740</span></a>            <span class="n">separated_fields</span><span class="o">=</span><span class="n">separated_fields</span><span class="p">,</span>
</span><span id="Problem.save_paraview-741"><a href="#Problem.save_paraview-741"><span class="linenos">741</span></a>            <span class="n">XI_list</span><span class="o">=</span><span class="n">XI_list</span><span class="p">,</span>
</span><span id="Problem.save_paraview-742"><a href="#Problem.save_paraview-742"><span class="linenos">742</span></a>            <span class="n">fields_on_interior_only</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="Problem.save_paraview-743"><a href="#Problem.save_paraview-743"><span class="linenos">743</span></a>            <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="Problem.save_paraview-744"><a href="#Problem.save_paraview-744"><span class="linenos">744</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="Problem.save_paraview-745"><a href="#Problem.save_paraview-745"><span class="linenos">745</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Export the current VIC results to Paraview-compatible VTK files.</p>

<p>This method computes the signed distance fields before and after the
displacement update, associates them with the mesh nodes, and calls
the mesh's <code>Mesh.save_paraview()</code> method to save all fields for
visualization in Paraview.</p>

<p>The exported fields include:
    - <code>u</code>: displacement field provided in <code>u_field</code>.
    - <code>d0</code>: signed distance fields at the first iteration (cached in
      <code>self.saved_data_0</code>).
    - <code>d</code>: signed distance fields at the current iteration (not computed
      from <code>u_field</code>).</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>u_field</strong> (np.ndarray):
Displacement field of shape (3, N) to be saved.</li>
<li><strong>folder</strong> (str):
Destination folder where the VTK files will be written.</li>
<li><strong>name</strong> (str):
Base name for the exported VTK files.</li>
<li><strong>disable_parallel</strong> (bool, optional):
If <code>True</code>, disables parallel execution for distance field computation
and mesh export. Default is <code>False</code>.</li>
<li><strong>verbose</strong> (bool, optional):
If <code>True</code> (default), prints diagnostic messages during computation
and export.</li>
</ul>

<h6 id="notes">Notes</h6>

<p>The method automatically constructs the <code>XI_list</code> from the parametric
coordinates of each image energy element and sets
<code>fields_on_interior_only="auto"</code> for the mesh export.</p>
</div>


                            </div>
                            <div id="Problem.plot_results" class="classattr">
                                        <input id="Problem.plot_results-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_results</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">u_field</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">n_colors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span>,</span><span class="param">	<span class="n">interior_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">plt_ctrl_mesh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">pv_plotter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pyvista</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">Plotter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">elem_sep_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>,</span><span class="param">	<span class="n">ctrl_poly_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span>,</span><span class="param">	<span class="o">**</span><span class="n">pv_add_mesh_kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Problem.plot_results-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Problem.plot_results"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Problem.plot_results-747"><a href="#Problem.plot_results-747"><span class="linenos">747</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_results</span><span class="p">(</span>
</span><span id="Problem.plot_results-748"><a href="#Problem.plot_results-748"><span class="linenos">748</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Problem.plot_results-749"><a href="#Problem.plot_results-749"><span class="linenos">749</span></a>        <span class="n">u_field</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem.plot_results-750"><a href="#Problem.plot_results-750"><span class="linenos">750</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Problem.plot_results-751"><a href="#Problem.plot_results-751"><span class="linenos">751</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem.plot_results-752"><a href="#Problem.plot_results-752"><span class="linenos">752</span></a>        <span class="n">n_colors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
</span><span id="Problem.plot_results-753"><a href="#Problem.plot_results-753"><span class="linenos">753</span></a>        <span class="n">interior_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem.plot_results-754"><a href="#Problem.plot_results-754"><span class="linenos">754</span></a>        <span class="n">plt_ctrl_mesh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Problem.plot_results-755"><a href="#Problem.plot_results-755"><span class="linenos">755</span></a>        <span class="n">pv_plotter</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pv</span><span class="o">.</span><span class="n">Plotter</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Problem.plot_results-756"><a href="#Problem.plot_results-756"><span class="linenos">756</span></a>        <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Problem.plot_results-757"><a href="#Problem.plot_results-757"><span class="linenos">757</span></a>        <span class="n">elem_sep_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="Problem.plot_results-758"><a href="#Problem.plot_results-758"><span class="linenos">758</span></a>        <span class="n">ctrl_poly_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
</span><span id="Problem.plot_results-759"><a href="#Problem.plot_results-759"><span class="linenos">759</span></a>        <span class="o">**</span><span class="n">pv_add_mesh_kwargs</span><span class="p">,</span>
</span><span id="Problem.plot_results-760"><a href="#Problem.plot_results-760"><span class="linenos">760</span></a>    <span class="p">):</span>
</span><span id="Problem.plot_results-761"><a href="#Problem.plot_results-761"><span class="linenos">761</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem.plot_results-762"><a href="#Problem.plot_results-762"><span class="linenos">762</span></a><span class="sd">        Visualize VIC results with PyVista, optionally applying a displacement field.</span>
</span><span id="Problem.plot_results-763"><a href="#Problem.plot_results-763"><span class="linenos">763</span></a>
</span><span id="Problem.plot_results-764"><a href="#Problem.plot_results-764"><span class="linenos">764</span></a><span class="sd">        This method plots the signed distance fields of the mesh with respect to</span>
</span><span id="Problem.plot_results-765"><a href="#Problem.plot_results-765"><span class="linenos">765</span></a><span class="sd">        the image features. If a displacement field `u_field` is provided, it</span>
</span><span id="Problem.plot_results-766"><a href="#Problem.plot_results-766"><span class="linenos">766</span></a><span class="sd">        is applied to a copy of the mesh for visualization; otherwise, the</span>
</span><span id="Problem.plot_results-767"><a href="#Problem.plot_results-767"><span class="linenos">767</span></a><span class="sd">        distances from the first iteration are displayed. It is recommended</span>
</span><span id="Problem.plot_results-768"><a href="#Problem.plot_results-768"><span class="linenos">768</span></a><span class="sd">        to pass the displacement field obtained from `solve` to make sure to match</span>
</span><span id="Problem.plot_results-769"><a href="#Problem.plot_results-769"><span class="linenos">769</span></a><span class="sd">        the distance map to the correct displacement field.</span>
</span><span id="Problem.plot_results-770"><a href="#Problem.plot_results-770"><span class="linenos">770</span></a>
</span><span id="Problem.plot_results-771"><a href="#Problem.plot_results-771"><span class="linenos">771</span></a><span class="sd">        The visualization can be customized, including the number of colors,</span>
</span><span id="Problem.plot_results-772"><a href="#Problem.plot_results-772"><span class="linenos">772</span></a><span class="sd">        control mesh display, scalar bar, and interior-only rendering. Any</span>
</span><span id="Problem.plot_results-773"><a href="#Problem.plot_results-773"><span class="linenos">773</span></a><span class="sd">        additional keyword arguments are passed to :meth:`Mesh.plot`, which</span>
</span><span id="Problem.plot_results-774"><a href="#Problem.plot_results-774"><span class="linenos">774</span></a><span class="sd">        ultimately forwards them to :meth:`pv.Plotter.add_mesh`.</span>
</span><span id="Problem.plot_results-775"><a href="#Problem.plot_results-775"><span class="linenos">775</span></a>
</span><span id="Problem.plot_results-776"><a href="#Problem.plot_results-776"><span class="linenos">776</span></a><span class="sd">        Parameters</span>
</span><span id="Problem.plot_results-777"><a href="#Problem.plot_results-777"><span class="linenos">777</span></a><span class="sd">        ----------</span>
</span><span id="Problem.plot_results-778"><a href="#Problem.plot_results-778"><span class="linenos">778</span></a><span class="sd">        u_field : np.ndarray or None, optional</span>
</span><span id="Problem.plot_results-779"><a href="#Problem.plot_results-779"><span class="linenos">779</span></a><span class="sd">            Displacement field to apply to the mesh for visualization. If `None`</span>
</span><span id="Problem.plot_results-780"><a href="#Problem.plot_results-780"><span class="linenos">780</span></a><span class="sd">            (default), the distances from the first iteration (`self.saved_data_0`)</span>
</span><span id="Problem.plot_results-781"><a href="#Problem.plot_results-781"><span class="linenos">781</span></a><span class="sd">            are displayed. If provided, the mesh is warped according to this</span>
</span><span id="Problem.plot_results-782"><a href="#Problem.plot_results-782"><span class="linenos">782</span></a><span class="sd">            displacement. To correctly display the most recent VIC results,</span>
</span><span id="Problem.plot_results-783"><a href="#Problem.plot_results-783"><span class="linenos">783</span></a><span class="sd">            pass the `u_field` output from the `solve` method, as the distance</span>
</span><span id="Problem.plot_results-784"><a href="#Problem.plot_results-784"><span class="linenos">784</span></a><span class="sd">            map displayed corresponds to the last iteration computed by the</span>
</span><span id="Problem.plot_results-785"><a href="#Problem.plot_results-785"><span class="linenos">785</span></a><span class="sd">            image energy terms.</span>
</span><span id="Problem.plot_results-786"><a href="#Problem.plot_results-786"><span class="linenos">786</span></a>
</span><span id="Problem.plot_results-787"><a href="#Problem.plot_results-787"><span class="linenos">787</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="Problem.plot_results-788"><a href="#Problem.plot_results-788"><span class="linenos">788</span></a><span class="sd">            If `True`, disables parallel computation of distance fields.</span>
</span><span id="Problem.plot_results-789"><a href="#Problem.plot_results-789"><span class="linenos">789</span></a><span class="sd">            Default is `False`.</span>
</span><span id="Problem.plot_results-790"><a href="#Problem.plot_results-790"><span class="linenos">790</span></a>
</span><span id="Problem.plot_results-791"><a href="#Problem.plot_results-791"><span class="linenos">791</span></a><span class="sd">        verbose : bool, optional</span>
</span><span id="Problem.plot_results-792"><a href="#Problem.plot_results-792"><span class="linenos">792</span></a><span class="sd">            If `True`, prints diagnostic messages. Default is `True`.</span>
</span><span id="Problem.plot_results-793"><a href="#Problem.plot_results-793"><span class="linenos">793</span></a>
</span><span id="Problem.plot_results-794"><a href="#Problem.plot_results-794"><span class="linenos">794</span></a><span class="sd">        n_colors : int, optional</span>
</span><span id="Problem.plot_results-795"><a href="#Problem.plot_results-795"><span class="linenos">795</span></a><span class="sd">            Number of discrete colors in the colormap. Default is `15`.</span>
</span><span id="Problem.plot_results-796"><a href="#Problem.plot_results-796"><span class="linenos">796</span></a>
</span><span id="Problem.plot_results-797"><a href="#Problem.plot_results-797"><span class="linenos">797</span></a><span class="sd">        interior_only : bool, optional</span>
</span><span id="Problem.plot_results-798"><a href="#Problem.plot_results-798"><span class="linenos">798</span></a><span class="sd">            If `True`, only interior elements of the mesh are plotted.</span>
</span><span id="Problem.plot_results-799"><a href="#Problem.plot_results-799"><span class="linenos">799</span></a><span class="sd">            Default is `True`.</span>
</span><span id="Problem.plot_results-800"><a href="#Problem.plot_results-800"><span class="linenos">800</span></a>
</span><span id="Problem.plot_results-801"><a href="#Problem.plot_results-801"><span class="linenos">801</span></a><span class="sd">        plt_ctrl_mesh : bool, optional</span>
</span><span id="Problem.plot_results-802"><a href="#Problem.plot_results-802"><span class="linenos">802</span></a><span class="sd">            If `True`, overlays the control mesh on the plot.</span>
</span><span id="Problem.plot_results-803"><a href="#Problem.plot_results-803"><span class="linenos">803</span></a><span class="sd">            Default is `False`.</span>
</span><span id="Problem.plot_results-804"><a href="#Problem.plot_results-804"><span class="linenos">804</span></a>
</span><span id="Problem.plot_results-805"><a href="#Problem.plot_results-805"><span class="linenos">805</span></a><span class="sd">        pv_plotter : pv.Plotter or None, optional</span>
</span><span id="Problem.plot_results-806"><a href="#Problem.plot_results-806"><span class="linenos">806</span></a><span class="sd">            PyVista plotter object to use. If `None`, a new plotter is created.</span>
</span><span id="Problem.plot_results-807"><a href="#Problem.plot_results-807"><span class="linenos">807</span></a>
</span><span id="Problem.plot_results-808"><a href="#Problem.plot_results-808"><span class="linenos">808</span></a><span class="sd">        show : bool, optional</span>
</span><span id="Problem.plot_results-809"><a href="#Problem.plot_results-809"><span class="linenos">809</span></a><span class="sd">            If `True`, displays the plot immediately. Default is `True`.</span>
</span><span id="Problem.plot_results-810"><a href="#Problem.plot_results-810"><span class="linenos">810</span></a>
</span><span id="Problem.plot_results-811"><a href="#Problem.plot_results-811"><span class="linenos">811</span></a><span class="sd">        elem_sep_color : str, optional</span>
</span><span id="Problem.plot_results-812"><a href="#Problem.plot_results-812"><span class="linenos">812</span></a><span class="sd">            Color used for separating elements. Only applied if `interior_only`</span>
</span><span id="Problem.plot_results-813"><a href="#Problem.plot_results-813"><span class="linenos">813</span></a><span class="sd">            is `False`. Default is `&#39;black&#39;`.</span>
</span><span id="Problem.plot_results-814"><a href="#Problem.plot_results-814"><span class="linenos">814</span></a>
</span><span id="Problem.plot_results-815"><a href="#Problem.plot_results-815"><span class="linenos">815</span></a><span class="sd">        ctrl_poly_color : str, optional</span>
</span><span id="Problem.plot_results-816"><a href="#Problem.plot_results-816"><span class="linenos">816</span></a><span class="sd">            Color of the control mesh. Only applied if `plt_ctrl_mesh` is `True`</span>
</span><span id="Problem.plot_results-817"><a href="#Problem.plot_results-817"><span class="linenos">817</span></a><span class="sd">            and `interior_only` is `False`. Default is `&#39;green&#39;`.</span>
</span><span id="Problem.plot_results-818"><a href="#Problem.plot_results-818"><span class="linenos">818</span></a>
</span><span id="Problem.plot_results-819"><a href="#Problem.plot_results-819"><span class="linenos">819</span></a><span class="sd">        **pv_add_mesh_kwargs : dict, optional</span>
</span><span id="Problem.plot_results-820"><a href="#Problem.plot_results-820"><span class="linenos">820</span></a><span class="sd">            Additional keyword arguments passed to :meth:`Mesh.plot`, such as</span>
</span><span id="Problem.plot_results-821"><a href="#Problem.plot_results-821"><span class="linenos">821</span></a><span class="sd">            `cmap`, `clim`, `scalar_bar_args`, etc.</span>
</span><span id="Problem.plot_results-822"><a href="#Problem.plot_results-822"><span class="linenos">822</span></a>
</span><span id="Problem.plot_results-823"><a href="#Problem.plot_results-823"><span class="linenos">823</span></a><span class="sd">        Returns</span>
</span><span id="Problem.plot_results-824"><a href="#Problem.plot_results-824"><span class="linenos">824</span></a><span class="sd">        -------</span>
</span><span id="Problem.plot_results-825"><a href="#Problem.plot_results-825"><span class="linenos">825</span></a><span class="sd">        pv.Plotter or None</span>
</span><span id="Problem.plot_results-826"><a href="#Problem.plot_results-826"><span class="linenos">826</span></a><span class="sd">            The PyVista plotter object used for the visualization.</span>
</span><span id="Problem.plot_results-827"><a href="#Problem.plot_results-827"><span class="linenos">827</span></a>
</span><span id="Problem.plot_results-828"><a href="#Problem.plot_results-828"><span class="linenos">828</span></a><span class="sd">        Notes</span>
</span><span id="Problem.plot_results-829"><a href="#Problem.plot_results-829"><span class="linenos">829</span></a><span class="sd">        -----</span>
</span><span id="Problem.plot_results-830"><a href="#Problem.plot_results-830"><span class="linenos">830</span></a><span class="sd">        - The signed distance field `d` is computed from the image energies via</span>
</span><span id="Problem.plot_results-831"><a href="#Problem.plot_results-831"><span class="linenos">831</span></a><span class="sd">          :func:`volVIC.VirtualImageCorrelationEnergyElem.compute_distance_field`.</span>
</span><span id="Problem.plot_results-832"><a href="#Problem.plot_results-832"><span class="linenos">832</span></a><span class="sd">        - The default colormap is a resampled `&quot;RdBu&quot;` with `n_colors`.</span>
</span><span id="Problem.plot_results-833"><a href="#Problem.plot_results-833"><span class="linenos">833</span></a><span class="sd">        - Scalar bar properties are automatically set but can be overridden via</span>
</span><span id="Problem.plot_results-834"><a href="#Problem.plot_results-834"><span class="linenos">834</span></a><span class="sd">          `pv_add_mesh_kwargs[&quot;scalar_bar_args&quot;]`.</span>
</span><span id="Problem.plot_results-835"><a href="#Problem.plot_results-835"><span class="linenos">835</span></a><span class="sd">        - To make sure the deformation matches the distance field, always pass the</span>
</span><span id="Problem.plot_results-836"><a href="#Problem.plot_results-836"><span class="linenos">836</span></a><span class="sd">          displacement field returned by :meth:`solve`.</span>
</span><span id="Problem.plot_results-837"><a href="#Problem.plot_results-837"><span class="linenos">837</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem.plot_results-838"><a href="#Problem.plot_results-838"><span class="linenos">838</span></a>        <span class="k">if</span> <span class="n">u_field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Problem.plot_results-839"><a href="#Problem.plot_results-839"><span class="linenos">839</span></a>            <span class="n">d</span> <span class="o">=</span> <span class="n">compute_distance_field</span><span class="p">(</span>
</span><span id="Problem.plot_results-840"><a href="#Problem.plot_results-840"><span class="linenos">840</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">,</span>
</span><span id="Problem.plot_results-841"><a href="#Problem.plot_results-841"><span class="linenos">841</span></a>                <span class="n">saved_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">saved_data_0</span><span class="p">,</span>
</span><span id="Problem.plot_results-842"><a href="#Problem.plot_results-842"><span class="linenos">842</span></a>                <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="Problem.plot_results-843"><a href="#Problem.plot_results-843"><span class="linenos">843</span></a>                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="Problem.plot_results-844"><a href="#Problem.plot_results-844"><span class="linenos">844</span></a>            <span class="p">)</span>
</span><span id="Problem.plot_results-845"><a href="#Problem.plot_results-845"><span class="linenos">845</span></a>            <span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span>
</span><span id="Problem.plot_results-846"><a href="#Problem.plot_results-846"><span class="linenos">846</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Problem.plot_results-847"><a href="#Problem.plot_results-847"><span class="linenos">847</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Problem.plot_results-848"><a href="#Problem.plot_results-848"><span class="linenos">848</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assume last iteration state.&quot;</span><span class="p">)</span>
</span><span id="Problem.plot_results-849"><a href="#Problem.plot_results-849"><span class="linenos">849</span></a>            <span class="n">d</span> <span class="o">=</span> <span class="n">compute_distance_field</span><span class="p">(</span>
</span><span id="Problem.plot_results-850"><a href="#Problem.plot_results-850"><span class="linenos">850</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">,</span>
</span><span id="Problem.plot_results-851"><a href="#Problem.plot_results-851"><span class="linenos">851</span></a>                <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="Problem.plot_results-852"><a href="#Problem.plot_results-852"><span class="linenos">852</span></a>                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="Problem.plot_results-853"><a href="#Problem.plot_results-853"><span class="linenos">853</span></a>            <span class="p">)</span>
</span><span id="Problem.plot_results-854"><a href="#Problem.plot_results-854"><span class="linenos">854</span></a>            <span class="n">mesh</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
</span><span id="Problem.plot_results-855"><a href="#Problem.plot_results-855"><span class="linenos">855</span></a>            <span class="n">mesh</span><span class="o">.</span><span class="n">unique_ctrl_pts</span><span class="o">.</span><span class="n">flat</span> <span class="o">+=</span> <span class="n">u_field</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="Problem.plot_results-856"><a href="#Problem.plot_results-856"><span class="linenos">856</span></a>
</span><span id="Problem.plot_results-857"><a href="#Problem.plot_results-857"><span class="linenos">857</span></a>        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s2">&quot;RdBu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resampled</span><span class="p">(</span><span class="n">n_colors</span><span class="p">)</span>
</span><span id="Problem.plot_results-858"><a href="#Problem.plot_results-858"><span class="linenos">858</span></a>        <span class="n">pv_add_mesh_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;cmap&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="p">)</span>
</span><span id="Problem.plot_results-859"><a href="#Problem.plot_results-859"><span class="linenos">859</span></a>        <span class="k">if</span> <span class="s2">&quot;clim&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pv_add_mesh_kwargs</span><span class="p">:</span>
</span><span id="Problem.plot_results-860"><a href="#Problem.plot_results-860"><span class="linenos">860</span></a>            <span class="n">lim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="mf">1e-3</span>
</span><span id="Problem.plot_results-861"><a href="#Problem.plot_results-861"><span class="linenos">861</span></a>            <span class="n">pv_add_mesh_kwargs</span><span class="p">[</span><span class="s2">&quot;clim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">lim</span><span class="p">,</span> <span class="n">lim</span><span class="p">]</span>
</span><span id="Problem.plot_results-862"><a href="#Problem.plot_results-862"><span class="linenos">862</span></a>        <span class="n">sargs</span> <span class="o">=</span> <span class="n">pv_add_mesh_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scalar_bar_args&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Problem.plot_results-863"><a href="#Problem.plot_results-863"><span class="linenos">863</span></a>        <span class="n">defaults_sargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="Problem.plot_results-864"><a href="#Problem.plot_results-864"><span class="linenos">864</span></a>            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Signed distance to the image features [px]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Problem.plot_results-865"><a href="#Problem.plot_results-865"><span class="linenos">865</span></a>            <span class="n">vertical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Problem.plot_results-866"><a href="#Problem.plot_results-866"><span class="linenos">866</span></a>            <span class="n">position_x</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="Problem.plot_results-867"><a href="#Problem.plot_results-867"><span class="linenos">867</span></a>            <span class="n">position_y</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
</span><span id="Problem.plot_results-868"><a href="#Problem.plot_results-868"><span class="linenos">868</span></a>            <span class="n">height</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="Problem.plot_results-869"><a href="#Problem.plot_results-869"><span class="linenos">869</span></a>            <span class="n">width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span><span id="Problem.plot_results-870"><a href="#Problem.plot_results-870"><span class="linenos">870</span></a>            <span class="n">n_colors</span><span class="o">=</span><span class="n">n_colors</span><span class="p">,</span>
</span><span id="Problem.plot_results-871"><a href="#Problem.plot_results-871"><span class="linenos">871</span></a>            <span class="n">title_font_size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
</span><span id="Problem.plot_results-872"><a href="#Problem.plot_results-872"><span class="linenos">872</span></a>            <span class="n">label_font_size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
</span><span id="Problem.plot_results-873"><a href="#Problem.plot_results-873"><span class="linenos">873</span></a>        <span class="p">)</span>
</span><span id="Problem.plot_results-874"><a href="#Problem.plot_results-874"><span class="linenos">874</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults_sargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Problem.plot_results-875"><a href="#Problem.plot_results-875"><span class="linenos">875</span></a>            <span class="n">sargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="Problem.plot_results-876"><a href="#Problem.plot_results-876"><span class="linenos">876</span></a>        <span class="n">pv_add_mesh_kwargs</span><span class="p">[</span><span class="s2">&quot;scalar_bar_args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sargs</span>
</span><span id="Problem.plot_results-877"><a href="#Problem.plot_results-877"><span class="linenos">877</span></a>
</span><span id="Problem.plot_results-878"><a href="#Problem.plot_results-878"><span class="linenos">878</span></a>        <span class="n">XI_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">e</span><span class="o">.</span><span class="n">xi</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">eta</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_energies</span><span class="p">]</span>
</span><span id="Problem.plot_results-879"><a href="#Problem.plot_results-879"><span class="linenos">879</span></a>        <span class="k">return</span> <span class="n">mesh</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="Problem.plot_results-880"><a href="#Problem.plot_results-880"><span class="linenos">880</span></a>            <span class="n">XI_list</span><span class="o">=</span><span class="n">XI_list</span><span class="p">,</span>
</span><span id="Problem.plot_results-881"><a href="#Problem.plot_results-881"><span class="linenos">881</span></a>            <span class="n">separated_field</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
</span><span id="Problem.plot_results-882"><a href="#Problem.plot_results-882"><span class="linenos">882</span></a>            <span class="n">interior_only</span><span class="o">=</span><span class="n">interior_only</span><span class="p">,</span>
</span><span id="Problem.plot_results-883"><a href="#Problem.plot_results-883"><span class="linenos">883</span></a>            <span class="n">plt_ctrl_mesh</span><span class="o">=</span><span class="n">plt_ctrl_mesh</span><span class="p">,</span>
</span><span id="Problem.plot_results-884"><a href="#Problem.plot_results-884"><span class="linenos">884</span></a>            <span class="n">pv_plotter</span><span class="o">=</span><span class="n">pv_plotter</span><span class="p">,</span>
</span><span id="Problem.plot_results-885"><a href="#Problem.plot_results-885"><span class="linenos">885</span></a>            <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span>
</span><span id="Problem.plot_results-886"><a href="#Problem.plot_results-886"><span class="linenos">886</span></a>            <span class="n">elem_sep_color</span><span class="o">=</span><span class="n">elem_sep_color</span><span class="p">,</span>
</span><span id="Problem.plot_results-887"><a href="#Problem.plot_results-887"><span class="linenos">887</span></a>            <span class="n">ctrl_poly_color</span><span class="o">=</span><span class="n">ctrl_poly_color</span><span class="p">,</span>
</span><span id="Problem.plot_results-888"><a href="#Problem.plot_results-888"><span class="linenos">888</span></a>            <span class="o">**</span><span class="n">pv_add_mesh_kwargs</span><span class="p">,</span>
</span><span id="Problem.plot_results-889"><a href="#Problem.plot_results-889"><span class="linenos">889</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Visualize VIC results with PyVista, optionally applying a displacement field.</p>

<p>This method plots the signed distance fields of the mesh with respect to
the image features. If a displacement field <code>u_field</code> is provided, it
is applied to a copy of the mesh for visualization; otherwise, the
distances from the first iteration are displayed. It is recommended
to pass the displacement field obtained from <code><a href="#Problem.solve">solve</a></code> to make sure to match
the distance map to the correct displacement field.</p>

<p>The visualization can be customized, including the number of colors,
control mesh display, scalar bar, and interior-only rendering. Any
additional keyword arguments are passed to <code>Mesh.plot()</code>, which
ultimately forwards them to <code>pv.Plotter.add_mesh()</code>.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>u_field</strong> (np.ndarray or None, optional):
Displacement field to apply to the mesh for visualization. If <code>None</code>
(default), the distances from the first iteration (<code>self.saved_data_0</code>)
are displayed. If provided, the mesh is warped according to this
displacement. To correctly display the most recent VIC results,
pass the <code>u_field</code> output from the <code><a href="#Problem.solve">solve</a></code> method, as the distance
map displayed corresponds to the last iteration computed by the
image energy terms.</li>
<li><strong>disable_parallel</strong> (bool, optional):
If <code>True</code>, disables parallel computation of distance fields.
Default is <code>False</code>.</li>
<li><strong>verbose</strong> (bool, optional):
If <code>True</code>, prints diagnostic messages. Default is <code>True</code>.</li>
<li><strong>n_colors</strong> (int, optional):
Number of discrete colors in the colormap. Default is <code>15</code>.</li>
<li><strong>interior_only</strong> (bool, optional):
If <code>True</code>, only interior elements of the mesh are plotted.
Default is <code>True</code>.</li>
<li><strong>plt_ctrl_mesh</strong> (bool, optional):
If <code>True</code>, overlays the control mesh on the plot.
Default is <code>False</code>.</li>
<li><strong>pv_plotter</strong> (pv.Plotter or None, optional):
PyVista plotter object to use. If <code>None</code>, a new plotter is created.</li>
<li><strong>show</strong> (bool, optional):
If <code>True</code>, displays the plot immediately. Default is <code>True</code>.</li>
<li><strong>elem_sep_color</strong> (str, optional):
Color used for separating elements. Only applied if <code>interior_only</code>
is <code>False</code>. Default is <code>'black'</code>.</li>
<li><strong>ctrl_poly_color</strong> (str, optional):
Color of the control mesh. Only applied if <code>plt_ctrl_mesh</code> is <code>True</code>
and <code>interior_only</code> is <code>False</code>. Default is <code>'green'</code>.</li>
<li><strong>**pv_add_mesh_kwargs</strong> (dict, optional):
Additional keyword arguments passed to <code>Mesh.plot()</code>, such as
<code>cmap</code>, <code>clim</code>, <code>scalar_bar_args</code>, etc.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>pv.Plotter or None</strong>: The PyVista plotter object used for the visualization.</li>
</ul>

<h6 id="notes">Notes</h6>

<ul>
<li>The signed distance field <code>d</code> is computed from the image energies via
<code>volVIC.VirtualImageCorrelationEnergyElem.compute_distance_field()</code>.</li>
<li>The default colormap is a resampled <code>"RdBu"</code> with <code>n_colors</code>.</li>
<li>Scalar bar properties are automatically set but can be overridden via
<code>pv_add_mesh_kwargs["scalar_bar_args"]</code>.</li>
<li>To make sure the deformation matches the distance field, always pass the
displacement field returned by <code><a href="#Problem.solve">solve()</a></code>.</li>
</ul>
</div>


                            </div>
                            <div id="Problem.propagate_displacement_to_volume_mesh" class="classattr">
                                        <input id="Problem.propagate_displacement_to_volume_mesh-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">propagate_displacement_to_volume_mesh</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">u_field</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">]</span>,</span><span class="param">	<span class="n">volume_mesh</span><span class="p">:</span> <span class="n"><a href="Mesh.html#Mesh">volVIC.Mesh.Mesh</a></span>,</span><span class="param">	<span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Problem.propagate_displacement_to_volume_mesh-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Problem.propagate_displacement_to_volume_mesh"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Problem.propagate_displacement_to_volume_mesh-891"><a href="#Problem.propagate_displacement_to_volume_mesh-891"><span class="linenos">891</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">propagate_displacement_to_volume_mesh</span><span class="p">(</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-892"><a href="#Problem.propagate_displacement_to_volume_mesh-892"><span class="linenos">892</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-893"><a href="#Problem.propagate_displacement_to_volume_mesh-893"><span class="linenos">893</span></a>        <span class="n">u_field</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-894"><a href="#Problem.propagate_displacement_to_volume_mesh-894"><span class="linenos">894</span></a>        <span class="n">volume_mesh</span><span class="p">:</span> <span class="n">Mesh</span><span class="p">,</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-895"><a href="#Problem.propagate_displacement_to_volume_mesh-895"><span class="linenos">895</span></a>        <span class="n">disable_parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-896"><a href="#Problem.propagate_displacement_to_volume_mesh-896"><span class="linenos">896</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]:</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-897"><a href="#Problem.propagate_displacement_to_volume_mesh-897"><span class="linenos">897</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-898"><a href="#Problem.propagate_displacement_to_volume_mesh-898"><span class="linenos">898</span></a><span class="sd">        Propagate the surface displacement field to a volumetric mesh.</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-899"><a href="#Problem.propagate_displacement_to_volume_mesh-899"><span class="linenos">899</span></a>
</span><span id="Problem.propagate_displacement_to_volume_mesh-900"><a href="#Problem.propagate_displacement_to_volume_mesh-900"><span class="linenos">900</span></a><span class="sd">        This method maps the displacement field computed on the surface mesh</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-901"><a href="#Problem.propagate_displacement_to_volume_mesh-901"><span class="linenos">901</span></a><span class="sd">        (`self.mesh`) to a target volume mesh (`volume_mesh`). The mapping uses</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-902"><a href="#Problem.propagate_displacement_to_volume_mesh-902"><span class="linenos">902</span></a><span class="sd">        the surface-to-volume interpolation implemented in</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-903"><a href="#Problem.propagate_displacement_to_volume_mesh-903"><span class="linenos">903</span></a><span class="sd">        :meth:`Mesh.propagate_field_from_submesh`. The resulting volumetric</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-904"><a href="#Problem.propagate_displacement_to_volume_mesh-904"><span class="linenos">904</span></a><span class="sd">        displacement field is returned in the same coordinate system as the</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-905"><a href="#Problem.propagate_displacement_to_volume_mesh-905"><span class="linenos">905</span></a><span class="sd">        original surface mesh (before ICP).</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-906"><a href="#Problem.propagate_displacement_to_volume_mesh-906"><span class="linenos">906</span></a>
</span><span id="Problem.propagate_displacement_to_volume_mesh-907"><a href="#Problem.propagate_displacement_to_volume_mesh-907"><span class="linenos">907</span></a><span class="sd">        Parameters</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-908"><a href="#Problem.propagate_displacement_to_volume_mesh-908"><span class="linenos">908</span></a><span class="sd">        ----------</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-909"><a href="#Problem.propagate_displacement_to_volume_mesh-909"><span class="linenos">909</span></a><span class="sd">        u_field : np.ndarray[np.floating]</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-910"><a href="#Problem.propagate_displacement_to_volume_mesh-910"><span class="linenos">910</span></a><span class="sd">            Surface displacement field to propagate. Typically, this is the</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-911"><a href="#Problem.propagate_displacement_to_volume_mesh-911"><span class="linenos">911</span></a><span class="sd">            `u_field` obtained from the :meth:`solve` method.</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-912"><a href="#Problem.propagate_displacement_to_volume_mesh-912"><span class="linenos">912</span></a>
</span><span id="Problem.propagate_displacement_to_volume_mesh-913"><a href="#Problem.propagate_displacement_to_volume_mesh-913"><span class="linenos">913</span></a><span class="sd">        volume_mesh : Mesh</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-914"><a href="#Problem.propagate_displacement_to_volume_mesh-914"><span class="linenos">914</span></a><span class="sd">            Target volumetric mesh on which to propagate the displacement.</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-915"><a href="#Problem.propagate_displacement_to_volume_mesh-915"><span class="linenos">915</span></a>
</span><span id="Problem.propagate_displacement_to_volume_mesh-916"><a href="#Problem.propagate_displacement_to_volume_mesh-916"><span class="linenos">916</span></a><span class="sd">        disable_parallel : bool, optional</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-917"><a href="#Problem.propagate_displacement_to_volume_mesh-917"><span class="linenos">917</span></a><span class="sd">            If `True`, disables parallel computation. Default is `False`.</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-918"><a href="#Problem.propagate_displacement_to_volume_mesh-918"><span class="linenos">918</span></a>
</span><span id="Problem.propagate_displacement_to_volume_mesh-919"><a href="#Problem.propagate_displacement_to_volume_mesh-919"><span class="linenos">919</span></a><span class="sd">        Returns</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-920"><a href="#Problem.propagate_displacement_to_volume_mesh-920"><span class="linenos">920</span></a><span class="sd">        -------</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-921"><a href="#Problem.propagate_displacement_to_volume_mesh-921"><span class="linenos">921</span></a><span class="sd">        np.ndarray[np.floating]</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-922"><a href="#Problem.propagate_displacement_to_volume_mesh-922"><span class="linenos">922</span></a><span class="sd">            Displacement field defined on the volume mesh, in the same</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-923"><a href="#Problem.propagate_displacement_to_volume_mesh-923"><span class="linenos">923</span></a><span class="sd">            coordinate system as the input surface displacement.</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-924"><a href="#Problem.propagate_displacement_to_volume_mesh-924"><span class="linenos">924</span></a>
</span><span id="Problem.propagate_displacement_to_volume_mesh-925"><a href="#Problem.propagate_displacement_to_volume_mesh-925"><span class="linenos">925</span></a><span class="sd">        Notes</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-926"><a href="#Problem.propagate_displacement_to_volume_mesh-926"><span class="linenos">926</span></a><span class="sd">        -----</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-927"><a href="#Problem.propagate_displacement_to_volume_mesh-927"><span class="linenos">927</span></a><span class="sd">        - The propagation is performed via</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-928"><a href="#Problem.propagate_displacement_to_volume_mesh-928"><span class="linenos">928</span></a><span class="sd">          :meth:`Mesh.propagate_field_from_submesh`, which interpolates the</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-929"><a href="#Problem.propagate_displacement_to_volume_mesh-929"><span class="linenos">929</span></a><span class="sd">          surface displacement onto the volume nodes.</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-930"><a href="#Problem.propagate_displacement_to_volume_mesh-930"><span class="linenos">930</span></a><span class="sd">        - The method internally applies and then removes the rigid-body</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-931"><a href="#Problem.propagate_displacement_to_volume_mesh-931"><span class="linenos">931</span></a><span class="sd">          rotation `self.Rmat` used during VIC initialization to ensure</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-932"><a href="#Problem.propagate_displacement_to_volume_mesh-932"><span class="linenos">932</span></a><span class="sd">          consistency between surface and volume coordinate frames.</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-933"><a href="#Problem.propagate_displacement_to_volume_mesh-933"><span class="linenos">933</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-934"><a href="#Problem.propagate_displacement_to_volume_mesh-934"><span class="linenos">934</span></a>
</span><span id="Problem.propagate_displacement_to_volume_mesh-935"><a href="#Problem.propagate_displacement_to_volume_mesh-935"><span class="linenos">935</span></a>        <span class="n">u_vol_field</span> <span class="o">=</span> <span class="n">volume_mesh</span><span class="o">.</span><span class="n">propagate_field_from_submesh</span><span class="p">(</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-936"><a href="#Problem.propagate_displacement_to_volume_mesh-936"><span class="linenos">936</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-937"><a href="#Problem.propagate_displacement_to_volume_mesh-937"><span class="linenos">937</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Rmat</span> <span class="o">@</span> <span class="n">u_field</span><span class="p">,</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-938"><a href="#Problem.propagate_displacement_to_volume_mesh-938"><span class="linenos">938</span></a>            <span class="n">disable_parallel</span><span class="o">=</span><span class="n">disable_parallel</span><span class="p">,</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-939"><a href="#Problem.propagate_displacement_to_volume_mesh-939"><span class="linenos">939</span></a>        <span class="p">)</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-940"><a href="#Problem.propagate_displacement_to_volume_mesh-940"><span class="linenos">940</span></a>        <span class="n">u_vol_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rmat</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">u_vol_field</span>
</span><span id="Problem.propagate_displacement_to_volume_mesh-941"><a href="#Problem.propagate_displacement_to_volume_mesh-941"><span class="linenos">941</span></a>        <span class="k">return</span> <span class="n">u_vol_field</span>
</span></pre></div>


            <div class="docstring"><p>Propagate the surface displacement field to a volumetric mesh.</p>

<p>This method maps the displacement field computed on the surface mesh
(<code>self.mesh</code>) to a target volume mesh (<code>volume_mesh</code>). The mapping uses
the surface-to-volume interpolation implemented in
<code>Mesh.propagate_field_from_submesh()</code>. The resulting volumetric
displacement field is returned in the same coordinate system as the
original surface mesh (before ICP).</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>u_field</strong> (np.ndarray[np.floating]):
Surface displacement field to propagate. Typically, this is the
<code>u_field</code> obtained from the <code><a href="#Problem.solve">solve()</a></code> method.</li>
<li><strong>volume_mesh</strong> (Mesh):
Target volumetric mesh on which to propagate the displacement.</li>
<li><strong>disable_parallel</strong> (bool, optional):
If <code>True</code>, disables parallel computation. Default is <code>False</code>.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>np.ndarray[np.floating]</strong>: Displacement field defined on the volume mesh, in the same
coordinate system as the input surface displacement.</li>
</ul>

<h6 id="notes">Notes</h6>

<ul>
<li>The propagation is performed via
<code>Mesh.propagate_field_from_submesh()</code>, which interpolates the
surface displacement onto the volume nodes.</li>
<li>The method internally applies and then removes the rigid-body
rotation <code>self.Rmat</code> used during VIC initialization to ensure
consistency between surface and volume coordinate frames.</li>
</ul>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>