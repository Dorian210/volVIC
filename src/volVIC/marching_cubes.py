# %%
import numpy as np
import numba as nb
import meshio as io

# tri_table : np.ndarray of shape (256, 15), dtype=np.uint8
tri_table = np.array(
    [[32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 0,  8,  3, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 0,  1,  9, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 1,  8,  3,  9,  8,  1, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 1,  2, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 0,  8,  3,  1,  2, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 9,  2, 10,  0,  2,  9, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 2,  8,  3,  2, 10,  8, 10,  9,  8, 32, 32, 32, 32, 32, 32],
     [ 3, 11,  2, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 0, 11,  2,  8, 11,  0, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 1,  9,  0,  2,  3, 11, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 1, 11,  2,  1,  9, 11,  9,  8, 11, 32, 32, 32, 32, 32, 32],
     [ 3, 10,  1, 11, 10,  3, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 0, 10,  1,  0,  8, 10,  8, 11, 10, 32, 32, 32, 32, 32, 32],
     [ 3,  9,  0,  3, 11,  9, 11, 10,  9, 32, 32, 32, 32, 32, 32],
     [ 9,  8, 10, 10,  8, 11, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 4,  7,  8, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 4,  3,  0,  7,  3,  4, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 0,  1,  9,  8,  4,  7, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 4,  1,  9,  4,  7,  1,  7,  3,  1, 32, 32, 32, 32, 32, 32],
     [ 1,  2, 10,  8,  4,  7, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 3,  4,  7,  3,  0,  4,  1,  2, 10, 32, 32, 32, 32, 32, 32],
     [ 9,  2, 10,  9,  0,  2,  8,  4,  7, 32, 32, 32, 32, 32, 32],
     [ 2, 10,  9,  2,  9,  7,  2,  7,  3,  7,  9,  4, 32, 32, 32],
     [ 8,  4,  7,  3, 11,  2, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [11,  4,  7, 11,  2,  4,  2,  0,  4, 32, 32, 32, 32, 32, 32],
     [ 9,  0,  1,  8,  4,  7,  2,  3, 11, 32, 32, 32, 32, 32, 32],
     [ 4,  7, 11,  9,  4, 11,  9, 11,  2,  9,  2,  1, 32, 32, 32],
     [ 3, 10,  1,  3, 11, 10,  7,  8,  4, 32, 32, 32, 32, 32, 32],
     [ 1, 11, 10,  1,  4, 11,  1,  0,  4,  7, 11,  4, 32, 32, 32],
     [ 4,  7,  8,  9,  0, 11,  9, 11, 10, 11,  0,  3, 32, 32, 32],
     [ 4,  7, 11,  4, 11,  9,  9, 11, 10, 32, 32, 32, 32, 32, 32],
     [ 9,  5,  4, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 9,  5,  4,  0,  8,  3, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 0,  5,  4,  1,  5,  0, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 8,  5,  4,  8,  3,  5,  3,  1,  5, 32, 32, 32, 32, 32, 32],
     [ 1,  2, 10,  9,  5,  4, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 3,  0,  8,  1,  2, 10,  4,  9,  5, 32, 32, 32, 32, 32, 32],
     [ 5,  2, 10,  5,  4,  2,  4,  0,  2, 32, 32, 32, 32, 32, 32],
     [ 2, 10,  5,  3,  2,  5,  3,  5,  4,  3,  4,  8, 32, 32, 32],
     [ 9,  5,  4,  2,  3, 11, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 0, 11,  2,  0,  8, 11,  4,  9,  5, 32, 32, 32, 32, 32, 32],
     [ 0,  5,  4,  0,  1,  5,  2,  3, 11, 32, 32, 32, 32, 32, 32],
     [ 2,  1,  5,  2,  5,  8,  2,  8, 11,  4,  8,  5, 32, 32, 32],
     [10,  3, 11, 10,  1,  3,  9,  5,  4, 32, 32, 32, 32, 32, 32],
     [ 4,  9,  5,  0,  8,  1,  8, 10,  1,  8, 11, 10, 32, 32, 32],
     [ 5,  4,  0,  5,  0, 11,  5, 11, 10, 11,  0,  3, 32, 32, 32],
     [ 5,  4,  8,  5,  8, 10, 10,  8, 11, 32, 32, 32, 32, 32, 32],
     [ 9,  7,  8,  5,  7,  9, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 9,  3,  0,  9,  5,  3,  5,  7,  3, 32, 32, 32, 32, 32, 32],
     [ 0,  7,  8,  0,  1,  7,  1,  5,  7, 32, 32, 32, 32, 32, 32],
     [ 1,  5,  3,  3,  5,  7, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 9,  7,  8,  9,  5,  7, 10,  1,  2, 32, 32, 32, 32, 32, 32],
     [10,  1,  2,  9,  5,  0,  5,  3,  0,  5,  7,  3, 32, 32, 32],
     [ 8,  0,  2,  8,  2,  5,  8,  5,  7, 10,  5,  2, 32, 32, 32],
     [ 2, 10,  5,  2,  5,  3,  3,  5,  7, 32, 32, 32, 32, 32, 32],
     [ 7,  9,  5,  7,  8,  9,  3, 11,  2, 32, 32, 32, 32, 32, 32],
     [ 9,  5,  7,  9,  7,  2,  9,  2,  0,  2,  7, 11, 32, 32, 32],
     [ 2,  3, 11,  0,  1,  8,  1,  7,  8,  1,  5,  7, 32, 32, 32],
     [11,  2,  1, 11,  1,  7,  7,  1,  5, 32, 32, 32, 32, 32, 32],
     [ 9,  5,  8,  8,  5,  7, 10,  1,  3, 10,  3, 11, 32, 32, 32],
     [ 5,  7,  0,  5,  0,  9,  7, 11,  0,  1,  0, 10, 11, 10,  0],
     [11, 10,  0, 11,  0,  3, 10,  5,  0,  8,  0,  7,  5,  7,  0],
     [11, 10,  5,  7, 11,  5, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [10,  6,  5, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 0,  8,  3,  5, 10,  6, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 9,  0,  1,  5, 10,  6, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 1,  8,  3,  1,  9,  8,  5, 10,  6, 32, 32, 32, 32, 32, 32],
     [ 1,  6,  5,  2,  6,  1, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 1,  6,  5,  1,  2,  6,  3,  0,  8, 32, 32, 32, 32, 32, 32],
     [ 9,  6,  5,  9,  0,  6,  0,  2,  6, 32, 32, 32, 32, 32, 32],
     [ 5,  9,  8,  5,  8,  2,  5,  2,  6,  3,  2,  8, 32, 32, 32],
     [ 2,  3, 11, 10,  6,  5, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [11,  0,  8, 11,  2,  0, 10,  6,  5, 32, 32, 32, 32, 32, 32],
     [ 0,  1,  9,  2,  3, 11,  5, 10,  6, 32, 32, 32, 32, 32, 32],
     [ 5, 10,  6,  1,  9,  2,  9, 11,  2,  9,  8, 11, 32, 32, 32],
     [ 6,  3, 11,  6,  5,  3,  5,  1,  3, 32, 32, 32, 32, 32, 32],
     [ 0,  8, 11,  0, 11,  5,  0,  5,  1,  5, 11,  6, 32, 32, 32],
     [ 3, 11,  6,  0,  3,  6,  0,  6,  5,  0,  5,  9, 32, 32, 32],
     [ 6,  5,  9,  6,  9, 11, 11,  9,  8, 32, 32, 32, 32, 32, 32],
     [ 5, 10,  6,  4,  7,  8, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 4,  3,  0,  4,  7,  3,  6,  5, 10, 32, 32, 32, 32, 32, 32],
     [ 1,  9,  0,  5, 10,  6,  8,  4,  7, 32, 32, 32, 32, 32, 32],
     [10,  6,  5,  1,  9,  7,  1,  7,  3,  7,  9,  4, 32, 32, 32],
     [ 6,  1,  2,  6,  5,  1,  4,  7,  8, 32, 32, 32, 32, 32, 32],
     [ 1,  2,  5,  5,  2,  6,  3,  0,  4,  3,  4,  7, 32, 32, 32],
     [ 8,  4,  7,  9,  0,  5,  0,  6,  5,  0,  2,  6, 32, 32, 32],
     [ 7,  3,  9,  7,  9,  4,  3,  2,  9,  5,  9,  6,  2,  6,  9],
     [ 3, 11,  2,  7,  8,  4, 10,  6,  5, 32, 32, 32, 32, 32, 32],
     [ 5, 10,  6,  4,  7,  2,  4,  2,  0,  2,  7, 11, 32, 32, 32],
     [ 0,  1,  9,  4,  7,  8,  2,  3, 11,  5, 10,  6, 32, 32, 32],
     [ 9,  2,  1,  9, 11,  2,  9,  4, 11,  7, 11,  4,  5, 10,  6],
     [ 8,  4,  7,  3, 11,  5,  3,  5,  1,  5, 11,  6, 32, 32, 32],
     [ 5,  1, 11,  5, 11,  6,  1,  0, 11,  7, 11,  4,  0,  4, 11],
     [ 0,  5,  9,  0,  6,  5,  0,  3,  6, 11,  6,  3,  8,  4,  7],
     [ 6,  5,  9,  6,  9, 11,  4,  7,  9,  7, 11,  9, 32, 32, 32],
     [10,  4,  9,  6,  4, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 4, 10,  6,  4,  9, 10,  0,  8,  3, 32, 32, 32, 32, 32, 32],
     [10,  0,  1, 10,  6,  0,  6,  4,  0, 32, 32, 32, 32, 32, 32],
     [ 8,  3,  1,  8,  1,  6,  8,  6,  4,  6,  1, 10, 32, 32, 32],
     [ 1,  4,  9,  1,  2,  4,  2,  6,  4, 32, 32, 32, 32, 32, 32],
     [ 3,  0,  8,  1,  2,  9,  2,  4,  9,  2,  6,  4, 32, 32, 32],
     [ 0,  2,  4,  4,  2,  6, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 8,  3,  2,  8,  2,  4,  4,  2,  6, 32, 32, 32, 32, 32, 32],
     [10,  4,  9, 10,  6,  4, 11,  2,  3, 32, 32, 32, 32, 32, 32],
     [ 0,  8,  2,  2,  8, 11,  4,  9, 10,  4, 10,  6, 32, 32, 32],
     [ 3, 11,  2,  0,  1,  6,  0,  6,  4,  6,  1, 10, 32, 32, 32],
     [ 6,  4,  1,  6,  1, 10,  4,  8,  1,  2,  1, 11,  8, 11,  1],
     [ 9,  6,  4,  9,  3,  6,  9,  1,  3, 11,  6,  3, 32, 32, 32],
     [ 8, 11,  1,  8,  1,  0, 11,  6,  1,  9,  1,  4,  6,  4,  1],
     [ 3, 11,  6,  3,  6,  0,  0,  6,  4, 32, 32, 32, 32, 32, 32],
     [ 6,  4,  8, 11,  6,  8, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 7, 10,  6,  7,  8, 10,  8,  9, 10, 32, 32, 32, 32, 32, 32],
     [ 0,  7,  3,  0, 10,  7,  0,  9, 10,  6,  7, 10, 32, 32, 32],
     [10,  6,  7,  1, 10,  7,  1,  7,  8,  1,  8,  0, 32, 32, 32],
     [10,  6,  7, 10,  7,  1,  1,  7,  3, 32, 32, 32, 32, 32, 32],
     [ 1,  2,  6,  1,  6,  8,  1,  8,  9,  8,  6,  7, 32, 32, 32],
     [ 2,  6,  9,  2,  9,  1,  6,  7,  9,  0,  9,  3,  7,  3,  9],
     [ 7,  8,  0,  7,  0,  6,  6,  0,  2, 32, 32, 32, 32, 32, 32],
     [ 7,  3,  2,  6,  7,  2, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 2,  3, 11, 10,  6,  8, 10,  8,  9,  8,  6,  7, 32, 32, 32],
     [ 2,  0,  7,  2,  7, 11,  0,  9,  7,  6,  7, 10,  9, 10,  7],
     [ 1,  8,  0,  1,  7,  8,  1, 10,  7,  6,  7, 10,  2,  3, 11],
     [11,  2,  1, 11,  1,  7, 10,  6,  1,  6,  7,  1, 32, 32, 32],
     [ 8,  9,  6,  8,  6,  7,  9,  1,  6, 11,  6,  3,  1,  3,  6],
     [ 0,  9,  1, 11,  6,  7, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 7,  8,  0,  7,  0,  6,  3, 11,  0, 11,  6,  0, 32, 32, 32],
     [ 7, 11,  6, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 7,  6, 11, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 3,  0,  8, 11,  7,  6, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 0,  1,  9, 11,  7,  6, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 8,  1,  9,  8,  3,  1, 11,  7,  6, 32, 32, 32, 32, 32, 32],
     [10,  1,  2,  6, 11,  7, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 1,  2, 10,  3,  0,  8,  6, 11,  7, 32, 32, 32, 32, 32, 32],
     [ 2,  9,  0,  2, 10,  9,  6, 11,  7, 32, 32, 32, 32, 32, 32],
     [ 6, 11,  7,  2, 10,  3, 10,  8,  3, 10,  9,  8, 32, 32, 32],
     [ 7,  2,  3,  6,  2,  7, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 7,  0,  8,  7,  6,  0,  6,  2,  0, 32, 32, 32, 32, 32, 32],
     [ 2,  7,  6,  2,  3,  7,  0,  1,  9, 32, 32, 32, 32, 32, 32],
     [ 1,  6,  2,  1,  8,  6,  1,  9,  8,  8,  7,  6, 32, 32, 32],
     [10,  7,  6, 10,  1,  7,  1,  3,  7, 32, 32, 32, 32, 32, 32],
     [10,  7,  6,  1,  7, 10,  1,  8,  7,  1,  0,  8, 32, 32, 32],
     [ 0,  3,  7,  0,  7, 10,  0, 10,  9,  6, 10,  7, 32, 32, 32],
     [ 7,  6, 10,  7, 10,  8,  8, 10,  9, 32, 32, 32, 32, 32, 32],
     [ 6,  8,  4, 11,  8,  6, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 3,  6, 11,  3,  0,  6,  0,  4,  6, 32, 32, 32, 32, 32, 32],
     [ 8,  6, 11,  8,  4,  6,  9,  0,  1, 32, 32, 32, 32, 32, 32],
     [ 9,  4,  6,  9,  6,  3,  9,  3,  1, 11,  3,  6, 32, 32, 32],
     [ 6,  8,  4,  6, 11,  8,  2, 10,  1, 32, 32, 32, 32, 32, 32],
     [ 1,  2, 10,  3,  0, 11,  0,  6, 11,  0,  4,  6, 32, 32, 32],
     [ 4, 11,  8,  4,  6, 11,  0,  2,  9,  2, 10,  9, 32, 32, 32],
     [10,  9,  3, 10,  3,  2,  9,  4,  3, 11,  3,  6,  4,  6,  3],
     [ 8,  2,  3,  8,  4,  2,  4,  6,  2, 32, 32, 32, 32, 32, 32],
     [ 0,  4,  2,  4,  6,  2, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 1,  9,  0,  2,  3,  4,  2,  4,  6,  4,  3,  8, 32, 32, 32],
     [ 1,  9,  4,  1,  4,  2,  2,  4,  6, 32, 32, 32, 32, 32, 32],
     [ 8,  1,  3,  8,  6,  1,  8,  4,  6,  6, 10,  1, 32, 32, 32],
     [10,  1,  0, 10,  0,  6,  6,  0,  4, 32, 32, 32, 32, 32, 32],
     [ 4,  6,  3,  4,  3,  8,  6, 10,  3,  0,  3,  9, 10,  9,  3],
     [10,  9,  4,  6, 10,  4, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 4,  9,  5,  7,  6, 11, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 0,  8,  3,  4,  9,  5, 11,  7,  6, 32, 32, 32, 32, 32, 32],
     [ 5,  0,  1,  5,  4,  0,  7,  6, 11, 32, 32, 32, 32, 32, 32],
     [11,  7,  6,  8,  3,  4,  3,  5,  4,  3,  1,  5, 32, 32, 32],
     [ 9,  5,  4, 10,  1,  2,  7,  6, 11, 32, 32, 32, 32, 32, 32],
     [ 6, 11,  7,  1,  2, 10,  0,  8,  3,  4,  9,  5, 32, 32, 32],
     [ 7,  6, 11,  5,  4, 10,  4,  2, 10,  4,  0,  2, 32, 32, 32],
     [ 3,  4,  8,  3,  5,  4,  3,  2,  5, 10,  5,  2, 11,  7,  6],
     [ 7,  2,  3,  7,  6,  2,  5,  4,  9, 32, 32, 32, 32, 32, 32],
     [ 9,  5,  4,  0,  8,  6,  0,  6,  2,  6,  8,  7, 32, 32, 32],
     [ 3,  6,  2,  3,  7,  6,  1,  5,  0,  5,  4,  0, 32, 32, 32],
     [ 6,  2,  8,  6,  8,  7,  2,  1,  8,  4,  8,  5,  1,  5,  8],
     [ 9,  5,  4, 10,  1,  6,  1,  7,  6,  1,  3,  7, 32, 32, 32],
     [ 1,  6, 10,  1,  7,  6,  1,  0,  7,  8,  7,  0,  9,  5,  4],
     [ 4,  0, 10,  4, 10,  5,  0,  3, 10,  6, 10,  7,  3,  7, 10],
     [ 7,  6, 10,  7, 10,  8,  5,  4, 10,  4,  8, 10, 32, 32, 32],
     [ 6,  9,  5,  6, 11,  9, 11,  8,  9, 32, 32, 32, 32, 32, 32],
     [ 3,  6, 11,  0,  6,  3,  0,  5,  6,  0,  9,  5, 32, 32, 32],
     [ 0, 11,  8,  0,  5, 11,  0,  1,  5,  5,  6, 11, 32, 32, 32],
     [ 6, 11,  3,  6,  3,  5,  5,  3,  1, 32, 32, 32, 32, 32, 32],
     [ 1,  2, 10,  9,  5, 11,  9, 11,  8, 11,  5,  6, 32, 32, 32],
     [ 0, 11,  3,  0,  6, 11,  0,  9,  6,  5,  6,  9,  1,  2, 10],
     [11,  8,  5, 11,  5,  6,  8,  0,  5, 10,  5,  2,  0,  2,  5],
     [ 6, 11,  3,  6,  3,  5,  2, 10,  3, 10,  5,  3, 32, 32, 32],
     [ 5,  8,  9,  5,  2,  8,  5,  6,  2,  3,  8,  2, 32, 32, 32],
     [ 9,  5,  6,  9,  6,  0,  0,  6,  2, 32, 32, 32, 32, 32, 32],
     [ 1,  5,  8,  1,  8,  0,  5,  6,  8,  3,  8,  2,  6,  2,  8],
     [ 1,  5,  6,  2,  1,  6, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 1,  3,  6,  1,  6, 10,  3,  8,  6,  5,  6,  9,  8,  9,  6],
     [10,  1,  0, 10,  0,  6,  9,  5,  0,  5,  6,  0, 32, 32, 32],
     [ 0,  3,  8,  5,  6, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [10,  5,  6, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [11,  5, 10,  7,  5, 11, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [11,  5, 10, 11,  7,  5,  8,  3,  0, 32, 32, 32, 32, 32, 32],
     [ 5, 11,  7,  5, 10, 11,  1,  9,  0, 32, 32, 32, 32, 32, 32],
     [10,  7,  5, 10, 11,  7,  9,  8,  1,  8,  3,  1, 32, 32, 32],
     [11,  1,  2, 11,  7,  1,  7,  5,  1, 32, 32, 32, 32, 32, 32],
     [ 0,  8,  3,  1,  2,  7,  1,  7,  5,  7,  2, 11, 32, 32, 32],
     [ 9,  7,  5,  9,  2,  7,  9,  0,  2,  2, 11,  7, 32, 32, 32],
     [ 7,  5,  2,  7,  2, 11,  5,  9,  2,  3,  2,  8,  9,  8,  2],
     [ 2,  5, 10,  2,  3,  5,  3,  7,  5, 32, 32, 32, 32, 32, 32],
     [ 8,  2,  0,  8,  5,  2,  8,  7,  5, 10,  2,  5, 32, 32, 32],
     [ 9,  0,  1,  5, 10,  3,  5,  3,  7,  3, 10,  2, 32, 32, 32],
     [ 9,  8,  2,  9,  2,  1,  8,  7,  2, 10,  2,  5,  7,  5,  2],
     [ 1,  3,  5,  3,  7,  5, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 0,  8,  7,  0,  7,  1,  1,  7,  5, 32, 32, 32, 32, 32, 32],
     [ 9,  0,  3,  9,  3,  5,  5,  3,  7, 32, 32, 32, 32, 32, 32],
     [ 9,  8,  7,  5,  9,  7, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 5,  8,  4,  5, 10,  8, 10, 11,  8, 32, 32, 32, 32, 32, 32],
     [ 5,  0,  4,  5, 11,  0,  5, 10, 11, 11,  3,  0, 32, 32, 32],
     [ 0,  1,  9,  8,  4, 10,  8, 10, 11, 10,  4,  5, 32, 32, 32],
     [10, 11,  4, 10,  4,  5, 11,  3,  4,  9,  4,  1,  3,  1,  4],
     [ 2,  5,  1,  2,  8,  5,  2, 11,  8,  4,  5,  8, 32, 32, 32],
     [ 0,  4, 11,  0, 11,  3,  4,  5, 11,  2, 11,  1,  5,  1, 11],
     [ 0,  2,  5,  0,  5,  9,  2, 11,  5,  4,  5,  8, 11,  8,  5],
     [ 9,  4,  5,  2, 11,  3, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 2,  5, 10,  3,  5,  2,  3,  4,  5,  3,  8,  4, 32, 32, 32],
     [ 5, 10,  2,  5,  2,  4,  4,  2,  0, 32, 32, 32, 32, 32, 32],
     [ 3, 10,  2,  3,  5, 10,  3,  8,  5,  4,  5,  8,  0,  1,  9],
     [ 5, 10,  2,  5,  2,  4,  1,  9,  2,  9,  4,  2, 32, 32, 32],
     [ 8,  4,  5,  8,  5,  3,  3,  5,  1, 32, 32, 32, 32, 32, 32],
     [ 0,  4,  5,  1,  0,  5, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 8,  4,  5,  8,  5,  3,  9,  0,  5,  0,  3,  5, 32, 32, 32],
     [ 9,  4,  5, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 4, 11,  7,  4,  9, 11,  9, 10, 11, 32, 32, 32, 32, 32, 32],
     [ 0,  8,  3,  4,  9,  7,  9, 11,  7,  9, 10, 11, 32, 32, 32],
     [ 1, 10, 11,  1, 11,  4,  1,  4,  0,  7,  4, 11, 32, 32, 32],
     [ 3,  1,  4,  3,  4,  8,  1, 10,  4,  7,  4, 11, 10, 11,  4],
     [ 4, 11,  7,  9, 11,  4,  9,  2, 11,  9,  1,  2, 32, 32, 32],
     [ 9,  7,  4,  9, 11,  7,  9,  1, 11,  2, 11,  1,  0,  8,  3],
     [11,  7,  4, 11,  4,  2,  2,  4,  0, 32, 32, 32, 32, 32, 32],
     [11,  7,  4, 11,  4,  2,  8,  3,  4,  3,  2,  4, 32, 32, 32],
     [ 2,  9, 10,  2,  7,  9,  2,  3,  7,  7,  4,  9, 32, 32, 32],
     [ 9, 10,  7,  9,  7,  4, 10,  2,  7,  8,  7,  0,  2,  0,  7],
     [ 3,  7, 10,  3, 10,  2,  7,  4, 10,  1, 10,  0,  4,  0, 10],
     [ 1, 10,  2,  8,  7,  4, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 4,  9,  1,  4,  1,  7,  7,  1,  3, 32, 32, 32, 32, 32, 32],
     [ 4,  9,  1,  4,  1,  7,  0,  8,  1,  8,  7,  1, 32, 32, 32],
     [ 4,  0,  3,  7,  4,  3, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 4,  8,  7, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 9, 10,  8, 10, 11,  8, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 3,  0,  9,  3,  9, 11, 11,  9, 10, 32, 32, 32, 32, 32, 32],
     [ 0,  1, 10,  0, 10,  8,  8, 10, 11, 32, 32, 32, 32, 32, 32],
     [ 3,  1, 10, 11,  3, 10, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 1,  2, 11,  1, 11,  9,  9, 11,  8, 32, 32, 32, 32, 32, 32],
     [ 3,  0,  9,  3,  9, 11,  1,  2,  9,  2, 11,  9, 32, 32, 32],
     [ 0,  2, 11,  8,  0, 11, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 3,  2, 11, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 2,  3,  8,  2,  8, 10, 10,  8,  9, 32, 32, 32, 32, 32, 32],
     [ 9, 10,  2,  0,  9,  2, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 2,  3,  8,  2,  8, 10,  0,  1,  8,  1, 10,  8, 32, 32, 32],
     [ 1, 10,  2, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 1,  3,  8,  9,  1,  8, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 0,  9,  1, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [ 0,  3,  8, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32],
     [32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32]]
    , dtype=np.uint8)

# pre-compute each row's length
tri_table_lens = np.array(
    [ 0,  3,  3,  6,  3,  6,  6,  9,  3,  6,  6,  9,  6,  9,  9,  6, 
      3,  6,  6,  9,  6,  9,  9, 12,  6,  9,  9, 12,  9, 12, 12,  9, 
      3,  6,  6,  9,  6,  9,  9, 12,  6,  9,  9, 12,  9, 12, 12,  9, 
      6,  9,  9,  6,  9, 12, 12,  9,  9, 12, 12,  9, 12, 15, 15,  6, 
      3,  6,  6,  9,  6,  9,  9, 12,  6,  9,  9, 12,  9, 12, 12,  9, 
      6,  9,  9, 12,  9, 12, 12, 15,  9, 12, 12, 15, 12, 15, 15, 12, 
      6,  9,  9, 12,  9, 12,  6,  9,  9, 12, 12, 15, 12, 15,  9,  6, 
      9, 12, 12,  9, 12, 15,  9,  6, 12, 15, 15, 12, 15,  6, 12,  3, 
      3,  6,  6,  9,  6,  9,  9, 12,  6,  9,  9, 12,  9, 12, 12,  9, 
      6,  9,  9, 12,  9, 12, 12, 15,  9,  6, 12,  9, 12,  9, 15,  6, 
      6,  9,  9, 12,  9, 12, 12, 15,  9, 12, 12, 15, 12, 15, 15, 12, 
      9, 12, 12,  9, 12, 15, 15, 12, 12,  9, 15,  6, 15, 12,  6,  3, 
      6,  9,  9, 12,  9, 12, 12, 15,  9, 12, 12, 15,  6,  9,  9,  6, 
      9, 12, 12, 15, 12, 15, 15,  6, 12,  9, 15, 12,  9,  6, 12,  3, 
      9, 12, 12, 15, 12, 15,  9, 12, 12, 15, 15,  6,  9, 12,  6,  3, 
      6,  9,  9,  6,  9, 12,  6,  3,  9,  6, 12,  3,  6,  3,  3,  0], 
    dtype=np.uint8)

# edge_vertex_offsets : np.ndarray of shape (12,3), dtype=np.float32
# = offset (v0+v1)/2 for each edge
edge_vertex_offsets = np.array(
    [[0.5, 0. , 0. ],
     [1. , 0.5, 0. ],
     [0.5, 1. , 0. ],
     [0. , 0.5, 0. ],
     [0.5, 0. , 1. ],
     [1. , 0.5, 1. ],
     [0.5, 1. , 1. ],
     [0. , 0.5, 1. ],
     [0. , 0. , 0.5],
     [1. , 0. , 0.5],
     [1. , 1. , 0.5],
     [0. , 1. , 0.5]], dtype=np.float32)

# Edge to vertex mapping for standard marching cubes
edge_to_vertices = np.array([
    [0, 1], [1, 2], [2, 3], [3, 0],  # bottom face
    [4, 5], [5, 6], [6, 7], [7, 4],  # top face
    [0, 4], [1, 5], [2, 6], [3, 7]   # vertical edges
], dtype=np.int32)

key_type = nb.types.UniTuple(nb.int32, 3)

@nb.njit(cache=True)
def marching_cubes_nb(volume: np.ndarray, threshold: float):
    verts = []
    faces = []
    vert_idx = nb.typed.Dict.empty(
        key_type=key_type,
        value_type=nb.int64
    )

    eps = 1e-5
    Z, Y, X = volume.shape
    max_int = np.iinfo(np.int32).max
    id_x, id_y, id_z = max_int//X, max_int//Y, max_int//Z
    
    # Cube corner coordinates
    cube_offsets = np.array([
        [0, 0, 0],
        [1, 0, 0],
        [1, 1, 0],
        [0, 1, 0],
        [0, 0, 1],
        [1, 0, 1],
        [1, 1, 1],
        [0, 1, 1],
    ], dtype=np.float32)
    
    cube_offset_sub = np.zeros((8, 8, 3), dtype=np.float32)
    for a in range(8):
        for b in range(8):
            cube_offset_sub[a, b] = cube_offsets[b] - cube_offsets[a]

    for z in range(Z-1):
        for y in range(Y-1):
            for x in range(X-1):

                # Cube corner values
                cube_vals = (
                    float(volume[z,   y,   x  ]),
                    float(volume[z,   y,   x+1]),
                    float(volume[z,   y+1, x+1]),
                    float(volume[z,   y+1, x  ]),
                    float(volume[z+1, y,   x  ]),
                    float(volume[z+1, y,   x+1]),
                    float(volume[z+1, y+1, x+1]),
                    float(volume[z+1, y+1, x  ]),
                )

                # Cube index
                ci = 0
                for i, val in enumerate(cube_vals):
                    if val >= threshold:
                        ci |= (1 << i)

                if ci == 0 or ci == 255:
                    continue  # no surface in this cube

                length = tri_table_lens[ci]
                for i in range(0, length, 3):
                    edges = tri_table[ci, i:(i + 3)]
                    tri = []
                    for edge in edges:
                        a, b = edge_to_vertices[edge]
                        v1, v2 = cube_vals[a], cube_vals[b]
                        if v1==v2:
                            t = 0.5
                        else:
                            t = (threshold - v1)/(v2 - v1)
                        t = eps if t<=eps else (1. - eps) if t>=(1. - eps) else t
                        px = x + cube_offsets[a, 0] + t*cube_offset_sub[a, b, 0]
                        py = y + cube_offsets[a, 1] + t*cube_offset_sub[a, b, 1]
                        pz = z + cube_offsets[a, 2] + t*cube_offset_sub[a, b, 2]
                        # Deduplicate vertices using integer keys
                        key = (np.int32(id_x*px), np.int32(id_y*py), np.int32(id_z*pz))
                        if key not in vert_idx:
                            vert_idx[key] = len(verts)
                            verts.append((px, py, pz))
                        tri.append(vert_idx[key])
                    faces.append(tri)

    return np.array(verts, dtype=np.float32), np.array(faces, dtype=np.int32)


def marching_cubes(volume: np.ndarray, threshold: float) -> io.Mesh:
    """
    Extract an isosurface from a 3D scalar field using the Marching Cubes algorithm 
    and return it as a `meshio.Mesh` object.

    This function calls `marching_cubes_nb`, a Numba-compiled routine that performs the core computations, 
    including vertex deduplication and triangle generation.

    Parameters
    ----------
    volume : np.ndarray
        3D scalar field array with shape (Z, Y, X). Values of any type comparable to `threshold` 
        can be processed without copying the data.
    threshold : float
        Iso-value used to extract the surface. Voxels with values >= `threshold` are considered inside.

    Returns
    -------
    io.Mesh
        Triangle mesh where `points` is an array of shape (N, 3) and `cells` contains a `"triangle"` 
        entry with indices into `points`.

    Notes
    -----
    - The function avoids memory-expensive copies of the input volume.
    - Vertex and face generation is delegated to a Numba-compiled routine.
    - To prevent the creation of zero-area triangles, vertex coordinates are slightly offset 
      (by 1e-5) from voxel centers.
    """
    verts, faces = marching_cubes_nb(volume, threshold)
    verts = verts[:, ::-1]
    stl_mc = io.Mesh(points=verts, cells={"triangle": faces})
    return stl_mc

# if __name__=='__main__':
#     from skimage.io import imread
#     volume = imread("/home-local/dbichet/Documents/These/code/VolVIC/exemples/metalic_BCC_traction/SlicesY-Lattice_BCC_traction_binned.tiff") # 
#     threshold = 21472.413169028445
#     stl_mc = marching_cubes(volume, threshold)
    
#     import pyvista as pv
#     mesh = pv.from_meshio(stl_mc)
#     mesh.plot(show_edges=True)

# %%
